<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
    <title>KIP 149: Unified System Contract Management Process</title>
    <meta property="og:title" content="KIP 149: Unified System Contract Management Process" />
    <meta
      name="description"
      content="Details on Kaia Improvement Proposal 149 (KIP 149): Unified System Contract Management Process"
    />
    <meta
      property="og:description"
      content="Details on Kaia Improvement Proposal 149 (KIP 149): Unified System Contract Management Process"
    />
    <meta name="twitter:description" content="Details on Kaia Improvement Proposal 149 (KIP 149): Unified System Contract Management Process" />
  
  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="http://localhost:4000/KIPs/kip-149" />
  <meta property="og:url" content="http://localhost:4000/KIPs/kip-149" />
  <meta property="og:site_name" content="Kaia Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@kaiachain" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "http://localhost:4000",
      "name": "Kaia Improvement Proposals",
      "description": "Kaia Improvement Proposals (KIPs) describe standards for the Kaia platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Kaia Improvement Proposals" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Kaia Improvement Proposals</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/all">All</a><a class="page-link" href="/core">Core</a><a class="page-link" href="/networking">Networking</a><a class="page-link" href="/storage">Storage</a><a class="page-link" href="/interface">Interface</a><a class="page-link" href="/token">KCT</a><a class="page-link" href="/sdk">SDK</a><a class="page-link" href="/application">Application</a><a class="page-link" href="/meta">Meta</a><a class="page-link" href="/informational">Informational</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="home">
  <h1 class="page-heading">
    KIP 149: Unified System Contract Management Process
    <a href="https://github.com/kaiachain/KIPS/blob/main/KIPs/kip-149.md"><svg role="img" aria-label="Source" xmlns="https://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><title>Source</title><path fill-rule="evenodd" d="M9.5 3L8 4.5 11.5 8 8 11.5 9.5 13 14 8 9.5 3zm-5 0L0 8l4.5 5L6 11.5 2.5 8 6 4.5 4.5 3z"/></svg></a>
  </h1>
  <table>
    <tr><th>Author</th><td><a href="https://github.com/hyeonLewis">Lewis</a>, <a href="https://github.com/ian0371">Ian</a>, <a href="https://github.com/blukat29">Ollie</a>, <a href="https://github.com/hyunsooda">Lake</a>, <a href="https://github.com/aidan-kwon">and Aidan</a></td></tr>
    
      <tr><th>Discussions-To</th><td><a href="https://github.com/klaytn/kips/issues/149">https://github.com/klaytn/kips/issues/149</a></td></tr>
    
    <tr><th>Status</th><td>Draft
    
    </td></tr>
    <tr><th>Type</th><td>Standards Track</td></tr>
    
      <tr><th>Category</th><td>Core</td></tr>
    
    <tr><th>Created</th><td>2023-09-20</td></tr>
    
    
    
    
    
  </table>

  <h2 id="simple-summary">Simple Summary</h2>

<p>A unified deployment and management process for system contracts.</p>

<h2 id="abstract">Abstract</h2>

<p>This standard defines a unified deployment and management process for system contracts. To effectively manage system contracts, it also introduces a Registry contract that manages all system contracts.</p>

<h2 id="motivation">Motivation</h2>

<p>Currently, Klaytn has multiple <a href="#definitions">system contracts</a>, but they are deployed and managed without any defined standards. For example, the <code class="language-plaintext highlighter-rouge">AddressBook</code> contract was deployed by a bytecode injection at the genesis block with a reserved address. In contrast, an EOA deployed <code class="language-plaintext highlighter-rouge">TreasuryRebalance</code>, and its address is set in the chain config. As more system contracts will be deployed in the future, it’s essential to have a standard way to deploy and manage system contracts.</p>

<h2 id="specification">Specification</h2>

<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL” in this document are to be interpreted as described in RFC 2119.</p>

<p>This standard defines the separation of data and logic contracts in system contracts, and every system contract should be developed and deployed under this standard. This method, often called the proxy pattern, allows the change of the logic contract while keeping the data, which can greatly reduce the cost of contract updates. Upgrading a logic contract will not affect the Registry since the Registry only holds the address of the proxy(data) contract. Delegating ownership of a proxy contract to a governance contract can solve the centralized and potential private key loss issues.</p>

<p>Between the popular proxy patterns <code class="language-plaintext highlighter-rouge">Transparent</code> and <code class="language-plaintext highlighter-rouge">UUPS</code>, all system contracts must be developed and validated based on the <a href="https://eips.ethereum.org/EIPS/eip-1822"><code class="language-plaintext highlighter-rouge">UUPS</code></a> proxy pattern.</p>

<h3 id="definitions">Definitions</h3>

<ul>
  <li>
    <p>System contract: A contract that is read by the Klaytn core protocol or directly affect the protocol. The currently deployed system contracts are as follows: <a href="https://github.com/klaytn/klaytn/blob/dev/contracts/contracts/system_contracts/consensus/AddressBook.sol"><strong>AddressBook</strong></a>, <a href="https://github.com/klaytn/klaytn/blob/dev/contracts/contracts/system_contracts/gov/GovParam.sol"><strong>GovParam</strong></a>, <strong>Voting</strong>(<a href="https://github.com/klaytn/kips/blob/main/KIPs/kip-81.md">KIP-81</a>), <strong>TreasuryRebalance</strong>(<a href="https://github.com/klaytn/kips/blob/main/KIPs/kip-103.md">KIP-103</a>)</p>
  </li>
  <li>
    <p>System contract upgrade: The process of updating an existing logic contract while maintaining a proxy contract. The upgraded logic contract must be compatible with the previous interface and its storage layout.</p>
  </li>
  <li>
    <p>System contract replacement: The deployment of a new system contract that is then registered to the Registry using the same name as its predecessor. The new contract effectively deprecates the previous system contract.</p>
  </li>
</ul>

<h3 id="smart-contracts-overview">Smart Contracts Overview</h3>

<p>The proposed smart contract will be implemented in Solidity and compatible with the Ethereum Virtual Machine (EVM).</p>

<p>The smart contract will have the following features:</p>

<ol>
  <li>
    <p>Registry</p>

    <ul>
      <li>
        <p>Register a new system contract with an activation block.</p>
      </li>
      <li>
        <p>Return the state of the system contracts.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Proxy</p>

    <ul>
      <li>
        <p>Delegate a call to logic contract.</p>
      </li>
      <li>
        <p>Upgrade a logic contract.</p>
      </li>
    </ul>
  </li>
</ol>

<h4 id="1-registry">1. Registry</h4>

<p>The registry must have data for system contracts at a specific block. It will be done by state injection, which injects data into the Registry directly using the <code class="language-plaintext highlighter-rouge">state.SetState</code>. A reference implementation is introduced in <a href="#implementation">Implementation</a>. Note that it only records system contracts developed based on KIP-149.</p>

<h4 id="interface-of-registry">Interface of Registry</h4>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pragma</span> <span class="n">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">abstract</span> <span class="k">contract</span> <span class="n">IRegistry</span> <span class="p">{</span>
    <span class="cm">/* ========== VARIABLES ========== */</span>
    <span class="c1">/// The following variables are baked in the interface because their storage layout matters in protocol consensus 
</span>    <span class="c1">/// when inject initial states (system contracts, owner) of the Registry.
</span>    <span class="c1">/// @dev Mapping of system contracts
</span>    <span class="k">mapping</span><span class="p">(</span><span class="kt">string</span> <span class="o">=&gt;</span> <span class="n">Record</span><span class="p">[])</span> <span class="k">public</span> <span class="n">records</span><span class="p">;</span>

    <span class="c1">/// @dev Array of system contract names
</span>    <span class="kt">string</span><span class="p">[]</span> <span class="k">public</span> <span class="n">names</span><span class="p">;</span>

    <span class="c1">/// @dev Owner of contract
</span>    <span class="kt">address</span> <span class="k">internal</span> <span class="n">_owner</span><span class="p">;</span>

    <span class="cm">/* ========== TYPES ========== */</span>
    <span class="c1">/// @dev Struct of system contracts
</span>    <span class="k">struct</span> <span class="n">Record</span> <span class="p">{</span>
        <span class="kt">address</span> <span class="n">addr</span><span class="p">;</span>
        <span class="kt">uint256</span> <span class="n">activation</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* ========== EVENTS ========== */</span>
    <span class="c1">/// @dev Emitted when the contract owner is updated by `transferOwnership`.
</span>    <span class="k">event</span> <span class="n">OwnershipTransferred</span><span class="p">(</span><span class="kt">address</span> <span class="k">indexed</span> <span class="n">previousOwner</span><span class="p">,</span> <span class="kt">address</span> <span class="k">indexed</span> <span class="n">newOwner</span><span class="p">);</span>
    
    <span class="c1">/// @dev Emitted when a new system contract is registered.
</span>    <span class="k">event</span> <span class="n">Registered</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">address</span> <span class="k">indexed</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint256</span> <span class="k">indexed</span> <span class="n">activation</span><span class="p">);</span>

    <span class="cm">/* ========== MUTATORS ========== */</span>
    <span class="c1">/// @dev Registers a new system contract.
</span>    <span class="k">function</span> <span class="n">register</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">,</span> <span class="kt">address</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">activation</span><span class="p">)</span> <span class="k">external</span> <span class="k">virtual</span><span class="p">;</span>
    
    <span class="c1">/// @dev Transfers ownership to newOwner.
</span>    <span class="k">function</span> <span class="n">transferOwnership</span><span class="p">(</span><span class="kt">address</span> <span class="n">newOwner</span><span class="p">)</span> <span class="k">external</span> <span class="k">virtual</span><span class="p">;</span>

    <span class="cm">/* ========== GETTERS ========== */</span>
    <span class="c1">/// @dev Returns an address for active system contracts registered as name if exists.
</span>    <span class="c1">///  It returns a zero address when there's no active system contract with name.
</span>    <span class="k">function</span> <span class="n">getActiveAddr</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">)</span> <span class="k">external</span> <span class="k">virtual</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span><span class="p">);</span>
  
    <span class="c1">/// @dev Returns all system contracts registered as name.
</span>    <span class="k">function</span> <span class="n">getAllRecords</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">)</span> <span class="k">external</span> <span class="k">virtual</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="n">Record</span><span class="p">[]</span> <span class="k">memory</span><span class="p">);</span>
    
    <span class="c1">/// @dev Returns all names of registered system contracts.
</span>    <span class="k">function</span> <span class="n">getAllNames</span><span class="p">()</span> <span class="k">external</span> <span class="k">virtual</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="k">memory</span><span class="p">);</span>
    
    <span class="c1">/// @dev Returns owner of contract.
</span>    <span class="k">function</span> <span class="n">owner</span><span class="p">()</span> <span class="k">external</span> <span class="k">virtual</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="methods">Methods</h4>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">register</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">,</span> <span class="kt">address</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">activation</span><span class="p">)</span>
</code></pre></div></div>

<p>Registers a new system contract. It will be activated at <code class="language-plaintext highlighter-rouge">activation</code>. It overwrites the predecessor if a predecessor system contract exists and is not yet active. Passing <code class="language-plaintext highlighter-rouge">addr == address(0)</code> is an implicit deprecation for the <code class="language-plaintext highlighter-rouge">name</code>, meaning the <code class="language-plaintext highlighter-rouge">name</code> will no longer be used.</p>

<p>The function validates the following requirements:</p>

<ul>
  <li>
    <p>The function caller MUST be an owner address.</p>
  </li>
  <li>
    <p>The function MUST revert if a <code class="language-plaintext highlighter-rouge">name</code> is an empty string.</p>
  </li>
  <li>
    <p>The function MUST revert if <code class="language-plaintext highlighter-rouge">activation &lt; block.number</code>.</p>
  </li>
</ul>

<p>The function emits a <code class="language-plaintext highlighter-rouge">Registered</code> event.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">getActiveAddr</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">)</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span><span class="p">)</span>
</code></pre></div></div>

<p>Returns the address of the active system contract with the <code class="language-plaintext highlighter-rouge">name</code>. It returns a zero address if there’s no registered system contract with the <code class="language-plaintext highlighter-rouge">name</code> or the <code class="language-plaintext highlighter-rouge">name</code> has been deprecated by registering a zero address.</p>

<h4 id="2-proxy">2. Proxy</h4>

<p>The implementation of the proxy contract will come from <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/v4.9.3/contracts/proxy/ERC1967/ERC1967Proxy.sol">OZ’s UUPS implementation</a>, which follows <a href="https://eips.ethereum.org/EIPS/eip-1967">EIP-1967</a> and <a href="https://eips.ethereum.org/EIPS/eip-1822">EIP-1822</a>.</p>

<h3 id="system-contracts-life-cycle">System Contracts Life Cycle</h3>

<p>The Registry contract manages system contracts based on the current block number. Its state will be managed implicitly, which means there’s no explicit state variable(e.g., enum State). It has three implicit states and cannot be reversed to the previous state:</p>

<ul>
  <li>
    <p>Registered: It has been registered but has not been activated yet.</p>
  </li>
  <li>
    <p>Active: The registered address isn’t a zero address and current block number exceeds its activation. Also, no active successor system contract exists.</p>
  </li>
  <li>
    <p>Deprecated: It’s registered with a zero address or there’s an active successor system contract.</p>
  </li>
</ul>

<p><img src="/assets/kip-149/LifeCycle.png" alt="" /></p>

<h4 id="upgrade-system-contracts">Upgrade System Contracts</h4>

<p>When upgrading a system contract, its logic contract will be changed by governance proposal. The Registry will not be updated since it only manages the address of the proxy contract.</p>

<p><img src="/assets/kip-149/UpgradeProcess.png" alt="" /></p>

<h4 id="replace-system-contracts">Replace System Contracts</h4>

<p>If current system contract updates can’t be done by upgrading the logic contract, it must be replaced with the newly deployed system contract. The predecessor doesn’t need to be explicitly deprecated since a new system contract will implicitly replace and deprecate it. The replacement process is the same as the initial registration for the system contract except for having a predecessor.</p>

<p><img src="/assets/kip-149/ReplacementProcess.png" alt="" /></p>

<h3 id="core-logic-overview">Core Logic Overview</h3>

<p>After a target block number, a Klaytn node should read all the active addresses of system contracts through the Registry. A Klaytn node deploys the Registry at the configured block number at the reserved address by bytecode injection. Note that the Registry will be replaced by bytecode injection if necessary since it’s deployed by bytecode injection.</p>

<h4 id="chain-configuration">Chain Configuration</h4>

<p>In the Chain Config, the following fields are newly introduced. All node operators in a network must update <code class="language-plaintext highlighter-rouge">genesis.json</code> configuration with the same value. The configuration values for Baobab and Cypress networks are hard-coded on the client source code.</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">RegistryAddress</code>: the reserved address for the Registry contract, which is <code class="language-plaintext highlighter-rouge">0x0000000000000000000000000000000000000401</code>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Kip149CompatibleBlock</code>: the target block number that the Registry will be deployed.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">RegistryInit</code>: the initial data config for the Registry. Tye type of this field is defined as <code class="language-plaintext highlighter-rouge">RegistryConfig</code> as shown below. It is used when injecting the initial state after deploying the Registry contract.</p>
  </li>
</ul>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// In klaytn/params/config.go</span>
<span class="k">type</span> <span class="n">RegistryConfig</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Records</span>  <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="n">common</span><span class="o">.</span><span class="n">Address</span> <span class="c">// Map for system contracts</span>
	<span class="n">Owner</span>   <span class="n">common</span><span class="o">.</span><span class="n">Address</span> <span class="c">// Address for initial owner of Registry</span>
<span class="p">}</span>

<span class="k">var</span> <span class="n">ChainConfig</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ChainConfig</span><span class="p">{</span>
    <span class="o">...</span>
    <span class="n">Kip149CompatibleBlock</span><span class="o">:</span> <span class="n">TBD</span><span class="p">,</span>
    <span class="c">// RegistryInit will be used when injecting initial state for the Registry</span>
    <span class="c">// Note that the registry only records the system contracts based on the KIP-149, which is currently only KIP-113</span>
    <span class="c">// The activation block deployed by state injection will be 0</span>
    <span class="n">RegistryInit</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">RegistryConfig</span><span class="p">{</span>
		<span class="n">Records</span><span class="o">:</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="n">common</span><span class="o">.</span><span class="n">Address</span><span class="p">{</span>
			<span class="s">"KIP113"</span><span class="o">:</span> <span class="n">Kip113Address</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="n">Owner</span><span class="o">:</span> <span class="n">OwnerAddress</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="execution">Execution</h4>

<p>The Registry deployment is executed at the <code class="language-plaintext highlighter-rouge">engine.Finalize</code> function, which means the end of the block generation. It reads the reserved address and runtime bytecode and deploys the Registry by the bytecode injection. Also, it injects the initial state provided by <code class="language-plaintext highlighter-rouge">RegistryConfig</code> for the Registry here. When <code class="language-plaintext highlighter-rouge">kip149CompatibleBlock == 0</code>, the Registry will be allocated at the genesis block.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">chain</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span><span class="o">.</span><span class="n">IsKIP149ForkBlock</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="p">{</span>
	<span class="c">// Inject the bytecode and states for the Registry</span>
	<span class="n">err</span> <span class="o">:=</span> <span class="n">registry</span><span class="o">.</span><span class="n">InstallRegistry</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">chain</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span><span class="o">.</span><span class="n">RegistryInit</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">logger</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s">"failed to set the registry contract code"</span><span class="p">,</span> <span class="s">"err"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">logger</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"successfully set the registry contract code"</span><span class="p">,</span> <span class="s">"block"</span><span class="p">,</span> <span class="n">header</span><span class="o">.</span><span class="n">Number</span><span class="o">.</span><span class="n">Uint64</span><span class="p">())</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="resolver">Resolver</h4>

<p>A Klaytn node will have a resolver to read the active addresses of system contracts from the Registry. But the system contracts deployed by state injection (e.g., <code class="language-plaintext highlighter-rouge">KIP113</code>) will be directly read from <code class="language-plaintext highlighter-rouge">chain.Config().RegistryInit</code> at the <code class="language-plaintext highlighter-rouge">Kip149CompatibleBlock</code> since the Registry will be deployed in the <code class="language-plaintext highlighter-rouge">engine.Finalize</code> function, which is the last part of the block generation. In other words, the resolver will be used starting in the <code class="language-plaintext highlighter-rouge">Kip149CompatibleBlock + 1</code>.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Note that it will be activated in the next of KIP-149 fork block</span>
<span class="k">func</span> <span class="n">ReadActiveAddressFromRegistry</span><span class="p">(</span><span class="n">backend</span> <span class="n">bind</span><span class="o">.</span><span class="n">ContractCaller</span><span class="p">,</span> <span class="n">name</span> <span class="kt">string</span><span class="p">,</span> <span class="n">num</span> <span class="o">*</span><span class="n">big</span><span class="o">.</span><span class="n">Int</span><span class="p">)</span> <span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">Address</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">code</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">backend</span><span class="o">.</span><span class="n">CodeAt</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Background</span><span class="p">(),</span> <span class="n">RegistryAddr</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">common</span><span class="o">.</span><span class="n">Address</span><span class="p">{},</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">common</span><span class="o">.</span><span class="n">Address</span><span class="p">{},</span> <span class="n">ErrRegistryNotInstalled</span>
	<span class="p">}</span>

	<span class="n">caller</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">contracts</span><span class="o">.</span><span class="n">NewRegistryCaller</span><span class="p">(</span><span class="n">RegistryAddr</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">common</span><span class="o">.</span><span class="n">Address</span><span class="p">{},</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="n">opts</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">bind</span><span class="o">.</span><span class="n">CallOpts</span><span class="p">{</span><span class="n">BlockNumber</span><span class="o">:</span> <span class="n">num</span><span class="p">}</span>
	<span class="k">return</span> <span class="n">caller</span><span class="o">.</span><span class="n">GetActiveAddr</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="json-rpc-apis">JSON-RPC APIs</h4>

<p>The following JSON-RPC methods for the Klaytn node should be added to provide the records of registered system contracts.</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">klay_getActiveAddressFromRegistry</code></p>

    <ul>
      <li>Parameters:
        <ul>
          <li><code class="language-plaintext highlighter-rouge">name</code>: the name of the system contract in string.</li>
          <li><code class="language-plaintext highlighter-rouge">number</code>: (optional) integer or hexadecimal block number, or the string “pending” or “latest”.</li>
        </ul>
      </li>
      <li>Description: Returns the active address of the system contract registered as <code class="language-plaintext highlighter-rouge">name</code> if exists.</li>
      <li>Return: The address of the active system contract.</li>
      <li>Example
        <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">Request</span><span class="w">
  </span><span class="err">curl</span><span class="w"> </span><span class="err">-X</span><span class="w"> </span><span class="err">POST</span><span class="w"> </span><span class="err">-H</span><span class="w"> </span><span class="s2">"Content-Type: application/json"</span><span class="w"> </span><span class="err">--data</span><span class="w"> </span><span class="err">'</span><span class="p">{</span><span class="nl">"jsonrpc"</span><span class="p">:</span><span class="s2">"2.0"</span><span class="p">,</span><span class="w"> </span><span class="nl">"method"</span><span class="p">:</span><span class="s2">"klay_getActiveAddressFromRegistry"</span><span class="p">,</span><span class="w"> </span><span class="nl">"params"</span><span class="p">:[</span><span class="s2">"KIP113"</span><span class="p">,</span><span class="w"> </span><span class="s2">"latest"</span><span class="p">],</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">'</span><span class="w"> </span><span class="err">http://localhost:</span><span class="mi">8551</span><span class="w">
  </span><span class="err">//</span><span class="w"> </span><span class="err">Response</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nl">"jsonrpc"</span><span class="p">:</span><span class="s2">"2.0"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nl">"result"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0x0000000000000000000000000000000000000402"</span><span class="w">
  </span><span class="p">}</span><span class="w">

  </span><span class="err">//</span><span class="w"> </span><span class="err">Request</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">no</span><span class="w"> </span><span class="err">active</span><span class="w"> </span><span class="err">system</span><span class="w"> </span><span class="err">contract</span><span class="w">
  </span><span class="err">curl</span><span class="w"> </span><span class="err">-X</span><span class="w"> </span><span class="err">POST</span><span class="w"> </span><span class="err">-H</span><span class="w"> </span><span class="s2">"Content-Type: application/json"</span><span class="w"> </span><span class="err">--data</span><span class="w"> </span><span class="err">'</span><span class="p">{</span><span class="nl">"jsonrpc"</span><span class="p">:</span><span class="s2">"2.0"</span><span class="p">,</span><span class="w"> </span><span class="nl">"method"</span><span class="p">:</span><span class="s2">"klay_getActiveAddressFromRegistry"</span><span class="p">,</span><span class="w"> </span><span class="nl">"params"</span><span class="p">:[</span><span class="s2">"KIP114"</span><span class="p">,</span><span class="w"> </span><span class="s2">"latest"</span><span class="p">],</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">'</span><span class="w"> </span><span class="err">http://localhost:</span><span class="mi">8551</span><span class="w">
  </span><span class="err">//</span><span class="w"> </span><span class="err">Response</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nl">"jsonrpc"</span><span class="p">:</span><span class="s2">"2.0"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nl">"error"</span><span class="p">:{</span><span class="w">
          </span><span class="nl">"code"</span><span class="p">:</span><span class="mi">-32000</span><span class="p">,</span><span class="w">
          </span><span class="nl">"message"</span><span class="p">:</span><span class="s2">"no active address for KIP114"</span><span class="w">
      </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">klay_getAllRecordsFromRegistry</code></p>

    <ul>
      <li>Parameters:
        <ul>
          <li><code class="language-plaintext highlighter-rouge">name</code>: the name of the system contract in string.</li>
          <li><code class="language-plaintext highlighter-rouge">number</code>: (optional) integer or hexadecimal block number, or the string “pending” or “latest”.</li>
        </ul>
      </li>
      <li>Description: Returns all records of the system contract registered as <code class="language-plaintext highlighter-rouge">name</code> if it has been registered.</li>
      <li>Returns:
        <ul>
          <li><code class="language-plaintext highlighter-rouge">Record[]</code>: An array of the records of the system contract.
            <ul>
              <li><code class="language-plaintext highlighter-rouge">Record</code>: A struct of the record with the following fields.
                <ul>
                  <li><code class="language-plaintext highlighter-rouge">addr</code>: The address of the system contract.</li>
                  <li><code class="language-plaintext highlighter-rouge">activation</code>: The block number when the system contract is activated.</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>Example
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  // Request
  curl -X POST -H "Content-Type: application/json" --data '{"jsonrpc":"2.0", "method":"klay_getAllRecordsFromRegistry", "params":["KIP113", "latest"],"id":1}' http://localhost:8551
  // Response
  {
      "jsonrpc":"2.0",
      "id":1,
      "result":[
          {
              "addr":"0x0000000000000000000000000000000000000402",
              "activation":0
          }
      ]
  }

  // request - no records
  curl -X POST -H "Content-Type: application/json" --data '{"jsonrpc":"2.0", "method":"klay_getAllRecordsFromRegistry", "params":["KIP114", "latest"],"id":1}' http://localhost:8551
  // Response
  {
      "jsonrpc":"2.0",
      "id":1,
      "error":{
          "code":-32000,
          "message":"KIP114 has not been registered"
      }
  }
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ol>

<h2 id="rationale">Rationale</h2>

<h3 id="bytecode-injection-for-registry-deployment">Bytecode Injection for Registry Deployment</h3>

<p>In the future, all system contracts will be registered in the Registry, and a Klaytn node will read the active addresses of system contracts from the Registry. Not only for a Klaytn node but also for other ecosystem participants who will use the registry to read the system contracts they need, meaning the registry should be registered at an easily accessible reserved address.</p>

<h3 id="delegating-ownership-of-registry-and-system-contracts-to-governance">Delegating Ownership of Registry and System Contracts to Governance</h3>

<p>The Registry holds all system contracts for Klaytn, affecting the protocol directly. This means its registration and deprecation process must be very careful and not centralized. The same goes for the system contract. As mentioned in <a href="#specification">specification</a>, making the EOA the owner of system contracts can cause centralization and potential private key loss issues. By delegating ownership of the Registry and system contracts to Governance, all registry and system contract changes will only be applied after full discussion and consensus of the GCs and Validators. Validators have the right to accept or reject the proposal depending on whether or not the hard fork proceeds.</p>

<h3 id="state-injection-for-system-contracts">State Injection for System Contracts</h3>

<p>The Registry must hold data for system contracts at a specific block. To handle this, there are three main approaches:</p>

<ol>
  <li>
    <p>Send multiple register transactions after deploying the Registry.</p>
  </li>
  <li>
    <p>Use a fallback logic in the getter to return the state of system contracts.</p>
  </li>
  <li>
    <p>Use state injection, which injects state for system contracts by the <code class="language-plaintext highlighter-rouge">state.SetState</code>.</p>
  </li>
</ol>

<p>The first approach seems straightforward. However, the Registry will be set in the <code class="language-plaintext highlighter-rouge">engine.Finalize</code>, which is the last part of the block generation. It means the transaction cannot be processed in the same block and must be entered in the first order of the next block. This requires additional implementation and can’t be applied when <code class="language-plaintext highlighter-rouge">KIP149CompatibleBlock == 0</code>. In the second approach, the Registry contract should have different codes by the network, requiring direct code modification in the getter(e.g., add/remove hard-coded system contracts and modify if-else statements). It can cause potential security vulnerabilities and increase costs for getter calls permanently. On the other hand, the last approach is much safer because it’s more structured and doesn’t require modifying any code. It can also set the necessary configuration without working with the additional contract’s constructor. Note that the state injection for system contracts will follow the <a href="https://docs.soliditylang.org/en/v0.8.20/internals/layout_in_storage.html">solidity layout rule</a>.</p>

<h3 id="separate-data-and-logic-contract">Separate Data and Logic Contract</h3>

<p>This proxy pattern simplifies the process of system contract update because the existing data can be used even if the logic contract is changed. The main issue of the proxy pattern is the centralization and potential private key loss. But delegating ownership to upgrade a logic contract to Governance can solve those problems. Choosing <code class="language-plaintext highlighter-rouge">UUPS</code> as the proxy pattern is because it’s lighter and more secure than <code class="language-plaintext highlighter-rouge">Transparent</code> proxy pattern. For example, <code class="language-plaintext highlighter-rouge">Transparent</code> requires additional logic to prevent <code class="language-plaintext highlighter-rouge">proxy selector clashing</code>. However, with <code class="language-plaintext highlighter-rouge">UUPS</code>, the proxy functionality is managed in a logic contract, eliminating the need for additional work. For more details, please refer to <a href="https://docs.openzeppelin.com/contracts/4.x/api/proxy#transparent-vs-uups">OZ’s article</a></p>

<h2 id="backward-compatibility">Backward Compatibility</h2>

<h3 id="deployed-system-contracts">Deployed System Contracts</h3>

<p>The existing system contracts will not be registered in the Registry, since they are not developed based on KIP-149. They will be used in a Klaytn node same way as before.</p>

<h2 id="implementation">Implementation</h2>

<ul>
  <li>A reference implementation for the Registry contract: <a href="https://github.com/klaytn/klaytn/blob/dev/contracts/contracts/system_contracts/kip149/Registry.sol">Implementation</a></li>
  <li>A reference implementation for core logic: <a href="https://github.com/klaytn/klaytn/blob/dev/blockchain/system/registry.go">Implementation</a></li>
</ul>

<h2 id="references">References</h2>

<ul>
  <li>
    <p>Binance Smart Chain: https://github.com/bnb-chain/bsc/tree/master/core/systemcontracts</p>
  </li>
  <li>
    <p>Celo: https://docs.celo.org/community/release-process/smart-contracts</p>
  </li>
</ul>

<h2 id="copyright">Copyright</h2>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.2.3/mermaid.min.js" integrity="sha512-M4zmdILgXOwrBEVfpVqdO/jC3BJZQzlXHeu967v41/QoT60sESWSLbi7YwntTbYC0ZjewfTbvXO8iKj7amvQow==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  mermaid.initialize({
    startOnLoad: true,
  });
  mermaid.run({
    querySelector: '.language-mermaid', // markdown 'mermaid' language code blocks
  });
</script>


</div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Kaia Improvement Proposals</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Kaia Improvement Proposals</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/kaiachain/KIPs"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">kaiachain/KIPs</span></a></li><li><a href="https://twitter.com/kaiachain"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">kaiachain</span></a></li><li><a href="https://www.facebook.com/kaiachain"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#facebook"></use></svg> <span class="username">kaiachain</span></a></li><li><a href="https://medium.com/kaiachain"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#medium"></use></svg> <span class="username">kaiachain</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Kaia Improvement Proposals (KIPs) describe standards for the Kaia platform, including core protocol specifications, client APIs, and contract standards.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

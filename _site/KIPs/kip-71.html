<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
    <title>KIP 71: Dynamic Gas Fee Pricing Mechanism</title>
    <meta property="og:title" content="KIP 71: Dynamic Gas Fee Pricing Mechanism" />
    <meta
      name="description"
      content="Details on Kaia Improvement Proposal 71 (KIP 71): Dynamic Gas Fee Pricing Mechanism"
    />
    <meta
      property="og:description"
      content="Details on Kaia Improvement Proposal 71 (KIP 71): Dynamic Gas Fee Pricing Mechanism"
    />
    <meta name="twitter:description" content="Details on Kaia Improvement Proposal 71 (KIP 71): Dynamic Gas Fee Pricing Mechanism" />
  
  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="http://localhost:4000/KIPs/kip-71" />
  <meta property="og:url" content="http://localhost:4000/KIPs/kip-71" />
  <meta property="og:site_name" content="Kaia Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@kaiachain" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "http://localhost:4000",
      "name": "Kaia Improvement Proposals",
      "description": "Kaia Improvement Proposals (KIPs) describe standards for the Kaia platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Kaia Improvement Proposals" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Kaia Improvement Proposals</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/all">All</a><a class="page-link" href="/core">Core</a><a class="page-link" href="/networking">Networking</a><a class="page-link" href="/storage">Storage</a><a class="page-link" href="/interface">Interface</a><a class="page-link" href="/token">KCT</a><a class="page-link" href="/sdk">SDK</a><a class="page-link" href="/application">Application</a><a class="page-link" href="/meta">Meta</a><a class="page-link" href="/informational">Informational</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="home">
  <h1 class="page-heading">
    KIP 71: Dynamic Gas Fee Pricing Mechanism
    <a href="https://github.com/kaiachain/KIPS/blob/main/KIPs/kip-71.md"><svg role="img" aria-label="Source" xmlns="https://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><title>Source</title><path fill-rule="evenodd" d="M9.5 3L8 4.5 11.5 8 8 11.5 9.5 13 14 8 9.5 3zm-5 0L0 8l4.5 5L6 11.5 2.5 8 6 4.5 4.5 3z"/></svg></a>
  </h1>
  <table>
    <tr><th>Author</th><td><a href="mailto:jared.fi@krustuniverse.com">Woojin Lee (jared)</a>, <a href="mailto:colin.klaytn@krustuniverse.com">Junghyun Colin Kim</a></td></tr>
    
      <tr><th>Discussions-To</th><td><a href="https://forum.klaytn.com/t/en-new-transaction-fee-mechanism-dynamic-gas-price-proposal/4844">https://forum.klaytn.com/t/en-new-transaction-fee-mechanism-dynamic-gas-price-proposal/4844</a></td></tr>
    
    <tr><th>Status</th><td>Final
    
    </td></tr>
    <tr><th>Type</th><td>Standards Track</td></tr>
    
      <tr><th>Category</th><td>Core</td></tr>
    
    <tr><th>Created</th><td>2022-04-14</td></tr>
    
    
    
    
    
  </table>

  <!--You can leave these HTML comments in your merged KIP and delete the visible duplicate text guides, they will not appear and may be helpful to refer to if you edit it again. This is the suggested template for new KIPs. Note that a KIP number will be assigned by an editor. When opening a pull request to submit your KIP, please use an abbreviated title in the filename, `kip-draft_title_abbrev.md`. The title should be 44 characters or less.-->

<h2 id="simple-summary">Simple Summary</h2>
<!--"If you can't explain it simply, you don't understand it well enough." Provide a simplified and layman-accessible explanation of the KIP.-->
<p>A dynamic gas fee pricing mechanism based on network usage, that includes fixed-per-block network fee that is partially burned.</p>

<h2 id="abstract">Abstract</h2>
<!--A short (~200 word) description of the technical issue being addressed.-->
<p>There is a base fee per gas in protocol, which can move up or down for each block according to a formula which is a function of the gas used in the parent block and the gas target. The algorithm results in the base fee per gas increasing when the gas used in the previous block is above the gas target, and decreasing when the gas used in the previous block is below the gas target. It repeats until base fee reaches the lower bound fee or the upper bound fee. The base fee per gas is partially burned. Transactions specify the maximum fee per gas they are willing to pay in total. The transaction will always pay the base fee per gas of the block it was included in.</p>

<h2 id="motivation">Motivation</h2>
<!--The motivation is critical for KIPs that want to change the Klaytn protocol. It should clearly explain why the existing protocol specification is inadequate to address the problem that the KIP solves. KIP submissions without sufficient motivation may be rejected outright.-->

<p>Klaytn has been following a policy of “fixed gas price“, with the gas price fixed at a certain level (e.g. 25 ston and 750 ston). This approach was adopted in the initial phase because it allows users to easily send transactions without having to predict the gas fee, while minimizing the volatility of transaction fees. But in the periods leading up to the gas price increase, we have seen a lot of transaction bursts on Klaytn with the following problems:</p>

<ul>
  <li><strong>Delay of transaction execution</strong> : A large number of transactions were being generated at the same time, leading to increased process time for users. The fundamental cause to this was the sudden surge in transactions. But there were cases of thousands of transactions being fired to process a certain transaction. And the reason behind this repeated phenomenon was the absence of an algorithm that prioritizes Klaytn transactions as well as of an appropriate gas price policy.</li>
  <li><strong>Storage overload</strong> : The aforementioned a large number of transactions are created mostly by bots, and are mostly reverted and useless transactions. These transactions strain the Klaytn storage in the long-term, which can hinder Klaytn from providing quick transaction finality and stable network.</li>
  <li><strong>Inefficient resource allocation due to difficulty in rational price determination</strong> : Gas price should neither be too high or too low. A too low gas price increases vulnerability to DoS (denial-of-service) attacks and transaction delay for users. When it’s too high, the transaction cost is going to prevent users from using the network unreservedly. With the current fixed gas price policy, however, it is difficult to determine which price is appropriate, since the congestion status of the Klaytn network is constantly changing.</li>
  <li><strong>Inability to respond quickly and flexibly</strong> : Gas price needs to go up during transaction spikes and go down when the network is not congested. But under the current fixed gas price scheme, it is not easy to analyze and change the gas price based on the network congestion situation.</li>
</ul>

<p>A burn mechanism is needed to be introduced on Klaytn while solving the above problems, in order to link the growth of the ecosystem with KLAY value.</p>

<p>(This proposal only deals with dynamic fee policy, and a FIFO (First In First Out) transaction priority algorithm is already implemented. See https://github.com/klaytn/klaytn/pull/1282 and https://github.com/klaytn/klaytn/pull/1309)</p>

<h2 id="specification">Specification</h2>
<p>This specification derived heavily from Ethereum’s <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1559.md">ERC-1559</a> written by Vitalik Buterin (@vbuterin), Eric Conner (@econoar), Rick Dudley (@AFDudley), Matthew Slipper (@mslipper), Ian Norden (@i-norden), and Abdelhamid Bakhta (@abdelhamidbakhta).</p>

<p>Transactions under a dynamic gas fee policy consist of <code class="language-plaintext highlighter-rouge">base_fee_per_gas</code>, which are dynamically controlled according to the network congestion status. Network congestion is measured by <code class="language-plaintext highlighter-rouge">gas_used</code> which is the gas usage by blocks created on Klaytn. <code class="language-plaintext highlighter-rouge">base_fee_per_gas</code> changes every block.</p>

<p>When a consensus node creates a block, if the <code class="language-plaintext highlighter-rouge">gas_used</code> of the parent block exceeds <code class="language-plaintext highlighter-rouge">gas_target</code>, <code class="language-plaintext highlighter-rouge">base_fee_per_gas</code> would go up. On the other hand, if the <code class="language-plaintext highlighter-rouge">gas_used</code> is lower than <code class="language-plaintext highlighter-rouge">gas_target</code>, the <code class="language-plaintext highlighter-rouge">base_fee_per_gas</code> would be reduced. This process would be repeated until the <code class="language-plaintext highlighter-rouge">base_fee_per_gas</code> doesn’t exceed <code class="language-plaintext highlighter-rouge">lower_bound</code> or <code class="language-plaintext highlighter-rouge">upper_bound</code>. The block proposer would receive a part of the fee of transactions included in the block, and the rest would be burned.</p>

<p>The below shows pseudo code of this proposal.
<em>Note: // is integer division, round down.</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">asyncio.windows_events</span> <span class="kn">import</span> <span class="n">NULL</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Literal</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>


<span class="c1"># Since Klaytn has multiple transaction types,
# only 3 transaction types are defined here for sake of simplicity.
</span><span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">TxTypeLegacyTransaction</span><span class="p">:</span>
	<span class="n">value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">to</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="nb">input</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">()</span>
	<span class="n">v</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">r</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">nonce</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">gas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">gas_price</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

<span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">TxTypeFeeDelegatedSmartContractExecution</span><span class="p">:</span>
	<span class="nb">type</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mh">0x09</span>
	<span class="n">nonce</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">gas_price</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">gas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">to</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="k">from</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="nb">input</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">()</span>
	<span class="n">tx_signatures</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
	<span class="n">fee_payer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span> 
	<span class="n">fee_payer_signatures</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">TxTypeFeeDelegatedSmartContractExecutionWithRatio</span><span class="p">:</span>
	<span class="nb">type</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mh">0x32</span>
	<span class="n">nonce</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">gas_price</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">gas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">to</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="k">from</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="nb">input</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">()</span>
	<span class="n">fee_ratio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
	<span class="n">tx_signatures</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
	<span class="n">fee_payer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span> 
	<span class="n">fee_payer_signatures</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>


<span class="c1"># In Klaytn, Ethereum transaction types are supported by adding EthereumTxTypeEnvelope(0x78).
# RawTransaction : EthereumTxTypeEnvelope || EthereumTransactionType || TransactionPayload
# (|| is the byte/byte-array concatenation operator.)
# In this proposal, those concatenation is intentionally ommited for simplification.
</span>
<span class="c1"># Transaction2930 in Ethereum. 
</span><span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">TxTypeEthereumAccessList</span><span class="p">:</span>
	<span class="nb">type</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mh">0x7801</span>
	<span class="n">chain_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">nonce</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">gas_price</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">gas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">to</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">()</span>
	<span class="n">access_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
	<span class="n">v</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">r</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># Transaction1559 in Ethereum.
</span><span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">TxTypeEthereumDynamicFee</span><span class="p">:</span>
	<span class="nb">type</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mh">0x7802</span>
	<span class="n">chain_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">nonce</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">gas_tip_cap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">gas_fee_cap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">gas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">to</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">()</span>
	<span class="n">access_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
	<span class="n">v</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">r</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>


<span class="n">EthereumTransactions</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">TxTypeEthereumDynamicFee</span><span class="p">,</span> <span class="n">TxTypeEthereumAccessList</span><span class="p">]</span>

<span class="n">Transaction</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">TxTypeLegacyTransaction</span><span class="p">,</span> <span class="n">TxTypeFeeDelegatedSmartContractExecution</span><span class="p">,</span> <span class="n">TxTypeFeeDelegatedSmartContractExecutionWithRatio</span><span class="p">,</span> <span class="n">EthereumTransactions</span><span class="p">]</span>

<span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">NormalizedTransaction</span><span class="p">:</span>
	<span class="n">signer_address</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">signer_nonce</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">max_fee_per_gas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">gas_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">to</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">()</span>
	<span class="n">fee_payer_address</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">fee_ratio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>

<span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">Block</span><span class="p">:</span>
	<span class="nb">hash</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">parent_hash</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">base_fee_per_gas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">block_score</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">extra_data</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">()</span>
	<span class="n">gas_used</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span> 
	<span class="n">governance_data</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">()</span>
	<span class="n">logs_bloom</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">transaction_receipt_root</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">reward</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">state_root</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">timestamp</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">timestamp_FoS</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">transaction_root</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">nonce</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">committee</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
	<span class="n">proposer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span> 
	<span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span> 


<span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">Account</span><span class="p">:</span>
	<span class="nb">type</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">nonce</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">humanReadable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span> 
	<span class="n">address</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">key</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span> 
	<span class="n">balance</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">storage_root</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">code_hash</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">code_format</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">vm_version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">INITIAL_FORK_BLOCK_NUMBER</span> <span class="o">=</span> <span class="mi">107806544</span> <span class="c1"># TBD
</span><span class="n">BASE_FEE_DELTA_REDUCING_DENOMINATOR</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1"># To set max basefee change at 5% per block. Can be changed later by governance.
</span><span class="n">LOWER_BOUND_BASE_FEE</span> <span class="o">=</span> <span class="mi">25000000000</span> <span class="c1"># 25 ston, can be changed later by governance.
</span><span class="n">UPPER_BOUND_BASE_FEE</span> <span class="o">=</span> <span class="mi">750000000000</span> <span class="c1"># 750 ston, can be changed later by governance.
</span><span class="n">GAS_TARGET</span> <span class="o">=</span> <span class="mi">30000000</span> 
<span class="n">MAX_BLOCK_GAS_USED_FOR_BASE_FEE</span> <span class="o">=</span> <span class="mi">60000000</span> <span class="c1"># implicit block gas limit to enforce the max basefee change rate
</span><span class="n">BURN_RATIO</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># cannot be changed by governance.
</span><span class="n">CN_DISTRIBUTION_RATIO</span> <span class="o">=</span> <span class="mf">0.34</span> <span class="c1"># set by governance
</span><span class="n">KGF_DISTRIBUTION_RATIO</span> <span class="o">=</span> <span class="mf">0.54</span> <span class="c1"># set by governance
</span><span class="n">KIR_DISTRIBUTION_RATIO</span> <span class="o">=</span> <span class="mf">0.12</span> <span class="c1"># set by governance
</span>
<span class="k">class</span> <span class="nc">World</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
	<span class="k">def</span> <span class="nf">validate_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">Block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>

		<span class="n">parent_base_fee_per_gas</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">parent</span><span class="p">(</span><span class="n">block</span><span class="p">).</span><span class="n">base_fee_per_gas</span>
		<span class="n">transactions</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">transactions</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
		<span class="n">parent_gas_used</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">parent</span><span class="p">(</span><span class="n">block</span><span class="p">).</span><span class="n">gas_used</span>

		<span class="n">lower_bound_base_fee</span> <span class="o">=</span> <span class="n">LOWER_BOUND_BASE_FEE</span>
		<span class="n">upper_bound_base_fee</span> <span class="o">=</span> <span class="n">UPPER_BOUND_BASE_FEE</span>

		<span class="c1"># if LOWER_BOUND_BASE_FEE is not a even number, make it even by adding 1
</span>		<span class="k">if</span> <span class="n">lower_bound_base_fee</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">:</span>
			<span class="n">lower_bound_base_fee</span> <span class="o">+=</span> <span class="mi">1</span>

		<span class="c1"># if UPPER_BOUND_BASE_FEE ix not a even number, make it even by subtracting 1
</span>		<span class="k">if</span> <span class="n">upper_bound_base_fee</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">:</span>
			<span class="n">upper_bound_base_fee</span> <span class="o">-=</span> <span class="mi">1</span>

		<span class="k">if</span> <span class="n">parent_gas_used</span> <span class="o">&gt;</span> <span class="n">MAX_BLOCK_GAS_USED_FOR_BASE_FEE</span><span class="p">:</span>
			<span class="n">parent_gas_used</span> <span class="o">=</span> <span class="n">MAX_BLOCK_GAS_USED_FOR_BASE_FEE</span>

		<span class="c1"># check if the base fee is correct
</span>		<span class="k">if</span> <span class="n">INITIAL_FORK_BLOCK_NUMBER</span> <span class="o">==</span> <span class="n">block</span><span class="p">.</span><span class="n">number</span><span class="p">:</span>
			<span class="n">expected_base_fee_per_gas</span> <span class="o">=</span> <span class="n">lower_bound_base_fee</span>

		<span class="k">elif</span> <span class="n">parent_gas_used</span> <span class="o">==</span> <span class="n">GAS_TARGET</span><span class="p">:</span>
			<span class="n">expected_base_fee_per_gas</span> <span class="o">=</span> <span class="n">parent_base_fee_per_gas</span>

		<span class="k">elif</span> <span class="n">parent_gas_used</span> <span class="o">&gt;</span> <span class="n">GAS_TARGET</span><span class="p">:</span>
			<span class="n">gas_used_delta</span> <span class="o">=</span> <span class="n">parent_gas_used</span> <span class="o">-</span> <span class="n">GAS_TARGET</span>
			<span class="n">base_fee_per_gas_delta</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">parent_base_fee_per_gas</span> <span class="o">*</span> <span class="n">gas_used_delta</span> <span class="o">//</span> <span class="n">GAS_TARGET</span> <span class="o">//</span> <span class="n">BASE_FEE_DELTA_REDUCING_DENOMINATOR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">expected_base_fee_per_gas</span> <span class="o">=</span> <span class="n">parent_base_fee_per_gas</span> <span class="o">+</span> <span class="n">base_fee_per_gas_delta</span>
			<span class="k">if</span> <span class="n">expected_base_fee_per_gas</span> <span class="o">&gt;</span> <span class="n">upper_bound_base_fee</span><span class="p">:</span>
				<span class="n">expected_base_fee_per_gas</span> <span class="o">=</span> <span class="n">upper_bound_base_fee</span>
			
		<span class="k">else</span><span class="p">:</span>
			<span class="n">gas_used_delta</span> <span class="o">=</span> <span class="n">GAS_TARGET</span> <span class="o">-</span> <span class="n">parent_gas_used</span>
			<span class="n">base_fee_per_gas_delta</span> <span class="o">=</span> <span class="n">parent_base_fee_per_gas</span> <span class="o">*</span> <span class="n">gas_used_delta</span> <span class="o">//</span> <span class="n">GAS_TARGET</span> <span class="o">//</span> <span class="n">BASE_FEE_DELTA_REDUCING_DENOMINATOR</span>
			<span class="n">expected_base_fee_per_gas</span> <span class="o">=</span> <span class="n">parent_base_fee_per_gas</span> <span class="o">-</span> <span class="n">base_fee_per_gas_delta</span>
			<span class="k">if</span> <span class="n">expected_base_fee_per_gas</span> <span class="o">&lt;</span> <span class="n">lower_bound_base_fee</span><span class="p">:</span>
				<span class="n">expected_base_fee_per_gas</span> <span class="o">=</span> <span class="n">lower_bound_base_fee</span>

		<span class="c1"># Make it a even number by subtracting 1
</span>		<span class="c1"># Since the lower bound is even number at this moment, we are sure that the value will not be lower than the lower bound.
</span>		<span class="k">if</span> <span class="n">expected_base_fee_per_gas</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">:</span>
			<span class="n">expected_base_fee_per_gas</span> <span class="o">-=</span> <span class="mi">1</span>

		<span class="k">assert</span> <span class="n">expected_base_fee_per_gas</span> <span class="o">==</span> <span class="n">block</span><span class="p">.</span><span class="n">base_fee_per_gas</span><span class="p">,</span> <span class="s">'invalid block: base fee not correct'</span>

		<span class="c1"># execute transactions and do gas accounting
</span>		<span class="n">cumulative_transaction_gas_used</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">unnormalized_transaction</span> <span class="ow">in</span> <span class="n">transactions</span><span class="p">:</span>
			<span class="c1"># Note: this validates transaction signature and chain ID which must happen before we normalize below since normalized transactions don't include signature or chain ID
</span>			<span class="n">signer_address</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">validate_and_recover_signer_address</span><span class="p">(</span><span class="n">unnormalized_transaction</span><span class="p">)</span>
			<span class="n">transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">normalize_transaction</span><span class="p">(</span><span class="n">unnormalized_transaction</span><span class="p">,</span> <span class="n">signer_address</span><span class="p">)</span>
			<span class="n">signer</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">account</span><span class="p">(</span><span class="n">signer_address</span><span class="p">)</span>

			<span class="n">signer</span><span class="p">.</span><span class="n">balance</span> <span class="o">-=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">amount</span>
			<span class="k">assert</span> <span class="n">signer</span><span class="p">.</span><span class="n">balance</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">'invalid transaction: signer does not have enough KLAY to cover attached value'</span>
			
			<span class="c1"># fee delegation transaction accounting is needed 
</span>			<span class="c1"># the signer must be able to afford the transaction
</span>			<span class="k">assert</span> <span class="n">fee_payer</span><span class="p">.</span><span class="n">balance</span> <span class="o">&gt;=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">gas_limit</span> <span class="o">*</span> <span class="n">transaction</span><span class="p">.</span><span class="n">max_fee_per_gas</span>

			<span class="c1"># ensure that the user was willing to at least pay the base fee
</span>			<span class="k">assert</span> <span class="n">transaction</span><span class="p">.</span><span class="n">max_fee_per_gas</span> <span class="o">&gt;=</span> <span class="n">block</span><span class="p">.</span><span class="n">base_fee_per_gas</span>

			<span class="c1"># Prevent impossibly large numbers
</span>			<span class="k">assert</span> <span class="n">transaction</span><span class="p">.</span><span class="n">max_fee_per_gas</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">256</span>

			<span class="n">fee_payer</span><span class="p">.</span><span class="n">balance</span> <span class="o">-=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">gas_limit</span> <span class="o">*</span> <span class="n">block</span><span class="p">.</span><span class="n">base_fee_per_gas</span>
			<span class="k">assert</span> <span class="n">fee_payer</span><span class="p">.</span><span class="n">balance</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">'invalid transaction: signer does not have enough KLAY to cover gas'</span>

			<span class="n">gas_used</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">execute_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">block</span><span class="p">.</span><span class="n">base_fee_per_gas</span><span class="p">)</span>
			<span class="n">gas_refund</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">gas_limit</span> <span class="o">-</span> <span class="n">gas_used</span>
			<span class="n">cumulative_transaction_gas_used</span> <span class="o">+=</span> <span class="n">gas_used</span>

			<span class="c1"># signer gets refunded for unused gas
</span>			<span class="n">fee_payer</span><span class="p">.</span><span class="n">balance</span> <span class="o">+=</span> <span class="n">gas_refund</span> <span class="o">*</span> <span class="n">block</span><span class="p">.</span><span class="n">base_fee_per_gas</span>

			<span class="c1"># CN and KGF, KIR account only receives some propotion of the base fee(basefee burned)
</span>			<span class="bp">self</span><span class="p">.</span><span class="n">account</span><span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="n">proposer</span><span class="p">).</span><span class="n">balance</span> <span class="o">+=</span> <span class="n">gas_used</span> <span class="o">*</span> <span class="n">block</span><span class="p">.</span><span class="n">base_fee_per_gas</span> <span class="o">*</span> <span class="n">BURN_RATIO</span> <span class="o">*</span> <span class="n">CN_DISTRIBUTION_RATIO</span>
			<span class="bp">self</span><span class="p">.</span><span class="n">account</span><span class="p">(</span><span class="n">kgf_address</span><span class="p">).</span><span class="n">balance</span> <span class="o">+=</span> <span class="n">gas_used</span> <span class="o">*</span> <span class="n">block</span><span class="p">.</span><span class="n">base_fee_per_gas</span> <span class="o">*</span> <span class="n">BURN_RATIO</span> <span class="o">*</span> <span class="n">KGF_DISTRIBUTION_RATIO</span>
			<span class="bp">self</span><span class="p">.</span><span class="n">account</span><span class="p">(</span><span class="n">kir_address</span><span class="p">).</span><span class="n">balance</span> <span class="o">+=</span> <span class="n">gas_used</span> <span class="o">*</span> <span class="n">block</span><span class="p">.</span><span class="n">base_fee_per_gas</span> <span class="o">*</span> <span class="n">BURN_RATIO</span> <span class="o">*</span> <span class="n">KIR_DISTRIBUTION_RATIO</span>

		<span class="c1"># check if the block spent too much gas transactions
</span>		<span class="k">assert</span> <span class="n">cumulative_transaction_gas_used</span> <span class="o">==</span> <span class="n">block</span><span class="p">.</span><span class="n">gas_used</span><span class="p">,</span> <span class="s">'invalid block: gas_used does not equal total gas used in all transactions'</span>

		<span class="c1"># validate the rest of the block
</span>
	<span class="k">def</span> <span class="nf">normalize_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span> <span class="n">signer_address</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormalizedTransaction</span><span class="p">:</span>
		<span class="c1"># legacy transactions
</span>		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">TxTypeLegacyTransaction</span><span class="p">):</span>
			<span class="k">return</span> <span class="n">NormalizedTransaction</span><span class="p">(</span>
				<span class="n">signer_address</span> <span class="o">=</span> <span class="n">signer_address</span><span class="p">,</span>
				<span class="n">signer_nonce</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">nonce</span><span class="p">,</span>
				<span class="n">max_fee_per_gas</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">gas_price</span><span class="p">,</span>
				<span class="n">gas_limit</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">gas</span><span class="p">,</span>
				<span class="n">to</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">to</span><span class="p">,</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="nb">input</span><span class="p">,</span>
				<span class="n">fee_payer_address</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
				<span class="n">fee_ratio</span> <span class="o">=</span> <span class="bp">None</span>
			<span class="p">)</span>

		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">TxTypeFeeDelegatedSmartContractExecution</span><span class="p">):</span>
			<span class="k">return</span> <span class="n">NormalizedTransaction</span><span class="p">(</span>
				<span class="n">signer_address</span> <span class="o">=</span> <span class="n">signer_address</span><span class="p">,</span>
				<span class="n">signer_nonce</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">nonce</span><span class="p">,</span>
				<span class="n">max_fee_per_gas</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">gas_price</span><span class="p">,</span>
				<span class="n">gas_limit</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">gas</span><span class="p">,</span>
				<span class="n">to</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">to</span><span class="p">,</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="nb">input</span><span class="p">,</span>
				<span class="n">fee_payer_address</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">,</span>
				<span class="n">fee_ratio</span> <span class="o">=</span> <span class="bp">None</span>
			<span class="p">)</span>
		
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">TxTypeFeeDelegatedSmartContractExecutionWithRatio</span><span class="p">):</span>
			<span class="k">return</span> <span class="n">NormalizedTransaction</span><span class="p">(</span>
				<span class="n">signer_address</span> <span class="o">=</span> <span class="n">signer_address</span><span class="p">,</span>
				<span class="n">signer_nonce</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">nonce</span><span class="p">,</span>
				<span class="n">max_fee_per_gas</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">gas_price</span><span class="p">,</span>
				<span class="n">gas_limit</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">gas</span><span class="p">,</span>
				<span class="n">to</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">to</span><span class="p">,</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="nb">input</span><span class="p">,</span>
				<span class="n">fee_payer_address</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">,</span>
				<span class="n">fee_ratio</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">fee_ratio</span>
			<span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">TxTypeEthereumAccessList</span><span class="p">):</span>
			<span class="k">return</span> <span class="n">NormalizedTransaction</span><span class="p">(</span>
				<span class="n">signer_address</span> <span class="o">=</span> <span class="n">signer_address</span><span class="p">,</span>
				<span class="n">signer_nonce</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">nonce</span><span class="p">,</span>
				<span class="n">max_fee_per_gas</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">gas_price</span><span class="p">,</span>
				<span class="n">gas_limit</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">gas</span><span class="p">,</span>
				<span class="n">to</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">to</span><span class="p">,</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
				<span class="n">fee_payer_address</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
				<span class="n">fee_ratio</span> <span class="o">=</span> <span class="bp">None</span>
			<span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">TxTypeEthereumDynamicFee</span><span class="p">):</span>
			<span class="k">return</span> <span class="n">NormalizedTransaction</span><span class="p">(</span>
				<span class="n">signer_address</span> <span class="o">=</span> <span class="n">signer_address</span><span class="p">,</span>
				<span class="n">signer_nonce</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">nonce</span><span class="p">,</span>
				<span class="n">max_fee_per_gas</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">gas_fee_cap</span><span class="p">,</span>
				<span class="n">gas_limit</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">gas</span><span class="p">,</span>
				<span class="n">to</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">to</span><span class="p">,</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
				<span class="n">fee_payer_address</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
				<span class="n">fee_ratio</span> <span class="o">=</span> <span class="bp">None</span>
			<span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'invalid transaction: unexpected number of items'</span><span class="p">)</span>

	<span class="o">@</span><span class="n">abstractmethod</span>
	<span class="k">def</span> <span class="nf">parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">Block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Block</span><span class="p">:</span> <span class="k">pass</span>

	<span class="o">@</span><span class="n">abstractmethod</span>
	<span class="k">def</span> <span class="nf">block_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">Block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span> <span class="k">pass</span>

	<span class="o">@</span><span class="n">abstractmethod</span>
	<span class="k">def</span> <span class="nf">transactions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">Block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Transaction</span><span class="p">]:</span> <span class="k">pass</span>

	<span class="c1"># effective_gas_price is the value returned by the GASPRICE (0x3a) opcode
</span>	<span class="o">@</span><span class="n">abstractmethod</span>
	<span class="k">def</span> <span class="nf">execute_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">NormalizedTransaction</span><span class="p">,</span> <span class="n">effective_gas_price</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span> <span class="k">pass</span>

	<span class="o">@</span><span class="n">abstractmethod</span>
	<span class="k">def</span> <span class="nf">validate_and_recover_signer_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span> <span class="k">pass</span>

	<span class="o">@</span><span class="n">abstractmethod</span>
	<span class="k">def</span> <span class="nf">account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Account</span><span class="p">:</span> <span class="k">pass</span>
</code></pre></div></div>

<h2 id="expected-effect">Expected Effect</h2>

<p>The proposed dynamic gas price mechanism is expected to solve the following problems.</p>
<ul>
  <li>Reduce transaction process delay and storage overcapacity</li>
  <li>Flexible gas price control depending on the network status</li>
  <li>Introduction of a burn mechanism</li>
</ul>

<p>But it may give rise to the following changes:</p>
<ul>
  <li>Edit gas price-related code of the ecosystem wallet and other tools</li>
  <li>Lower predictability of gas price</li>
</ul>

<h2 id="backwards-compatibility">Backwards Compatibility</h2>

<ul>
  <li>All previous transaction types will remain the same.</li>
  <li>Setting fixed gas price to send transactions will still work and be included in blocks, but those transactions will be not included in the block if a <code class="language-plaintext highlighter-rouge">base_fee_per_gas</code> is higher than the gas price.</li>
</ul>

<h2 id="reference">Reference</h2>
<ul>
  <li>https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1559.md</li>
</ul>

<h2 id="copyright">Copyright</h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.2.3/mermaid.min.js" integrity="sha512-M4zmdILgXOwrBEVfpVqdO/jC3BJZQzlXHeu967v41/QoT60sESWSLbi7YwntTbYC0ZjewfTbvXO8iKj7amvQow==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  mermaid.initialize({
    startOnLoad: true,
  });
  mermaid.run({
    querySelector: '.language-mermaid', // markdown 'mermaid' language code blocks
  });
</script>


</div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Kaia Improvement Proposals</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Kaia Improvement Proposals</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/kaiachain/KIPs"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">kaiachain/KIPs</span></a></li><li><a href="https://twitter.com/kaiachain"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">kaiachain</span></a></li><li><a href="https://www.facebook.com/kaiachain"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#facebook"></use></svg> <span class="username">kaiachain</span></a></li><li><a href="https://medium.com/kaiachain"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#medium"></use></svg> <span class="username">kaiachain</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Kaia Improvement Proposals (KIPs) describe standards for the Kaia platform, including core protocol specifications, client APIs, and contract standards.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

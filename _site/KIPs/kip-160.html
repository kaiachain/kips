<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
    <title>KIP 160: An Update of Treasury Fund Rebalancing</title>
    <meta property="og:title" content="KIP 160: An Update of Treasury Fund Rebalancing" />
    <meta
      name="description"
      content="Details on Kaia Improvement Proposal 160 (KIP 160): An Update of Treasury Fund Rebalancing"
    />
    <meta
      property="og:description"
      content="Details on Kaia Improvement Proposal 160 (KIP 160): An Update of Treasury Fund Rebalancing"
    />
    <meta name="twitter:description" content="Details on Kaia Improvement Proposal 160 (KIP 160): An Update of Treasury Fund Rebalancing" />
  
  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="http://localhost:4000/KIPs/kip-160" />
  <meta property="og:url" content="http://localhost:4000/KIPs/kip-160" />
  <meta property="og:site_name" content="Kaia Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@kaiachain" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "http://localhost:4000",
      "name": "Kaia Improvement Proposals",
      "description": "Kaia Improvement Proposals (KIPs) describe standards for the Kaia platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Kaia Improvement Proposals" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Kaia Improvement Proposals</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/all">All</a><a class="page-link" href="/core">Core</a><a class="page-link" href="/networking">Networking</a><a class="page-link" href="/storage">Storage</a><a class="page-link" href="/interface">Interface</a><a class="page-link" href="/token">KCT</a><a class="page-link" href="/sdk">SDK</a><a class="page-link" href="/application">Application</a><a class="page-link" href="/meta">Meta</a><a class="page-link" href="/informational">Informational</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="home">
  <h1 class="page-heading">
    KIP 160: An Update of Treasury Fund Rebalancing
    <a href="https://github.com/kaiachain/KIPS/blob/main/KIPs/kip-160.md"><svg role="img" aria-label="Source" xmlns="https://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><title>Source</title><path fill-rule="evenodd" d="M9.5 3L8 4.5 11.5 8 8 11.5 9.5 13 14 8 9.5 3zm-5 0L0 8l4.5 5L6 11.5 2.5 8 6 4.5 4.5 3z"/></svg></a>
  </h1>
  <table>
    <tr><th>Author</th><td><a href="https://github.com/blukat29">Ollie</a>, <a href="https://github.com/yoomee1313">Yumiel</a>, <a href="https://github.com/ian0371">Ian</a>, <a href="https://github.com/aidan-kwon">Aidan</a></td></tr>
    
    <tr><th>Status</th><td>Final
    
    </td></tr>
    <tr><th>Type</th><td>Standards Track</td></tr>
    
      <tr><th>Category</th><td>Core</td></tr>
    
    <tr><th>Created</th><td>2024-04-22</td></tr>
    
    
      <tr><th>Requires</th><td>

  <a href="kip-103">103</a>

</td></tr>
    
    
    
    
  </table>

  <h2 id="simple-summary">Simple Summary</h2>
<p>An update of treasury fund rebalancing.</p>

<h2 id="abstract">Abstract</h2>
<p>The treasury fund rebalancing is updated, resulting in updates to the treasury rebalance contract v2 and the related core logic.</p>

<h2 id="motivation">Motivation</h2>
<p>According to KIP-103, the treasury rebalancing refers to the act of burning existing fund balances and minting new funds. This event happens at a reserved time, such as a hard fork block number. Through the TreasuryRebalance contract, the disclosure of the treasury fund activities can be conducted transparently and verifiably. However, there are a few shortcomings of KIP-103; (1) it only permits the decrease in the total balance of the funds, (2) its rebalance blocknumber or memo is immutable. Once these values are set, they cannot be changed, even if they are incorrectly set.</p>

<p>To address those above, this proposal made some improvements. First of all, this proposal expands to the general cases so that we don’t have to consider whether the final result is burn or mint. The other improvement is about making rebalanceBlocknumber in the RebalanceContract editable. The rebalanceBlocknumber should be matched with the related hardfork block number.</p>

<h2 id="specification">Specification</h2>
<p>Before proceeding, this proposal will first organize and clarify the terminology. Here, the previous/new fund addresses are referred to as <code class="language-plaintext highlighter-rouge">Zeroed</code>, <code class="language-plaintext highlighter-rouge">Allocated</code> unlike in KIP-103. <code class="language-plaintext highlighter-rouge">Retired</code>, <code class="language-plaintext highlighter-rouge">Newbie</code> were ambiguous and did not clearly indicate that the previous fund balance is zeroed and the new fund balance is allocated, which degraded the readability.</p>

<h3 id="to-consider-both-total-burntotal-mint-cases">To consider both total burn/total mint cases</h3>
<p>In KIP-103, rebalancing is limited to cases where the total balance decreases. This proposal aims to generalize the process by removing the requirement that the total balance of <code class="language-plaintext highlighter-rouge">Zeroeds</code> should exceed the total minting amount of <code class="language-plaintext highlighter-rouge">Allocateds</code>. Consequently, the checking code is eliminated from the contract and core code.</p>

<p>In the <code class="language-plaintext highlighter-rouge">TreasuryRebalanceV2</code> contract, the <code class="language-plaintext highlighter-rouge">finalizeApproval</code> method has been revised as follows. Initially, this <code class="language-plaintext highlighter-rouge">require</code> statement, <code class="language-plaintext highlighter-rouge">require(getTreasuryAmount() &lt; sumOfZeroedBalance())</code>, was present. However, it has been removed to accommodate all cases.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="cm">/**
    * @dev finalizeApproval sets the status to Approved,
    *      After this stage, approvals will be restricted.
    */</span>
   <span class="k">function</span> <span class="n">finalizeApproval</span><span class="p">()</span>
        <span class="k">public</span>
        <span class="n">onlyOwner</span>
        <span class="n">onlyAtStatus</span><span class="p">(</span><span class="n">Status</span><span class="p">.</span><span class="n">Registered</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">checkZeroedsApproved</span><span class="p">();</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">Status</span><span class="p">.</span><span class="n">Approved</span><span class="p">;</span>
        <span class="k">emit</span> <span class="n">StatusChanged</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>The next validation has also been removed from the core logic. It previously ensured that the total balance of <code class="language-plaintext highlighter-rouge">Zeroeds</code> was greater than the total balance of <code class="language-plaintext highlighter-rouge">Allocateds</code>. However, it has been removed to support all cases.</p>
<ul>
  <li>totalZeroedAmount &gt;= totalAllocatedAmount</li>
</ul>

<h3 id="to-enable-editing-of-rebalanceblocknumber-defined-in-treasury-rebalance-contract">To enable editing of RebalanceBlocknumber defined in treasury rebalance contract</h3>
<p>Within the treasury rebalance contract, there exists a storage value named <code class="language-plaintext highlighter-rouge">RebalanceBlocknumber</code>, which ideally should correspond to the associated hard fork block number. Despite being able to update the hard fork block number, the <code class="language-plaintext highlighter-rouge">RebalanceBlocknumber</code> field was immutable. To align the behavior of this field with that of the hard fork block number, this proposal advocates for making the <code class="language-plaintext highlighter-rouge">RebalanceBlocknumber</code> field editable.</p>

<p>The next method is added to the TreasuryRebalanceV2 contract.</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cm">/**
     * @dev updates rebalance block number
     * @param _rebalanceBlockNumber is the updated target block number of the execution the rebalance in Core
     */</span>
    <span class="k">function</span> <span class="n">updateRebalanceBlocknumber</span><span class="p">(</span>
        <span class="kt">uint256</span> <span class="n">_rebalanceBlockNumber</span>
    <span class="p">)</span> <span class="k">public</span> <span class="n">onlyOwner</span> <span class="p">{</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="n">number</span> <span class="o">&lt;</span> <span class="n">rebalanceBlockNumber</span><span class="p">,</span> <span class="s">"current block shouldn't be past the currently set block number"</span><span class="p">);</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="n">number</span> <span class="o">&lt;</span> <span class="n">_rebalanceBlockNumber</span><span class="p">,</span> <span class="s">"rebalance blockNumber should be greater than current block"</span><span class="p">);</span>
        <span class="n">rebalanceBlockNumber</span> <span class="o">=</span> <span class="n">_rebalanceBlockNumber</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<h3 id="to-enable-editing-of-memo-defined-in-treasury-rebalance-contract">To enable editing of Memo defined in treasury rebalance contract</h3>
<p>The execution result of treasury fund rebalancing V2 is printed as an INFO-level log on each node. This log is added as a memo to the contract, making it permanently viewable. 
However, once finalized, any modifications to the memo value were restricted even if set incorrectly.
This proposal aims to seperate the memo setting process from the contract finalization, allowing the memo value to be set repeatedly.</p>

<p>The <code class="language-plaintext highlighter-rouge">setPendingMemo</code> is added and <code class="language-plaintext highlighter-rouge">finalizeContract</code> of the TreasuryRebalanceV2 contract is revised as follows.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kt">string</span> <span class="k">public</span> <span class="n">pendingMemo</span><span class="p">;</span> <span class="c1">// temporary storage for memo
</span>    <span class="kt">string</span> <span class="k">public</span> <span class="n">memo</span><span class="p">;</span> <span class="c1">// result of the treasury fund rebalance
</span>
    <span class="cm">/**
     * @dev sets the pendingMemo of the Contract. Once finalized, the memo cannot be modified.
     * @param _memo is the result of the rebalance after executing successfully in the core.
     */</span>
    <span class="k">function</span> <span class="n">setPendingMemo</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">_memo</span><span class="p">)</span> <span class="k">external</span> <span class="n">onlyOwner</span> <span class="n">onlyAtStatus</span><span class="p">(</span><span class="n">Status</span><span class="p">.</span><span class="n">Approved</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pendingMemo</span> <span class="o">=</span> <span class="n">_memo</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**
     * @dev sets the status of the contract to Finalize. Once finalized the storage data
     * of the contract cannot be modified. Also it sets the memo with pendingMemo value.
     * It will be used for public disclosure.
     * Can only be called by the current owner at Approved state after the execution of rebalance in the core
     */</span>
    <span class="k">function</span> <span class="n">finalizeContract</span><span class="p">()</span> <span class="k">external</span> <span class="n">onlyOwner</span> <span class="n">onlyAtStatus</span><span class="p">(</span><span class="n">Status</span><span class="p">.</span><span class="n">Approved</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="n">number</span> <span class="o">&gt;</span> <span class="n">rebalanceBlockNumber</span><span class="p">,</span> <span class="s">"Contract can only finalize after executing rebalancing"</span><span class="p">);</span>
        <span class="nb">require</span><span class="p">(</span><span class="kt">bytes</span><span class="p">(</span><span class="n">pendingMemo</span><span class="p">).</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"no pending memo, cannot finalize without memo"</span><span class="p">);</span>

        <span class="n">memo</span> <span class="o">=</span> <span class="n">pendingMemo</span><span class="p">;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">Status</span><span class="p">.</span><span class="n">Finalized</span><span class="p">;</span>
        <span class="k">emit</span> <span class="n">Finalized</span><span class="p">(</span><span class="n">memo</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<h3 id="result">Result</h3>
<p>In the Kip-103 memo format, the <code class="language-plaintext highlighter-rouge">zeroed</code> item showed the balance of the zereods before rebalancing, while the <code class="language-plaintext highlighter-rouge">allocated</code> item showed the balance of the allocateds after rebalancing. 
It was insufficient for interpreting the rebalancing results. Therefore, this proposal changes the format to display balances both before and after rebalancing. 
The newly proposed memo format is shown below with balance/amount in kei (peb of Klaytn).</p>

<p><strong>Format</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "before": { 
    "zeroed": { "0xZeroedAddress1": [balance of zeroedAddress1 before rebalance],  "0xZeroedAddress2": [balance of zeroedAddress2 before rebalance], ...},
    "allocated": {  "0xAllocatedAddress1": [balance of AllocatedAddress1 before rebalance],  "0xAllocatedAddress2": [balance of AllocatedAddress1 before rebalance], ...}
  },
  "after": {  
    zeroed": {  "0xZeroedAddress1": [balance of zeroedAddress1 after rebalance], "0xZeroedAddress2": [balance of zeroedAddress2 after rebalance], ...},
    "allocated": { "0xAllocatedAddress1": [balance of AllocatedAddress1 after rebalance],  "0xAllocatedAddress2": [balance of AllocatedAddress1 after rebalance], ...}
  },
  "burnt": [burnt amount],
  "success": [true/false]
}
</code></pre></div></div>

<h2 id="rationale">Rationale</h2>
<p>While executing the core logic of the KIP-103 treasury rebalance, the unintended increase in the nonce of the ‘0x0’ address occured. In KIP-160, this issue can be resolved by replacing the usage of <code class="language-plaintext highlighter-rouge">kip103ContractBackend</code> with <code class="language-plaintext highlighter-rouge">BlockchainContractBackend</code>. For your reference, <code class="language-plaintext highlighter-rouge">ContractBackend</code> facilitates the interaction between the core and contracts.</p>

<p>The following pseudocode illustrates how to define a contract callers for each rebalancing.</p>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">RebalanceTreasury</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">current</span> <span class="n">block</span> <span class="n">number</span> <span class="n">is</span> <span class="n">equal</span> <span class="n">to</span> <span class="n">KIP</span><span class="o">-</span><span class="m">160</span> <span class="n">hard</span> <span class="n">fork</span> <span class="n">block</span> <span class="n">number</span> <span class="p">{</span>
		<span class="c">// Define the caller for the NewTreasuryRebalanceV2 contract </span>
		<span class="n">caller</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">rebalance</span><span class="o">.</span><span class="n">NewTreasuryRebalanceV2Caller</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span><span class="o">.</span><span class="n">Kip160ContractAddress</span><span class="p">,</span> <span class="n">backends</span><span class="o">.</span><span class="n">NewBlockchainContractBackend</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="no">nil</span><span class="p">,</span> <span class="no">nil</span><span class="p">))</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="n">current</span> <span class="n">block</span> <span class="n">number</span> <span class="n">is</span> <span class="n">equal</span> <span class="n">to</span> <span class="n">KIP</span><span class="o">-</span><span class="m">103</span> <span class="n">hard</span> <span class="n">fork</span> <span class="n">block</span> <span class="n">number</span> <span class="p">{</span>
		<span class="c">// Define the caller for the NewTreasuryRebalance contract </span>
		<span class="n">caller</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">rebalance</span><span class="o">.</span><span class="n">NewTreasuryRebalanceCaller</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span><span class="o">.</span><span class="n">Kip103ContractAddress</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Kip103ContractCaller</span><span class="p">{</span><span class="n">state</span><span class="o">:</span> <span class="n">state</span><span class="p">,</span> <span class="n">chain</span><span class="o">:</span> <span class="n">chain</span><span class="p">,</span> <span class="n">header</span><span class="o">:</span> <span class="n">header</span><span class="p">},</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">stop</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<h2 id="test-cases">Test cases</h2>
<p>TBD</p>

<h2 id="reference">Reference</h2>
<p>TBD</p>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.2.3/mermaid.min.js" integrity="sha512-M4zmdILgXOwrBEVfpVqdO/jC3BJZQzlXHeu967v41/QoT60sESWSLbi7YwntTbYC0ZjewfTbvXO8iKj7amvQow==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  mermaid.initialize({
    startOnLoad: true,
  });
  mermaid.run({
    querySelector: '.language-mermaid', // markdown 'mermaid' language code blocks
  });
</script>


</div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Kaia Improvement Proposals</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Kaia Improvement Proposals</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/kaiachain/KIPs"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">kaiachain/KIPs</span></a></li><li><a href="https://twitter.com/kaiachain"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">kaiachain</span></a></li><li><a href="https://www.facebook.com/kaiachain"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#facebook"></use></svg> <span class="username">kaiachain</span></a></li><li><a href="https://medium.com/kaiachain"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#medium"></use></svg> <span class="username">kaiachain</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Kaia Improvement Proposals (KIPs) describe standards for the Kaia platform, including core protocol specifications, client APIs, and contract standards.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
    <title>KIP 81: Implementing the on-chain governance voting method</title>
    <meta property="og:title" content="KIP 81: Implementing the on-chain governance voting method" />
    <meta
      name="description"
      content="Details on Kaia Improvement Proposal 81 (KIP 81): Implementing the on-chain governance voting method"
    />
    <meta
      property="og:description"
      content="Details on Kaia Improvement Proposal 81 (KIP 81): Implementing the on-chain governance voting method"
    />
    <meta name="twitter:description" content="Details on Kaia Improvement Proposal 81 (KIP 81): Implementing the on-chain governance voting method" />
  
  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="http://localhost:4000/KIPs/kip-81" />
  <meta property="og:url" content="http://localhost:4000/KIPs/kip-81" />
  <meta property="og:site_name" content="Kaia Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@kaiachain" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "http://localhost:4000",
      "name": "Kaia Improvement Proposals",
      "description": "Kaia Improvement Proposals (KIPs) describe standards for the Kaia platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Kaia Improvement Proposals" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Kaia Improvement Proposals</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/all">All</a><a class="page-link" href="/core">Core</a><a class="page-link" href="/networking">Networking</a><a class="page-link" href="/storage">Storage</a><a class="page-link" href="/interface">Interface</a><a class="page-link" href="/token">KCT</a><a class="page-link" href="/sdk">SDK</a><a class="page-link" href="/application">Application</a><a class="page-link" href="/meta">Meta</a><a class="page-link" href="/informational">Informational</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="home">
  <h1 class="page-heading">
    KIP 81: Implementing the on-chain governance voting method
    <a href="https://github.com/kaiachain/KIPS/blob/main/KIPs/kip-81.md"><svg role="img" aria-label="Source" xmlns="https://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><title>Source</title><path fill-rule="evenodd" d="M9.5 3L8 4.5 11.5 8 8 11.5 9.5 13 14 8 9.5 3zm-5 0L0 8l4.5 5L6 11.5 2.5 8 6 4.5 4.5 3z"/></svg></a>
  </h1>
  <table>
    <tr><th>Author</th><td><a href="mailto:yeriel.lee@krustuniverse.com">Yeri</a>, <a href="mailto:daniel.cc@krustuniverse.com">Daniel</a>, <a href="mailto:aidan.kwon@krustuniverse.com">Aidan</a>, <a href="mailto:ollie.j@krustuniverse.com">Ollie</a>, <a href="mailto:eddie.kim0@krustuniverse.com">Eddie</a></td></tr>
    
    <tr><th>Status</th><td>Draft
    
    </td></tr>
    <tr><th>Type</th><td>Standards Track</td></tr>
    
      <tr><th>Category</th><td>Core</td></tr>
    
    <tr><th>Created</th><td>2022-09-19</td></tr>
    
    
    
    
    
  </table>

  <h2 id="simple-summary">Simple Summary</h2>
<p>Introducing a new governance voting method based on the staking amount and implementation of the Klaytn Square, a governance portal</p>

<h2 id="abstract">Abstract</h2>
<p>Klaytn introduces a stake-based governance model that provides voting power to governance participants. Currently, one vote per Governance Council(GC) member was cast. The new method will introduce the voting right that will be exercised based on the staking amount with the maximum cap to prevent an entity from making an arbitrary decision. The voting agenda is determined through discussion on the Klaytn Governance Forum, and the topic will be presented and voted on at the newly launched Governance Portal, Klaytn Square. This voting mechanism aims to provide responsibility and obligation of voting to Governance Councils.</p>

<h2 id="motivation">Motivation</h2>
<p>The new on-chain voting mechanism discloses GC’s opinion transparently through the portal, allowing anyone to view the result. The governance agenda discussed in Klaytn Governance Forum will be voted on the governance portal, Klaytn Square. Since the voting power is calculated based on the staking amount, this voting process provides more power to GC members who share the same interest as Klaytn by staking and locking up more KLAYs.</p>

<h2 id="specification">Specification</h2>
<p>Klaytn Governance Forum is to freely propose and discuss Klaytn governance items. Once Klaytn Square, the governance portal, opens, the on-chain voting will be executed based on the discussion held in this forum.</p>

<p>Klaytn Square includes the following functions:</p>
<ul>
  <li>Ability to vote on a governance agenda and view the voting process</li>
  <li>Information about Governance Councils: description, contract address, notice, staking status, staking and reward history, etc.</li>
  <li>View the history of governance agenda and Governance Councils</li>
</ul>

<p><img src="/assets/kip-81/voting_process_diagram.png" alt="voting process diagram" /></p>

<p>The foundation will provide 7 days of preparation period for voting, providing a time for GC to adjust the staking amount. With the start of the voting, the foundation will announce the list of GC members and their voting power. GC will have 7 days of the voting period.</p>

<p>The Klaytn governance voting system is designed based on the following fundamental premises.</p>
<ul>
  <li>Klaytn’s major decision-making process should reflect the opinions of as many participants as possible from the ecosystem.</li>
  <li>Participants will be more likely to make a decision that is beneficial to the Klaytn ecosystem if they hold more KLAY. This is based on the premise that the growth of Klaytn’s ecosystem is correlated to the rise in the value of KLAY.</li>
  <li>The governance system should be able to manage the situations in which a particular entity makes an arbitrary decision. This is because the entity may weaken the sustainability of the entire network.</li>
  <li>The act of voting and the gain of voting power is different.</li>
</ul>

<p>Recognizing a tendency that the member with more KLAY makes a decision that benefits the Klaytn ecosystem in the long run, we are granting a higher voting power to members with more KLAY. Yet, to prevent a particular subject from making an arbitrary decision, we are placing a cap on the voting power one can receive at the maximum. Therefore, a GC member will receive 1 vote per a certain amount of staked KLAY (initial configuration: 5 million KLAY). The maximum number of votes a member can own is one less than the total number of GC members. In other words, [Maximum Voting Power =  Total number of GC members - 1]. For example, if there are 35 GC members, one can own a maximum of 34 voting power. This cap structure prevents potential monopolies.</p>

<h3 id="smart-contracts-overview">Smart Contracts Overview</h3>

<p>The Klaytn on-chain governance voting will be conducted on smart contracts. Several contracts and accounts interact together in the process. The below diagram shows the relationship between contracts and accounts.</p>

<p>Find an example implementation <a href="https://github.com/klaytn/governance-contracts-audit">here</a>.</p>

<ul>
  <li>Contracts
    <ul>
      <li><strong>AddressBook</strong>: an existing contract that stores the list of GC nodes, their staking contracts, and their reward recipient addresses.</li>
      <li><strong>CnStakingV2</strong>: an updated version of the existing CnStakingContract. GCs stake their KLAYs to earn rights to validate blocks and cast on-chain votes.</li>
      <li><strong>StakingTracker</strong>: a new contract that tracks voting-related data from AddressBook and CnStakingV2 contracts.</li>
      <li><strong>Voting</strong>: a new contract that processes the on-chain voting. It stores governance proposals, counts votes, and sends approved transactions.</li>
    </ul>
  </li>
  <li>Accounts
    <ul>
      <li><strong>AddressBook admins</strong>: a set of accounts controlled by the Foundation which can manage the list of GCs in the AddressBook. AddressBook admins are managed in the AddressBook contract.</li>
      <li><strong>CnStaking admins</strong>: a set of accounts controlled by each GC that can manage the staked KLAYs and its voter account. CnStaking admins are managed in the respective CnStakingV2 contracts. Note that every CnStakingV2 contract has a different set of admins.</li>
      <li><strong>Voter account</strong>: an account controlled by each GC member that can cast on-chain votes. But this account cannot withdraw KLAYs from CnStakingV2 contracts. A Voter account is appointed at CnStakingV2 contracts of the respective GC member.</li>
      <li><strong>Secretariat account</strong>: an account controlled by the Foundation which can propose and execute on-chain governance proposals. The secretariat account is managed in the Voting contract.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/kip-81/smart_contract_relation.png" alt="contracts and accounts" /></p>

<h3 id="adressbook">AdressBook</h3>

<p>In Cypress mainnet and Baobab testnet, an <a href="https://github.com/klaytn/klaytn/blob/v1.9.1/contracts/reward/contract/AddressBook.sol">AddressBook contract</a> is deployed at address <code class="language-plaintext highlighter-rouge">0x0000000000000000000000000000000000000400</code>. For the purpose of Voting, the following function of the AddressBook is used.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">interface</span> <span class="n">IAddressBook</span> <span class="p">{</span>
    <span class="c1">/// @dev Returns all addresses in the AddressBook.
</span>    <span class="c1">///
</span>    <span class="c1">/// Each GC's addresses are stored in the same index of the three arrays.
</span>    <span class="c1">/// i.e. GC[i] is described in (nodeIds[i], stakingContracts[i], rewardAddresses[i])
</span>    <span class="c1">/// However, a GC may operate multiple staking contracts. In this case,
</span>    <span class="c1">/// the GC occupies multiple indices with the same reward address.
</span>    <span class="c1">///
</span>    <span class="c1">/// @return nodeIds           GC consensus node address list
</span>    <span class="c1">/// @return stakingContracts  GC staking contract address list
</span>    <span class="c1">/// @return rewardAddresses   GC reward recipient address list
</span>    <span class="c1">/// @return pocAddress        PoC(KGF) recipient address
</span>    <span class="c1">/// @return kirAddress        KIR recepient address
</span>    <span class="k">function</span> <span class="n">getAllAddressInfo</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span>
        <span class="kt">address</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">nodeIds</span><span class="p">,</span>
        <span class="kt">address</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">stakingContracts</span><span class="p">,</span>
        <span class="kt">address</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">rewardAddresses</span><span class="p">,</span>
        <span class="kt">address</span> <span class="n">pocAddress</span><span class="p">,</span>
        <span class="kt">address</span> <span class="n">kirAddress</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="cnstakingv2">CnStakingV2</h3>

<p>CnStakingV2 is an upgraded version of <a href="https://github.com/klaytn/klaytn/blob/v1.9.1/contracts/cnstaking/CnStakingContract.sol">CnStakingContract</a>. The CnStakingContract has been serving the purpose of locking GC stakes. V2 will add two new features related to StakingTracker, which will be described later.</p>

<ul>
  <li>It holds a new unique identifier “GC ID” which is a nonzero integer assigned to each GC member. If a GC member owns multiple CnStakingV2 contracts, the contracts must contain the same GC ID value.</li>
  <li>Whenever its KLAY balance changes, V2 notifies the StakingTracker.</li>
  <li>V2 stores a voter account address, and notifies the StakingTracker whenever it changes. The voter account can be changed by its admins.</li>
</ul>

<p>To support the new features, the following functions are added. The functions <code class="language-plaintext highlighter-rouge">setStakingTracker</code> and <code class="language-plaintext highlighter-rouge">setGCId</code> is only callable before contract <a href="https://github.com/klaytn/klaytn/blob/v1.9.1/contracts/cnstaking/CnStakingContract.sol#L237">initialization</a>. Functions <code class="language-plaintext highlighter-rouge">updateStakingTracker</code> and <code class="language-plaintext highlighter-rouge">updateVoterAddress</code> are invoked upon approval of CnStaking admins using the existing <a href="https://github.com/klaytn/klaytn/blob/v1.9.1/contracts/cnstaking/CnStakingContract.sol#L597">CnStaking multisig facility</a>.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">abstract</span> <span class="k">contract</span> <span class="n">CnStakingV2</span> <span class="p">{</span>
    <span class="k">event</span> <span class="n">UpdateStakingTracker</span><span class="p">(</span><span class="kt">address</span> <span class="n">stakingTracker</span><span class="p">);</span>
    <span class="k">event</span> <span class="n">UpdateVoterAddress</span><span class="p">(</span><span class="kt">address</span> <span class="n">voterAddress</span><span class="p">);</span>
    <span class="k">event</span> <span class="n">UpdateGCId</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">gcId</span><span class="p">);</span>

    <span class="k">function</span> <span class="n">stakingTracker</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="kt">address</span><span class="p">);</span>
    <span class="k">function</span> <span class="n">voterAddress</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="kt">address</span><span class="p">);</span>
    <span class="k">function</span> <span class="n">gcId</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="kt">uint256</span><span class="p">);</span>

    <span class="c1">/// @dev Set the initial stakingTracker address
</span>    <span class="c1">/// Emits an UpdateStakingTracker event.
</span>    <span class="k">function</span> <span class="n">setStakingTracker</span><span class="p">(</span><span class="kt">address</span> <span class="n">_tracker</span><span class="p">)</span> <span class="k">external</span> <span class="n">beforeInit</span><span class="p">;</span>

    <span class="c1">/// @dev Set the gcId
</span>    <span class="c1">/// The gcId never changes once initialized.
</span>    <span class="c1">/// Emits an UpdateGCId event.
</span>    <span class="k">function</span> <span class="n">setGCId</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">_gcId</span><span class="p">)</span> <span class="k">external</span> <span class="n">beforeInit</span><span class="p">;</span>

    <span class="c1">/// @dev Update the StakingTracker address this contract reports to
</span>    <span class="c1">/// Emits an UpdateStakingTracker event.
</span>    <span class="k">function</span> <span class="n">submitUpdateStakingTracker</span><span class="p">(</span><span class="kt">address</span> <span class="n">_tracker</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>
    <span class="k">function</span> <span class="n">updateStakingTracker</span><span class="p">(</span><span class="kt">address</span> <span class="n">_tracker</span><span class="p">)</span> <span class="k">external</span> <span class="n">onlyMultisigTx</span><span class="p">;</span>

    <span class="c1">/// @dev Update the voter address of this GC
</span>    <span class="c1">/// Emits an UpdateVoterAddress event.
</span>    <span class="k">function</span> <span class="n">submitUpdateVoterAddress</span><span class="p">(</span><span class="kt">address</span> <span class="n">_addr</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>
    <span class="k">function</span> <span class="n">updateVoterAddress</span><span class="p">(</span><span class="kt">address</span> <span class="n">_addr</span><span class="p">)</span> <span class="k">external</span> <span class="n">onlyMultisigTx</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="notifying-changes-to-stakingtracker">Notifying changes to StakingTracker</h4>

<p>To notify balance and voter account changes to the StakingTracker contract, the CnStakingV2 contract shall call the StakingTracker whenever after every change. For example,</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">abstract</span> <span class="k">contract</span> <span class="n">CnStakingV2</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">depositLockupStakingAndInit</span><span class="p">()</span> <span class="k">payable</span> <span class="n">beforeInit</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// ...
</span>        <span class="n">stakingTracker</span><span class="p">.</span><span class="n">refreshStake</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">function</span> <span class="n">stakeKlay</span><span class="p">()</span> <span class="k">payable</span> <span class="p">{</span>
        <span class="c1">// ...
</span>        <span class="n">stakingTracker</span><span class="p">.</span><span class="n">refreshStake</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">function</span> <span class="n">withdrawLockupStaking</span><span class="p">(</span><span class="kt">address</span> <span class="n">_to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_value</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ...
</span>        <span class="n">_to</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="n">_value</span><span class="p">);</span>
        <span class="n">stakingTracker</span><span class="p">.</span><span class="n">refreshStake</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">function</span> <span class="n">withdrawApprovedStaking</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">_approvedWithdrawalId</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ...
</span>        <span class="n">_to</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="n">_value</span><span class="p">);</span>
        <span class="n">stakingTracker</span><span class="p">.</span><span class="n">refreshStake</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">function</span> <span class="n">updateVoterAddress</span><span class="p">(</span><span class="kt">address</span> <span class="n">_addr</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ...
</span>        <span class="n">voterAddress</span> <span class="o">=</span> <span class="n">_addr</span><span class="p">;</span>
        <span class="n">stakingTracker</span><span class="p">.</span><span class="n">refreshVoter</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">interface</span> <span class="n">IStakingTracker</span> <span class="p">{</span>
    <span class="c1">/// @dev Re-evaluate Tracker contents related to the staking contract
</span>    <span class="c1">/// @param staking  The CnStaking contract address
</span>    <span class="k">function</span> <span class="n">refreshStake</span><span class="p">(</span><span class="kt">address</span> <span class="n">staking</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="c1">/// @dev Update a GC's voter address from the given address
</span>    <span class="c1">/// @param staking  The CnStaking contract address
</span>    <span class="k">function</span> <span class="n">refreshVoter</span><span class="p">(</span><span class="kt">address</span> <span class="n">staking</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="version-identifier">Version identifier</h4>

<p>To distinguish the CnStakingContract and CnStakingV2 contracts, V2 will have VERSION value 2.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">abstract</span> <span class="k">contract</span> <span class="n">CnStakingV2</span> <span class="p">{</span>
    <span class="kt">uint256</span> <span class="k">constant</span> <span class="k">public</span> <span class="n">VERSION</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="example-implementation">Example implementation</h4>

<p>See <a href="https://github.com/klaytn/governance-contracts-audit/blob/main/contracts/CnStakingV2.sol">here</a> for an example implementation.</p>

<h3 id="stakingtracker">StakingTracker</h3>

<p>StakingTracker collects voting-related data of each GC member.</p>

<ul>
  <li>
    <p>Staking amounts and voting powers <br />
Stored separately in <code class="language-plaintext highlighter-rouge">Tracker</code> structs. Each <code class="language-plaintext highlighter-rouge">Tracker</code> struct can be updated between <code class="language-plaintext highlighter-rouge">trackStart</code> and <code class="language-plaintext highlighter-rouge">trackEnd</code> blocks, but becomes immutable afterward, essentially freezing the voting powers. A <code class="language-plaintext highlighter-rouge">Tracker</code> struct is first created in <code class="language-plaintext highlighter-rouge">createTracker()</code>, and updated by <code class="language-plaintext highlighter-rouge">refreshStake()</code>.</p>
  </li>
  <li>
    <p>Each GC’s voter accounts <br />
Stored in global mappings, and can be updated at any time. Voter account mappings are updated by <code class="language-plaintext highlighter-rouge">refreshVoter()</code>.</p>
  </li>
</ul>

<h4 id="contract-interface">Contract interface</h4>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">abstract</span> <span class="k">contract</span> <span class="n">StakingTracker</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">Tracker</span> <span class="p">{</span>
        <span class="c1">// Tracked block range.
</span>        <span class="c1">// Balance changes are only updated if trackStart &lt;= block.number &lt; trackEnd.
</span>        <span class="kt">uint256</span> <span class="n">trackStart</span><span class="p">;</span>
        <span class="kt">uint256</span> <span class="n">trackEnd</span><span class="p">;</span>

        <span class="c1">// Determined at createTracker() and does not change.
</span>        <span class="kt">uint256</span><span class="p">[]</span> <span class="n">gcIds</span><span class="p">;</span>
        <span class="k">mapping</span><span class="p">(</span><span class="kt">uint256</span> <span class="o">=&gt;</span> <span class="kt">bool</span><span class="p">)</span> <span class="n">gcExists</span><span class="p">;</span>
        <span class="k">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">)</span> <span class="n">stakingToGCId</span><span class="p">;</span>

        <span class="c1">// Balances and voting powers.
</span>        <span class="c1">// First collected at createTracker() and updated at refreshStake() until trackEnd.
</span>        <span class="k">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">)</span> <span class="n">stakingBalances</span><span class="p">;</span> <span class="c1">// staking address balances
</span>        <span class="k">mapping</span><span class="p">(</span><span class="kt">uint256</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">)</span> <span class="n">gcBalances</span><span class="p">;</span> <span class="c1">// consolidated GC balances
</span>        <span class="k">mapping</span><span class="p">(</span><span class="kt">uint256</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">)</span> <span class="n">gcVotes</span><span class="p">;</span> <span class="c1">// GC voting powers
</span>        <span class="kt">uint256</span> <span class="n">totalVotes</span><span class="p">;</span>
        <span class="kt">uint256</span> <span class="n">numEligible</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Tracker objects. Added by createTracker().
</span>    <span class="k">mapping</span><span class="p">(</span><span class="kt">uint256</span> <span class="o">=&gt;</span> <span class="n">Tracker</span><span class="p">)</span> <span class="k">private</span> <span class="n">trackers</span><span class="p">;</span> <span class="c1">// trackerId =&gt; Tracker
</span>    <span class="kt">uint256</span><span class="p">[]</span> <span class="k">private</span> <span class="n">allTrackerIds</span><span class="p">;</span>

    <span class="c1">// 1-to-1 mapping between nodeId and voter account.
</span>    <span class="c1">// Updated by refreshVoter().
</span>    <span class="k">mapping</span><span class="p">(</span><span class="kt">uint256</span> <span class="o">=&gt;</span> <span class="kt">address</span><span class="p">)</span> <span class="k">public</span> <span class="n">gcIdToVoter</span><span class="p">;</span>
    <span class="k">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">)</span> <span class="k">public</span> <span class="n">voterToGCId</span><span class="p">;</span>

    <span class="c1">// Minimum staking amount to have 1 vote
</span>    <span class="k">function</span> <span class="n">MIN_STAKE</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="kt">uint256</span><span class="p">);</span>

    <span class="c1">/// @dev Creates a new Tracker and populate initial values from AddressBook
</span>    <span class="k">function</span> <span class="n">createTracker</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">trackStart</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">trackEnd</span><span class="p">)</span>
        <span class="k">external</span> <span class="k">returns</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">trackerId</span><span class="p">);</span>

    <span class="c1">/// @dev Re-evaluate Tracker contents related to the staking contract
</span>    <span class="c1">/// Anyone can call this function, but `staking` must be a staking contract
</span>    <span class="c1">/// registered to the AddressBook.
</span>    <span class="k">function</span> <span class="n">refreshStake</span><span class="p">(</span><span class="kt">address</span> <span class="n">staking</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="c1">/// @dev Re-evaluate voter account mapping related to the staking contract
</span>    <span class="c1">/// Anyone can call this function, but `staking` must be a staking contract
</span>    <span class="c1">/// registered to the AddressBook.
</span>    <span class="c1">/// Note that two different nodes cannot appoint the same voter address.
</span>    <span class="k">function</span> <span class="n">refreshVoter</span><span class="p">(</span><span class="kt">address</span> <span class="n">staking</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="c1">/// @dev Return integer fields of a tracker
</span>    <span class="k">function</span> <span class="n">getTrackerSummary</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">trackerId</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span>
        <span class="kt">uint256</span> <span class="n">trackStart</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">trackEnd</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">numGCs</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">totalVotes</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">numEligible</span><span class="p">)</span>

    <span class="c1">/// @dev Return balances and votes of all GC members stored in a tracker
</span>    <span class="k">function</span> <span class="n">getAllTrackedGCs</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">trackerId</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span>
        <span class="kt">uint256</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">gcIds</span><span class="p">,</span>
        <span class="kt">uint256</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">gcBalances</span><span class="p">,</span>
        <span class="kt">uint256</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">gcVotes</span><span class="p">)</span>

    <span class="c1">/// @dev Return the balance and votes of a specified GC member
</span>    <span class="k">function</span> <span class="n">getTrackedGC</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">trackerId</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">gcId</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span>
        <span class="kt">uint256</span> <span class="n">gcBalance</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">gcVotes</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="usage">Usage</h4>

<p>A voting contract can utilize StakingTracker as follows.</p>

<ol>
  <li>When a governance proposal is submitted, the voting contract calls <code class="language-plaintext highlighter-rouge">createTracker()</code> to finalize the eligible GC members list and evaluate voting powers.</li>
  <li>Before <code class="language-plaintext highlighter-rouge">trackEnd</code> block, GC members stake or unstake their KLAYs from their CnStakingV2 contracts. The CnStakingV2 contracts will then call <code class="language-plaintext highlighter-rouge">refreshStake()</code> to notify the balance change.</li>
  <li>GC members may change their voter account in their CnStakingV2 contracts. The CnStakingV2 contracts will then call <code class="language-plaintext highlighter-rouge">refreshVoter()</code> to notify voter account change.</li>
  <li>After <code class="language-plaintext highlighter-rouge">trackEnd</code> block, the voting powers are frozen. The voting contract uses StakingTracker getters to process votes cast by voter accounts.</li>
</ol>

<h4 id="example-implementation-1">Example implementation</h4>

<p>See <a href="https://github.com/klaytn/governance-contracts-audit/blob/main/contracts/StakingTracker.sol">here</a> for an example implementation.</p>

<h3 id="voting">Voting</h3>

<p>The Voting contract operates the on-chain governance votes. The Voting contract stores governance proposals, counts casted votes, and sends on-chain transactions. Its design is influenced by <a href="https://docs.compound.finance/v2/governance/">Compound Finance</a> and <a href="https://docs.openzeppelin.com/contracts/4.x/api/governance">OpenZeppelin</a>.</p>

<p>A proposal contains textual descriptions and optionally on-chain transactions. The transactions are executed on behalf of the voting contract if the proposal receives enough votes.</p>

<p>While GCs hold their voting rights from staked KLAYs, a special secretariat account manages the overall on-chain governance process. Governance proposals can be submitted by the secretariat account, or any GC if the secretariat account is not set. The secretariat account can be updated by on-chain governance.</p>

<h4 id="voting-steps-overview">Voting steps overview</h4>

<p>Under the default timing settings, a typical governance proposal is handled as follows.</p>

<ol>
  <li>When a governance proposal is submitted, it enters a 7-day preparation period where GCs can adjust their voting powers by staking or unstaking KLAYs. The list of voters (i.e., GCs) is finalized at the moment of proposal submission. However, voting powers are finalized at the end of the preparation period.</li>
  <li>A 7-day voting period immediately follows after the preparation period.</li>
  <li>If there are enough Yes votes, the transactions can be queued within 14 days after voting ends.</li>
  <li>The transaction is delayed by 2 days to be executable. This delay gives the ecosystem enough time to adjust to the change and perform a final review of transactions.</li>
  <li>After the delay, the transaction can be executed within 14 days.</li>
</ol>

<p>The proposer of a proposal can cancel it at any time prior to execution. If a passed transaction is not queued or executed within the timeout, the proposal automatically expires.</p>

<p><img src="/assets/kip-81/voting_steps.png" alt="voting steps" /></p>

<h4 id="access-control">Access control</h4>

<p>Voting contract has two category of users, secretary and voters.</p>

<ul>
  <li>The secretary is a single account stored in the <code class="language-plaintext highlighter-rouge">secretary</code> variable. This account is intended to be controlled by the Klaytn Foundation. It will serve the GC by assisting administrative works such as submitting and executing proposals.</li>
  <li>The voters are identified by their GC ID. The list of voters differs per proposal, depending on the list of GC members registered in AddressBook and their staking amounts at the time of proposal submission.</li>
</ul>

<p>In its default setting, only the secretary can propose and execute proposals. Later the voters may be allowed to propose and execute proposals by changing the following access rule.</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Meaning</th>
      <th>Default Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">secretaryPropose</code></td>
      <td>True if the secretary can propose()</td>
      <td>true</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">voterPropose</code></td>
      <td>True if any eligible voter at the time of the submission can propose() a proposal</td>
      <td>false</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">secretaryExecute</code></td>
      <td>True if the secretary can queue() and execute()</td>
      <td>true</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">voterExecute</code></td>
      <td>True if any eligible voter of a given proposal can queue() and execute() the proposal</td>
      <td>false</td>
    </tr>
  </tbody>
</table>

<h4 id="timing-rule">Timing rule</h4>

<p>The proposal timeline is dictated by several timing values below. The settings are expressed in
block numbers. The number of days in the below table is calculated based on 1 block/sec assumption.</p>

<p>To support flexible operation, Voting contract allows each proposal to have different <code class="language-plaintext highlighter-rouge">votingDelay</code> and <code class="language-plaintext highlighter-rouge">votingPeriod</code> within respective min and max values.
However, <code class="language-plaintext highlighter-rouge">queueTimeout</code>, <code class="language-plaintext highlighter-rouge">execDelay</code> and <code class="language-plaintext highlighter-rouge">execTimeout</code> are should not be configurable.</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Meaning</th>
      <th>Default Value</th>
      <th>Configurability</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">minVotingDelay</code></td>
      <td>Minimum <code class="language-plaintext highlighter-rouge">votingDelay</code></td>
      <td>86400 (1 day)</td>
      <td>via <code class="language-plaintext highlighter-rouge">updateTimingRule</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">maxVotingDelay</code></td>
      <td>Maximum <code class="language-plaintext highlighter-rouge">votingDelay</code></td>
      <td>2419200 (28 days)</td>
      <td>via <code class="language-plaintext highlighter-rouge">updateTimingRule</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">minVotingPeriod</code></td>
      <td>Minimum <code class="language-plaintext highlighter-rouge">votingPeriod</code></td>
      <td>86400 (1 day)</td>
      <td>via <code class="language-plaintext highlighter-rouge">updateTimingRule</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">maxVotingPeriod</code></td>
      <td>Maximum <code class="language-plaintext highlighter-rouge">votingPeriod</code></td>
      <td>2419200 (28 days)</td>
      <td>via <code class="language-plaintext highlighter-rouge">updateTimingRule</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">votingDelay</code></td>
      <td>Delay from proposal submission to voting start</td>
      <td> </td>
      <td>Specify per proposal</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">votingPeriod</code></td>
      <td>Duration of the voting</td>
      <td> </td>
      <td>Specify per proposal</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">queueTimeout</code></td>
      <td>Grace period to queue() passed proposals</td>
      <td>1209600 (14 days)</td>
      <td>Cannot modify</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">execDelay</code></td>
      <td>A minimum delay before a queued transaction can be executed</td>
      <td>172800 (2 days)</td>
      <td>Cannot modify</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">execTimeout</code></td>
      <td>Grace period to execute() queued proposals since <code class="language-plaintext highlighter-rouge">execDelay</code></td>
      <td>1209600 (14 days)</td>
      <td>Cannot modify</td>
    </tr>
  </tbody>
</table>

<h4 id="quorum">Quorum</h4>

<p>A proposal passes when it satisfies a combination of the following conditions.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">CountQuorum</code> = At least 1/3 of all eligible voters cast votes</li>
  <li><code class="language-plaintext highlighter-rouge">PowerQuorum</code> = At least 1/3 of all eligible voting powers cast votes</li>
  <li><code class="language-plaintext highlighter-rouge">MajorityYes</code> = Yes votes are more than half of total cast votes (i.e. <code class="language-plaintext highlighter-rouge">Yes &gt; No + Abstain</code>)</li>
  <li><code class="language-plaintext highlighter-rouge">PassCondition = (CountQuorum or PowerQuorum) and MajorityYes</code></li>
</ul>

<h4 id="contract-interface-1">Contract interface</h4>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">interface</span> <span class="n">Voting</span> <span class="p">{</span>
    <span class="k">enum</span> <span class="n">ProposalState</span> <span class="p">{</span> <span class="n">Pending</span><span class="p">,</span> <span class="n">Active</span><span class="p">,</span> <span class="n">Canceled</span><span class="p">,</span> <span class="n">Failed</span><span class="p">,</span> <span class="n">Passed</span><span class="p">,</span> <span class="n">Queued</span><span class="p">,</span> <span class="n">Expired</span><span class="p">,</span> <span class="n">Executed</span> <span class="p">}</span>
    <span class="k">enum</span> <span class="n">VoteChoice</span> <span class="p">{</span> <span class="n">No</span><span class="p">,</span> <span class="n">Yes</span><span class="p">,</span> <span class="n">Abstain</span> <span class="p">}</span>
    <span class="k">struct</span> <span class="n">Receipt</span> <span class="p">{</span>
        <span class="kt">bool</span> <span class="n">hasVoted</span><span class="p">;</span>
        <span class="kt">uint8</span> <span class="n">choice</span><span class="p">;</span>
        <span class="kt">uint256</span> <span class="n">votes</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// events
</span>
    <span class="c1">/// @dev Emitted when a proposal is created
</span>    <span class="c1">/// @param signatures  Array of empty strings; for compatibility with OpenZeppelin
</span>    <span class="k">event</span> <span class="n">ProposalCreated</span><span class="p">(</span>
        <span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">,</span> <span class="kt">address</span> <span class="n">proposer</span><span class="p">,</span>
        <span class="kt">address</span><span class="p">[]</span> <span class="n">targets</span><span class="p">,</span> <span class="kt">uint256</span><span class="p">[]</span> <span class="n">values</span><span class="p">,</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">signatures</span><span class="p">,</span> <span class="kt">bytes</span><span class="p">[]</span> <span class="n">calldatas</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">voteStart</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">voteEnd</span><span class="p">,</span> <span class="kt">string</span> <span class="n">description</span><span class="p">);</span>

    <span class="c1">/// @dev Emitted when a proposal is canceled
</span>    <span class="k">event</span> <span class="n">ProposalCanceled</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">);</span>

    <span class="c1">/// @dev Emitted when a proposal is queued
</span>    <span class="c1">/// @param eta  The block number where transaction becomes executable.
</span>    <span class="k">event</span> <span class="n">ProposalQueued</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">eta</span><span class="p">);</span>

    <span class="c1">/// @dev Emitted when a proposal is executed
</span>    <span class="k">event</span> <span class="n">ProposalExecuted</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">);</span>

    <span class="c1">/// @dev Emitted when a vote is cast
</span>    <span class="c1">/// @param reason  An empty string; for compatibility with OpenZeppelin
</span>    <span class="k">event</span> <span class="n">VoteCast</span><span class="p">(</span><span class="kt">address</span> <span class="k">indexed</span> <span class="n">voter</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">,</span>
                   <span class="kt">uint8</span> <span class="n">choice</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">votes</span><span class="p">,</span> <span class="kt">string</span> <span class="n">reason</span><span class="p">);</span>

    <span class="c1">/// @dev Emitted when the StakingTracker is changed
</span>    <span class="k">event</span> <span class="n">UpdateStakingTracker</span><span class="p">(</span><span class="kt">address</span> <span class="n">oldAddr</span><span class="p">,</span> <span class="kt">address</span> <span class="n">newAddr</span><span class="p">);</span>

    <span class="c1">/// @dev Emitted when the secretary is changed
</span>    <span class="k">event</span> <span class="n">UpdateSecretary</span><span class="p">(</span><span class="kt">address</span> <span class="n">oldAddr</span><span class="p">,</span> <span class="kt">address</span> <span class="n">newAddr</span><span class="p">);</span>

    <span class="c1">/// @dev Emitted when the AccessRule is changed
</span>    <span class="k">event</span> <span class="n">UpdateAccessRule</span><span class="p">(</span>
        <span class="kt">bool</span> <span class="n">secretaryPropose</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">voterPropose</span><span class="p">,</span>
        <span class="kt">bool</span> <span class="n">secretaryExecute</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">voterExecute</span><span class="p">);</span>

    <span class="c1">/// @dev Emitted when the TimingRule is changed
</span>    <span class="k">event</span> <span class="n">UpdateTimingRule</span><span class="p">(</span>
        <span class="kt">uint256</span> <span class="n">minVotingDelay</span><span class="p">,</span>  <span class="kt">uint256</span> <span class="n">maxVotingDelay</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">minVotingPeriod</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">maxVotingPeriod</span><span class="p">);</span>

    <span class="c1">// mutator functions
</span>
    <span class="c1">/// @dev Create a Proposal
</span>    <span class="c1">/// @param description   Proposal text
</span>    <span class="c1">/// @param targets       List of transaction target addresses
</span>    <span class="c1">/// @param values        List of KLAY values to send along with transactions
</span>    <span class="c1">/// @param calldatas     List of transaction calldatas
</span>    <span class="c1">/// @param votingDelay   Delay from proposal submission to voting start in block numbers
</span>    <span class="c1">/// @param votingPeriod  Duration of the voting in block numbers
</span>    <span class="k">function</span> <span class="n">propose</span><span class="p">(</span>
        <span class="kt">string</span> <span class="k">memory</span> <span class="n">description</span><span class="p">,</span>
        <span class="kt">address</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">targets</span><span class="p">,</span>
        <span class="kt">uint256</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">values</span><span class="p">,</span>
        <span class="kt">bytes</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">calldatas</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">votingDelay</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">votingPeriod</span>
    <span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">);</span>

    <span class="c1">/// @dev Cancel a proposal
</span>    <span class="c1">/// The proposal must be in Pending state
</span>    <span class="c1">/// Only the proposer of the proposal can cancel the proposal.
</span>    <span class="k">function</span> <span class="n">cancel</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="c1">/// @dev Cast a vote to a proposal
</span>    <span class="c1">/// The proposal must be in Active state
</span>    <span class="c1">/// A node can only vote once for a proposal
</span>    <span class="c1">/// choice must be one of VoteChoice.
</span>    <span class="k">function</span> <span class="n">castVote</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">,</span> <span class="kt">uint8</span> <span class="n">choice</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="c1">/// @dev Queue a passed proposal
</span>    <span class="c1">/// The proposal must be in Passed state
</span>    <span class="c1">/// Current block must be before `queueDeadline` of this proposal
</span>    <span class="c1">/// If secretary is null, any GC with at least 1 vote can queue.
</span>    <span class="c1">/// Otherwise only secretary can queue.
</span>    <span class="k">function</span> <span class="n">queue</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="c1">/// @dev Execute a queued proposal
</span>    <span class="c1">/// The proposal must be in Queued state
</span>    <span class="c1">/// Current block must be after `eta` and before `execDeadline` of this proposal
</span>    <span class="c1">/// If secretary is null, any GC with at least 1 vote can execute.
</span>    <span class="c1">/// Otherwise only secretary can execute.
</span>    <span class="k">function</span> <span class="n">execute</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">)</span> <span class="k">external</span> <span class="k">payable</span><span class="p">;</span>

    <span class="c1">/// @dev Update the StakingTracker address
</span>    <span class="c1">/// Should not be called if there is an active proposal
</span>    <span class="k">function</span> <span class="n">updateStakingTracker</span><span class="p">(</span><span class="kt">address</span> <span class="n">newAddr</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="c1">/// @dev Update the secretary account
</span>    <span class="k">function</span> <span class="n">updateSecretary</span><span class="p">(</span><span class="kt">address</span> <span class="n">newAddr</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="c1">/// @dev Update the access rule
</span>    <span class="k">function</span> <span class="n">updateAccessRule</span><span class="p">(</span>
        <span class="kt">bool</span> <span class="n">secretaryPropose</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">voterPropose</span><span class="p">,</span>
        <span class="kt">bool</span> <span class="n">secretaryExecute</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">voterExecute</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="c1">/// @dev Update the timing rule
</span>    <span class="k">function</span> <span class="n">updateTimingRule</span><span class="p">(</span>
        <span class="kt">uint256</span> <span class="n">minVotingDelay</span><span class="p">,</span>  <span class="kt">uint256</span> <span class="n">maxVotingDelay</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">minVotingPeriod</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">maxVotingPeriod</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="c1">// getter functions
</span>
    <span class="k">function</span> <span class="n">stakingTracker</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="kt">address</span><span class="p">);</span>
    <span class="k">function</span> <span class="n">secretary</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="kt">address</span><span class="p">);</span>
    <span class="k">function</span> <span class="n">accessRule</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span>
        <span class="kt">bool</span> <span class="n">secretaryPropose</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">voterPropose</span><span class="p">,</span>
        <span class="kt">bool</span> <span class="n">secretaryExecute</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">voterExecute</span><span class="p">);</span>
    <span class="k">function</span> <span class="n">timingRule</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span>
        <span class="kt">uint256</span> <span class="n">minVotingDelay</span><span class="p">,</span>  <span class="kt">uint256</span> <span class="n">maxVotingDelay</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">minVotingPeriod</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">maxVotingPeriod</span><span class="p">);</span>
    <span class="k">function</span> <span class="n">queueTimeout</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="kt">uint256</span><span class="p">);</span>
    <span class="k">function</span> <span class="n">execDelay</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="kt">uint256</span><span class="p">);</span>
    <span class="k">function</span> <span class="n">execTimeout</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="kt">uint256</span><span class="p">);</span>

    <span class="c1">/// @dev The id of the last created proposal
</span>    <span class="c1">/// Retrurns 0 if there is no proposal.
</span>    <span class="k">function</span> <span class="n">lastProposalId</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="kt">uint256</span><span class="p">);</span>

    <span class="c1">/// @dev State of a proposal
</span>    <span class="k">function</span> <span class="n">state</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="n">ProposalState</span><span class="p">);</span>

    <span class="c1">/// @dev Check if a proposal is passed
</span>    <span class="c1">/// Note that its return value represents the current voting status,
</span>    <span class="c1">/// and is subject to change until the voting ends.
</span>    <span class="k">function</span> <span class="n">checkQuorum</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="kt">bool</span><span class="p">);</span>

    <span class="c1">/// @dev Resolve the voter account into its gcId and voting powers
</span>    <span class="c1">/// Returns the currently assigned gcId. Returns the voting powers
</span>    <span class="c1">/// effective at the given proposal. Returns zero gcId and 0 votes
</span>    <span class="c1">/// if the voter account is not assigned to any eligible GC.
</span>    <span class="c1">///
</span>    <span class="c1">/// @param proposalId  The proposal id
</span>    <span class="c1">/// @return gcId    The gcId assigned to this voter account
</span>    <span class="c1">/// @return votes   The amount of voting powers the voter account represents
</span>    <span class="k">function</span> <span class="n">getVotes</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">,</span> <span class="kt">address</span> <span class="n">voter</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="kt">uint256</span><span class="p">,</span> <span class="kt">uint256</span><span class="p">);</span>

    <span class="c1">/// @dev General contents of a proposal
</span>    <span class="k">function</span> <span class="n">getProposalContent</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span>
        <span class="kt">uint256</span> <span class="n">id</span><span class="p">,</span>
        <span class="kt">address</span> <span class="n">proposer</span><span class="p">,</span>
        <span class="kt">string</span> <span class="k">memory</span> <span class="n">description</span>
    <span class="p">);</span>

    <span class="c1">/// @dev Transactions in a proposal
</span>    <span class="c1">/// @return signatures  Array of empty strings; for compatibility with OpenZeppelin
</span>    <span class="k">function</span> <span class="k">function</span> <span class="n">getActions</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span>
        <span class="kt">address</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">targets</span><span class="p">,</span>
        <span class="kt">uint256</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">values</span><span class="p">,</span>
        <span class="kt">string</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">signatures</span><span class="p">,</span>
        <span class="kt">bytes</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">calldatas</span>
    <span class="p">);</span>

    <span class="c1">/// @dev Timing and state related properties of a proposal
</span>    <span class="k">function</span> <span class="n">getProposalSchedule</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span>
        <span class="kt">uint256</span> <span class="n">voteStart</span><span class="p">,</span>      <span class="c1">// propose()d block + votingDelay
</span>        <span class="kt">uint256</span> <span class="n">voteEnd</span><span class="p">,</span>        <span class="c1">// voteStart + votingPeriod
</span>        <span class="kt">uint256</span> <span class="n">queueDeadline</span><span class="p">,</span>  <span class="c1">// voteEnd + queueTimeout
</span>        <span class="kt">uint256</span> <span class="n">eta</span><span class="p">,</span>            <span class="c1">// queue()d block + execDelay
</span>        <span class="kt">uint256</span> <span class="n">execDeadline</span><span class="p">,</span>   <span class="c1">// queue()d block + execDelay + execTimeout
</span>        <span class="kt">bool</span> <span class="n">canceled</span><span class="p">,</span>          <span class="c1">// true if successfully cancel()ed
</span>        <span class="kt">bool</span> <span class="n">queued</span><span class="p">,</span>            <span class="c1">// true if successfully queue()d
</span>        <span class="kt">bool</span> <span class="n">executed</span>           <span class="c1">// true if successfully execute()d
</span>    <span class="p">);</span>

    <span class="c1">/// @dev Vote counting related properties of a proposal
</span>    <span class="k">function</span> <span class="n">getProposalTally</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span>
        <span class="kt">uint256</span> <span class="n">totalYes</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">totalNo</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">totalAbstain</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">quorumCount</span><span class="p">,</span>      <span class="c1">// required number of voters
</span>        <span class="kt">uint256</span> <span class="n">quorumPower</span><span class="p">,</span>      <span class="c1">// required number of voting powers
</span>        <span class="kt">uint256</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">voters</span><span class="p">,</span>  <span class="c1">// list of gcIds who voted
</span>    <span class="p">)</span>

    <span class="c1">/// @dev Individual vote receipt
</span>    <span class="k">function</span> <span class="n">getReceipt</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">gcId</span><span class="p">)</span>
        <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="n">Receipt</span> <span class="k">memory</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="fetching-votes-from-stakingtracker">Fetching votes from StakingTracker</h4>

<p>Calculating votes requires information from StakingTracker contract. The Voting contract shall utilize the getters to find the voting powers of each voter as well as quorum conditions. Below is an example implementation of <code class="language-plaintext highlighter-rouge">castVote()</code> and <code class="language-plaintext highlighter-rouge">checkQuorum()</code> functions.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">abstract</span> <span class="k">contract</span> <span class="n">Voting</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">Proposal</span> <span class="p">{</span>
        <span class="kt">uint256</span> <span class="n">trackerId</span><span class="p">;</span>  <span class="c1">// StakingTracker trackerId created in propose()
</span>        <span class="kt">uint256</span> <span class="n">totalYes</span><span class="p">;</span>
        <span class="kt">uint256</span> <span class="n">totalNo</span><span class="p">;</span>
        <span class="kt">uint256</span> <span class="n">totalAbstain</span><span class="p">;</span>
        <span class="kt">uint256</span><span class="p">[]</span> <span class="n">voters</span><span class="p">;</span>   <span class="c1">// List of gcIds
</span>        <span class="k">mapping</span><span class="p">(</span><span class="kt">uint256</span> <span class="o">=&gt;</span> <span class="n">Receipt</span><span class="p">)</span> <span class="n">receipts</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">mapping</span><span class="p">(</span><span class="kt">uint256</span> <span class="o">=&gt;</span> <span class="n">Proposal</span><span class="p">)</span> <span class="n">proposals</span><span class="p">;</span>
    <span class="n">IStakingTracker</span> <span class="n">stakingTracker</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">castVote</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">,</span> <span class="kt">uint8</span> <span class="n">choice</span><span class="p">)</span> <span class="k">external</span> <span class="p">{</span>
        <span class="n">Proposal</span> <span class="k">storage</span> <span class="n">p</span> <span class="o">=</span> <span class="n">proposals</span><span class="p">[</span><span class="n">proposalId</span><span class="p">];</span>

        <span class="p">(</span><span class="kt">uint256</span> <span class="n">gcId</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">votes</span><span class="p">)</span> <span class="o">=</span> <span class="n">getVotes</span><span class="p">(</span><span class="n">proposalId</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">);</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">gcId</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"Not a registered voter"</span><span class="p">);</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">votes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"Not eligible to vote"</span><span class="p">);</span>

        <span class="nb">require</span><span class="p">(</span><span class="n">choice</span> <span class="o">==</span> <span class="kt">uint8</span><span class="p">(</span><span class="n">VoteChoice</span><span class="p">.</span><span class="n">Yes</span><span class="p">)</span> <span class="o">||</span>
                <span class="n">choice</span> <span class="o">==</span> <span class="kt">uint8</span><span class="p">(</span><span class="n">VoteChoice</span><span class="p">.</span><span class="n">No</span><span class="p">)</span> <span class="o">||</span>
                <span class="n">choice</span> <span class="o">==</span> <span class="kt">uint8</span><span class="p">(</span><span class="n">VoteChoice</span><span class="p">.</span><span class="n">Abstain</span><span class="p">),</span> <span class="s">"Not a valid choice"</span><span class="p">);</span>
        <span class="nb">require</span><span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">.</span><span class="n">receipts</span><span class="p">[</span><span class="n">gcId</span><span class="p">].</span><span class="n">hasVoted</span><span class="p">,</span> <span class="s">"Already voted"</span><span class="p">);</span>

        <span class="n">p</span><span class="p">.</span><span class="n">receipts</span><span class="p">[</span><span class="n">gcId</span><span class="p">].</span><span class="n">hasVoted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">p</span><span class="p">.</span><span class="n">receipts</span><span class="p">[</span><span class="n">gcId</span><span class="p">].</span><span class="n">choice</span> <span class="o">=</span> <span class="n">choice</span><span class="p">;</span>
        <span class="n">p</span><span class="p">.</span><span class="n">receipts</span><span class="p">[</span><span class="n">gcId</span><span class="p">].</span><span class="n">votes</span> <span class="o">=</span> <span class="n">votes</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">choice</span> <span class="o">==</span> <span class="n">VoteChoice</span><span class="p">.</span><span class="n">Yes</span><span class="p">)</span> <span class="p">{</span> <span class="n">p</span><span class="p">.</span><span class="n">totalYes</span> <span class="o">+=</span> <span class="n">votes</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">choice</span> <span class="o">==</span> <span class="n">VoteChoice</span><span class="p">.</span><span class="n">No</span><span class="p">)</span> <span class="p">{</span> <span class="n">p</span><span class="p">.</span><span class="n">totalNo</span> <span class="o">+=</span> <span class="n">votes</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">choice</span> <span class="o">==</span> <span class="n">VoteChoice</span><span class="p">.</span><span class="n">Abstain</span><span class="p">)</span> <span class="p">{</span> <span class="n">p</span><span class="p">.</span><span class="n">totalAbstain</span> <span class="o">+=</span> <span class="n">votes</span><span class="p">;</span> <span class="p">}</span>
        <span class="n">p</span><span class="p">.</span><span class="n">voters</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">gcId</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getVotes</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">,</span> <span class="kt">address</span> <span class="n">voter</span><span class="p">)</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span>
        <span class="kt">uint256</span> <span class="n">gcId</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">votes</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Proposal</span> <span class="k">storage</span> <span class="n">p</span> <span class="o">=</span> <span class="n">proposals</span><span class="p">[</span><span class="n">proposalId</span><span class="p">];</span>

        <span class="n">gcId</span> <span class="o">=</span> <span class="n">IStakingTracker</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">stakingTracker</span><span class="p">).</span><span class="n">voterToGCId</span><span class="p">(</span><span class="n">voter</span><span class="p">);</span>
        <span class="p">(</span> <span class="p">,</span> <span class="n">votes</span><span class="p">)</span> <span class="o">=</span> <span class="n">IStakingTracker</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">stakingTracker</span><span class="p">).</span><span class="n">getTrackedGC</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">trackerId</span><span class="p">,</span> <span class="n">gcId</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">checkQuorum</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Proposal</span> <span class="k">storage</span> <span class="n">p</span> <span class="o">=</span> <span class="n">proposals</span><span class="p">[</span><span class="n">proposalId</span><span class="p">];</span>

        <span class="p">(</span><span class="kt">uint256</span> <span class="n">quorumCount</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">quorumPower</span><span class="p">)</span> <span class="o">=</span> <span class="n">getQuorum</span><span class="p">(</span><span class="n">proposalId</span><span class="p">);</span>
        <span class="kt">uint256</span> <span class="n">totalVotes</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">totalYes</span> <span class="o">+</span> <span class="n">p</span><span class="p">.</span><span class="n">totalNo</span> <span class="o">+</span> <span class="n">p</span><span class="p">.</span><span class="n">totalAbstain</span><span class="p">;</span>
        <span class="kt">uint256</span> <span class="n">quorumYes</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">totalNo</span> <span class="o">+</span> <span class="n">p</span><span class="p">.</span><span class="n">totalAbstain</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// more than half of all votes
</span>
        <span class="kt">bool</span> <span class="n">countPass</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">voters</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="n">quorumCount</span><span class="p">);</span>
        <span class="kt">bool</span> <span class="n">powerPass</span> <span class="o">=</span> <span class="p">(</span><span class="n">totalVotes</span>      <span class="o">&gt;=</span> <span class="n">quorumPower</span><span class="p">);</span>
        <span class="kt">bool</span> <span class="n">approval</span>  <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">totalYes</span>      <span class="o">&gt;=</span> <span class="n">quorumYes</span><span class="p">);</span>

        <span class="k">return</span> <span class="p">((</span><span class="n">countPass</span> <span class="o">||</span> <span class="n">powerPass</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">approval</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// @dev Calculate count and power quorums for a proposal
</span>    <span class="k">function</span> <span class="n">getQuorum</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">)</span> <span class="k">private</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span>
        <span class="kt">uint256</span> <span class="n">quorumCount</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">quorumPower</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">Proposal</span> <span class="k">storage</span> <span class="n">p</span> <span class="o">=</span> <span class="n">proposals</span><span class="p">[</span><span class="n">proposalId</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">quorumCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// return cached numbers
</span>            <span class="k">return</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">quorumCount</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">quorumPower</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="p">(</span> <span class="p">,</span> <span class="p">,</span> <span class="p">,</span> <span class="kt">uint256</span> <span class="n">totalVotes</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">numEligible</span><span class="p">)</span> <span class="o">=</span>
            <span class="n">IStakingTracker</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">stakingTracker</span><span class="p">).</span><span class="n">getTrackerSummary</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">trackerId</span><span class="p">);</span>

        <span class="n">quorumCount</span> <span class="o">=</span> <span class="p">(</span><span class="n">numEligible</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span> <span class="c1">// more than or equal to 1/3 of all GC members
</span>        <span class="n">quorumPower</span> <span class="o">=</span> <span class="p">(</span><span class="n">totalVotes</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span> <span class="c1">// more than or equal to 1/3 of all voting powers
</span>        <span class="k">return</span> <span class="p">(</span><span class="n">quorumCount</span><span class="p">,</span> <span class="n">quorumPower</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="determining-state">Determining state</h4>

<p>The state of a proposal can be determined from stored variables, vote counts, and current block number. Below is an example implementation of <code class="language-plaintext highlighter-rouge">state()</code> function.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">abstract</span> <span class="k">contract</span> <span class="n">Voting</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">Proposal</span> <span class="p">{</span>
        <span class="kt">uint256</span> <span class="n">voteStart</span><span class="p">;</span>      <span class="c1">// propose()d block + votingDelay
</span>        <span class="kt">uint256</span> <span class="n">voteEnd</span><span class="p">;</span>        <span class="c1">// voteStart + votingPeriod
</span>        <span class="kt">uint256</span> <span class="n">queueDeadline</span><span class="p">;</span>  <span class="c1">// voteEnd + queueTimeout
</span>        <span class="kt">uint256</span> <span class="n">eta</span><span class="p">;</span>            <span class="c1">// queue()d block + execDelay
</span>        <span class="kt">uint256</span> <span class="n">execDeadline</span><span class="p">;</span>   <span class="c1">// queue()d block + execDelay + execTimeout
</span>        <span class="kt">bool</span> <span class="n">canceled</span><span class="p">;</span>          <span class="c1">// true if successfully cancel()ed
</span>        <span class="kt">bool</span> <span class="n">queued</span><span class="p">;</span>            <span class="c1">// true if successfully queue()d
</span>        <span class="kt">bool</span> <span class="n">executed</span><span class="p">;</span>          <span class="c1">// true if successfully execute()d
</span>    <span class="p">}</span>
    <span class="k">mapping</span><span class="p">(</span><span class="kt">uint256</span> <span class="o">=&gt;</span> <span class="n">Proposal</span><span class="p">)</span> <span class="n">proposals</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">state</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="n">ProposalState</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Proposal</span> <span class="k">storage</span> <span class="n">p</span> <span class="o">=</span> <span class="n">proposals</span><span class="p">[</span><span class="n">proposalId</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">executed</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">ProposalState</span><span class="p">.</span><span class="n">Executed</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">canceled</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">ProposalState</span><span class="p">.</span><span class="n">Canceled</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="n">number</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">.</span><span class="n">voteStart</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">ProposalState</span><span class="p">.</span><span class="n">Pending</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="n">number</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="p">.</span><span class="n">voteEnd</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">ProposalState</span><span class="p">.</span><span class="n">Active</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">checkQuorum</span><span class="p">(</span><span class="n">proposalId</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">ProposalState</span><span class="p">.</span><span class="n">Failed</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">.</span><span class="n">queued</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// A proposal without an action does not expire
</span>            <span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="n">number</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="p">.</span><span class="n">queueDeadline</span> <span class="o">||</span> <span class="n">p</span><span class="p">.</span><span class="n">targets</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">ProposalState</span><span class="p">.</span><span class="n">Passed</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">ProposalState</span><span class="p">.</span><span class="n">Expired</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="n">number</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="p">.</span><span class="n">execDeadline</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">ProposalState</span><span class="p">.</span><span class="n">Queued</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">ProposalState</span><span class="p">.</span><span class="n">Expired</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="executing-transactions">Executing transactions</h4>

<p>The transactions in a passed proposal are executed in the order they appear in the <code class="language-plaintext highlighter-rouge">propose()</code> function arguments.  Each transaction is sent to <code class="language-plaintext highlighter-rouge">targets[i]</code>, carrying <code class="language-plaintext highlighter-rouge">values[i]</code> of KLAYs, with <code class="language-plaintext highlighter-rouge">calldatas[i]</code> as input data. Below is an example of <code class="language-plaintext highlighter-rouge">execute()</code> function.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">abstract</span> <span class="k">contract</span> <span class="n">Voting</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">Proposal</span> <span class="p">{</span>
        <span class="kt">address</span><span class="p">[]</span> <span class="n">targets</span><span class="p">;</span>
        <span class="kt">uint256</span><span class="p">[]</span> <span class="n">values</span><span class="p">;</span>
        <span class="kt">bytes</span><span class="p">[]</span> <span class="n">calldatas</span><span class="p">;</span>

    <span class="p">}</span>
    <span class="k">mapping</span><span class="p">(</span><span class="kt">uint256</span> <span class="o">=&gt;</span> <span class="n">Proposal</span><span class="p">)</span> <span class="n">proposals</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">execute</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">)</span> <span class="k">external</span> <span class="k">payable</span> <span class="p">{</span>
        <span class="n">Proposal</span> <span class="k">storage</span> <span class="n">p</span> <span class="o">=</span> <span class="n">proposals</span><span class="p">[</span><span class="n">proposalId</span><span class="p">];</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">.</span><span class="n">targets</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">result</span><span class="p">)</span> <span class="o">=</span>
                    <span class="n">p</span><span class="p">.</span><span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nb">call</span><span class="p">{</span><span class="n">value</span><span class="o">:</span> <span class="n">p</span><span class="p">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]}(</span><span class="n">p</span><span class="p">.</span><span class="n">calldatas</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            <span class="nb">require</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s">"Transaction failed"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="example-implementation-2">Example implementation</h4>

<p>See <a href="https://github.com/klaytn/governance-contracts-audit/blob/main/contracts/Voting.sol">here</a> for an example implementation.</p>

<h2 id="rationale">Rationale</h2>

<h4 id="cnstakingv2-and-stakingtracker-instead-of-standard-erc20votes">CnStakingV2 and StakingTracker instead of standard ERC20Votes</h4>

<p>It is common for DAOs to manage their governance tokens in an <a href="https://docs.openzeppelin.com/contracts/4.x/api/token/erc20#ERC20Votes">ERC20Votes</a> contract. However new contracts CnStakingV2 and StakingTracker were used to manage staked KLAYs. Using the new contracts provides better compatibility with ecosystem Dapps like public staking services. It also does not break the existing block validator selection algorithm that depends on AddressBook.</p>

<h4 id="stakingtracker-refreshstake-and-refreshvoting-has-no-access-control">StakingTracker refreshStake and refreshVoting has no access control</h4>

<p>It is a remnant of a previous design. Those functions were originally intended to allow optionally or gradually migrate from CnStakingContract to CnStakingV2 contracts. Now that old CnStakingContract are excluded from the voting power calculation, such a feature is unnecessary but the refreshStake and refreshVoter functions retain its shape.</p>

<h4 id="separate-voter-account">Separate voter account</h4>

<p>In a security standpoint, it is safer to have separate accounts for different roles. Existing CnStakingV2 admins take a financial role - withdrawing staked KLAYs - and the voter account take a voting role only.</p>

<h4 id="proposals-have-expired-state">Proposals have expired state</h4>

<p>Proposal transactions expire if they are not queued or executed within the deadline. This guarantees the timeliness of the transactions. If a proposal was left unexecuted for a long time, the proposal might be irrelevant anymore and require a fresh proposal.</p>

<h2 id="expected-effect">Expected Effect</h2>

<p>The proposed GC Voting method is expected to produce the following changes:</p>
<ul>
  <li>All members in the Klaytn ecosystem grow together with credibility</li>
  <li>Providing obligation and authority to GC motivates active participation in governance voting activities and the KLAY staking</li>
  <li>Anyone can easily view the proposals and voting status through the governance portal. It encourages holders to participate and give responsibility and authority to GCs.</li>
  <li>The Klaytn network can take a step closer to transparency and decentralized networks.</li>
</ul>

<h2 id="backward-compatibility">Backward Compatibility</h2>

<ul>
  <li>GCs should deploy new CnStakingV2 contracts and move their staked KLAYs. Existing CnStakingContract (i.e. V1) balances are excluded from voting power calculation.</li>
  <li>However, block validator selection is not affected by the change, so GCs can still participate in consensus before migrating to CnStakingV2.</li>
</ul>

<h2 id="reference">Reference</h2>
<p>n/a</p>

<h2 id="copyright">Copyright</h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.2.3/mermaid.min.js" integrity="sha512-M4zmdILgXOwrBEVfpVqdO/jC3BJZQzlXHeu967v41/QoT60sESWSLbi7YwntTbYC0ZjewfTbvXO8iKj7amvQow==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  mermaid.initialize({
    startOnLoad: true,
  });
  mermaid.run({
    querySelector: '.language-mermaid', // markdown 'mermaid' language code blocks
  });
</script>


</div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Kaia Improvement Proposals</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Kaia Improvement Proposals</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/kaiachain/KIPs"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">kaiachain/KIPs</span></a></li><li><a href="https://twitter.com/kaiachain"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">kaiachain</span></a></li><li><a href="https://www.facebook.com/kaiachain"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#facebook"></use></svg> <span class="username">kaiachain</span></a></li><li><a href="https://medium.com/kaiachain"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#medium"></use></svg> <span class="username">kaiachain</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Kaia Improvement Proposals (KIPs) describe standards for the Kaia platform, including core protocol specifications, client APIs, and contract standards.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

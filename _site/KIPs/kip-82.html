<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
    <title>KIP 82: A new GC reward structure due to abolition of the Gini coefficient</title>
    <meta property="og:title" content="KIP 82: A new GC reward structure due to abolition of the Gini coefficient" />
    <meta
      name="description"
      content="Details on Kaia Improvement Proposal 82 (KIP 82): A new GC reward structure due to abolition of the Gini coefficient"
    />
    <meta
      property="og:description"
      content="Details on Kaia Improvement Proposal 82 (KIP 82): A new GC reward structure due to abolition of the Gini coefficient"
    />
    <meta name="twitter:description" content="Details on Kaia Improvement Proposal 82 (KIP 82): A new GC reward structure due to abolition of the Gini coefficient" />
  
  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="http://localhost:4000/KIPs/kip-82" />
  <meta property="og:url" content="http://localhost:4000/KIPs/kip-82" />
  <meta property="og:site_name" content="Kaia Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@kaiachain" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "http://localhost:4000",
      "name": "Kaia Improvement Proposals",
      "description": "Kaia Improvement Proposals (KIPs) describe standards for the Kaia platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Kaia Improvement Proposals" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Kaia Improvement Proposals</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/all">All</a><a class="page-link" href="/core">Core</a><a class="page-link" href="/networking">Networking</a><a class="page-link" href="/storage">Storage</a><a class="page-link" href="/interface">Interface</a><a class="page-link" href="/token">KCT</a><a class="page-link" href="/sdk">SDK</a><a class="page-link" href="/application">Application</a><a class="page-link" href="/meta">Meta</a><a class="page-link" href="/informational">Informational</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="home">
  <h1 class="page-heading">
    KIP 82: A new GC reward structure due to abolition of the Gini coefficient
    <a href="https://github.com/kaiachain/KIPS/blob/main/KIPs/kip-82.md"><svg role="img" aria-label="Source" xmlns="https://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><title>Source</title><path fill-rule="evenodd" d="M9.5 3L8 4.5 11.5 8 8 11.5 9.5 13 14 8 9.5 3zm-5 0L0 8l4.5 5L6 11.5 2.5 8 6 4.5 4.5 3z"/></svg></a>
  </h1>
  <table>
    <tr><th>Author</th><td><a href="mailto:yeriel.lee@krustuniverse.com">Yeri</a>, <a href="mailto:daniel.cc@krustuniverse.com">Daniel</a>, <a href="mailto:aidan.kwon@krustuniverse.com">Aidan</a>, <a href="mailto:ollie.j@krustuniverse.com">Ollie</a>, <a href="mailto:sam.seo@krustuniverse.com">Sam</a>, <a href="mailto:uno.lee@krustuniverse.com">Uno</a>, <a href="mailto:eddie.kim0@krustuniverse.com">Eddie</a></td></tr>
    
    <tr><th>Status</th><td>Draft
    
    </td></tr>
    <tr><th>Type</th><td>Standards Track</td></tr>
    
      <tr><th>Category</th><td>Core</td></tr>
    
    <tr><th>Created</th><td>2022-09-21</td></tr>
    
    
    
    
    
  </table>

  <h2 id="simple-summary">Simple Summary</h2>
<p>A renewal of the Governance Council(GC) reward structure due to abolition of the Gini coefficient.</p>

<h2 id="abstract">Abstract</h2>
<p>In addition to traditional enterprises, Klaytn is expanding the Governance Council (GC) by bringing DAOs in response to the growth of nontraditional entities. Such a change in the GC ecosystem will restructure the entire Klaytn governance structure. Abolishing the current block proposal selection method based on the Gini coefficient and staking quantity, the new reward program alleviates the problem of providing insufficient compensation for the network contribution and block verification due to lack of staking. The instability of certain nodes with high staking amounts can result in poor network stability as a whole. The renewed structure provides 20% of GC rewards to block proposers and the rest to the stakers. This form is to reward the participants for providing network stability with node operation and financial contribution.</p>

<h2 id="motivation">Motivation</h2>
<p>Klaytn has been compensating GC with block proposal rewards based on the quantity of staking and the Gini coefficient. This included rewards incurred by minting and gas fee generated by transactions. As mentioned in the <a href="https://klaytn.foundation/wp-content/themes/klaytn/download/lightpaper.pdf">Klaytn 2.0 Lightpaper</a>, Klaytn is abolishing the Gini coefficient since this measure demotivates members from staking. Discontinuation of the Gini coefficient increases the risk to network stability due to the expanding reliance on certain nodes. This change ultimately calls for the revision of block proposer selection and reward structure. In an effort to enhance individual voting power and promote ultimate decentralization, we aim to accomplish the following changes:</p>
<ul>
  <li>Ameliorate the risk that block creation depends on larger staker nodes</li>
  <li>Associate GC reward with the growth of the Klaytn ecosystem</li>
</ul>

<h2 id="specification">Specification</h2>

<p>Block generation is rewarded for the node operations that are serving as public goods in the Klaytn network. CNs and PNs are in charge of block proposal and propagation while ENs are in charge of blockchain data inquiry based on an individual’s needs. The infrastructure cost remains similar, enabling some fixed benefits. Therefore, fixed compensation will be equivalent to the sum of the transaction fee and an additional block compensation, which can be both inflationary and deflationary.</p>

<p>The block proposal method will be based on equal selection regardless of the staking amount. The current model provides a block generation reward based on staking amount and the Gini-coefficient. Until now, the Gini coefficient was utilized to alleviate the chance of an entity with more staking amount being selected as a block proposer. As this model provided a fairly equal chance to every participant, each node was promised a certain amount of rewards.</p>

<p>In the new method, the reward for node operation is required since the staking amount is not considered in the block proposer selection. Therefore, a certain percentage of the total reward amount will be placed as a node operation reward.</p>

<p>Node operators will also be compensated with the staking for enhancing network stability from an economic standpoint. The opportunity cost incurred from staking is rewarded based on inflation. In this system, inflation provides a tax-like common effect. Public users can also participate and receive rewards through the GC-run public staking program.</p>

<p>As of September 21st, 2022, of the 300 million KLAY that is minted annually, only 100 million KLAY goes to GC. The renewal separates GC reward into two components: block proposer reward and staking reward. The block proposer reward is compensating for node operation by providing 20% of the GC reward and 100% of gas fee resources from transactions. The staking reward is from 80% of the GC reward and is distributed based on GC staking amounts.</p>

<p>The relative ratio of 20% and 80% is a tentative value to be used in the Cypress mainnet. However, this ratio is defined as a governance paramter, so GC members can change the ratio through the governance process.</p>

<p><img src="/assets/kip-82/gc_reward_allocation.png" alt="gc reward allocation" /></p>

<p>After the Magma hard fork, Klaytn has been burning the first half of the gas fee based on <a href="https://kips.klaytn.foundation/KIPs/kip-71">the KIP-71 proposal</a> while the second half is distributed. The second half is distributed into GC reward, KGF and KIR.</p>

<p>In addition to changing the reward structure, this renewal will include burning the gas fee up to a threshold which is the size of block proposer reward. If the gas fee exceeds the threshold, remaining amount is rewarded to the block proposer. The KGF and KIR portion will be excluded from the gas fee.</p>

<h3 id="klaytn-node-update">Klaytn node update</h3>

<p>The Klaytn node will be updated according to the new reward policy. The CN reward is further split into proposer reward and staking reward. The staking reward is distributed among CNs proportionally to their staking amounts minus the minimum staking amount.</p>

<p>A new governance parameter is introduced to tune the new reward distribution algorithm. The initial value below will be used in the Cypress mainnet when KIP-82 is first applied. The parameter can be updated using the existing governance mechanism.</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Meaning</th>
      <th>Initial Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">reward.kip82ratio</code></td>
      <td>string</td>
      <td>The relative ratio between proposer and staking rewards</td>
      <td>“20/80”</td>
    </tr>
  </tbody>
</table>

<p>During integer arithmetics, minuscule remaining amounts may be emitted as by-products. The proposer gets the remainder from the staking share disribution, and KGF gets the the remainder from the distribution among proposer, stakers, KIR, KGF.</p>

<p>Below pseudocode illustrates the new reward distribution algorithm. Note: <code class="language-plaintext highlighter-rouge">//</code> is round down integer division.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="n">MAGMA_BLOCK_NUMBER</span> <span class="o">=</span> <span class="mi">99841497</span>
<span class="n">KORE_BLOCK_NUMBER</span> <span class="o">=</span> <span class="mi">120000000</span> <span class="c1"># TBD
</span>
<span class="c1"># Block header. Only relevant fields are shown here.
</span><span class="k">class</span> <span class="nc">Header</span><span class="p">:</span>
    <span class="n">Number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># Block number
</span>    <span class="n">GasUsed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Total gas spent in the block
</span>    <span class="n">BaseFee</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Base fee per gas at the block
</span>    <span class="n">RewardBase</span><span class="p">:</span> <span class="n">string</span> <span class="o">=</span> <span class="s">""</span> <span class="c1"># Reward recipient address of the block proposer
</span>
<span class="c1"># Network configurations related to reward distribution.
# Corresponds to Klaytn's reward.rewardConfig struct.
</span><span class="k">class</span> <span class="nc">RewardConfig</span><span class="p">:</span>
    <span class="c1"># "istanbul.policy" parameter
</span>    <span class="n">RoundRobin</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Sticky</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">WeightedRandom</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">ProposerPolicy</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">WeightedRandom</span>

    <span class="n">UnitPrice</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25000000000</span>              <span class="c1"># "governance.unitprice" parameter (in peb)
</span>    <span class="n">MintingAmount</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">9600000000000000000</span>  <span class="c1"># "reward.mintingamount" parameter (in peb)
</span>    <span class="n">MinimumStake</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000000</span>               <span class="c1"># "reward.minimumstake" parameter (in KLAY)
</span>    <span class="n">DeferredTxFee</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>                <span class="c1"># "reward.deferredtxfee" parameter
</span>
    <span class="c1"># "reward.ratio" parameter (e.g. "50/40/10")
</span>    <span class="n">CnRatio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">KgfRatio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span>
    <span class="n">KirRatio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">TotalRatio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">CnRatio</span> <span class="o">+</span> <span class="n">KgfRatio</span> <span class="o">+</span> <span class="n">KirRatio</span>

    <span class="c1"># "reward.kip82ratio" parameter (e.g. "20/80") (new)
</span>    <span class="n">CnProposerRatio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">CnStakingRatio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">80</span>
    <span class="n">CnTotalRatio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">CnProposerRatio</span> <span class="o">+</span> <span class="n">CnStakingRatio</span>

<span class="c1"># CN staking status and KGF/KIR addresses.
# Corresponds to Klaytn's reward.StakingInfo struct.
# Can be obtained from reward.GetStakingInfo(blockNum) function.
</span><span class="k">class</span> <span class="nc">StakingInfo</span><span class="p">:</span>
    <span class="n">KIRAddr</span><span class="p">:</span> <span class="n">string</span> <span class="o">=</span> <span class="s">""</span>
    <span class="n">KGFAddr</span><span class="p">:</span> <span class="n">string</span> <span class="o">=</span> <span class="s">""</span>
    <span class="n">Nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConsolidatedNode</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Staking information merged under the same CN.
# Sometimes a node would register multiple NodeAddrs
# in which each entry has a different StakingAddr and the same RewardAddr.
# We treat those entries with common RewardAddr as one node.
# Corresponds to Klaytn's reward.ConsolidatedNode struct.
</span><span class="k">class</span> <span class="nc">ConsolidatedNode</span><span class="p">:</span>
    <span class="n">NodeAddrs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">string</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">StakingAddrs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">string</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">RewardAddr</span><span class="p">:</span> <span class="n">string</span> <span class="o">=</span> <span class="s">""</span> <span class="c1"># The common reward address of the CN
</span>    <span class="n">StakingAmount</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Total staking amount across StakingAddrs (in KLAY)
</span>
<span class="c1"># Reward distribution details.
</span><span class="k">class</span> <span class="nc">RewardSpec</span><span class="p">:</span>
    <span class="n">Minted</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># The amount newly minted
</span>    <span class="n">TotalFee</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Total tx fee spent
</span>    <span class="n">BurntFee</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># The amount burnt
</span>    <span class="n">Proposer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># The amount allocated to the block proposer
</span>    <span class="n">Stakers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Total amount allocated to stakers
</span>    <span class="n">Kgf</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>      <span class="c1"># The amount allocated to KGF
</span>    <span class="n">Kir</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>      <span class="c1"># The amount allocated to KIR
</span>    <span class="n">Rewards</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">string</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Mapping from reward recipient to amounts
</span>
<span class="c1"># Perform post-transaction state modifications such as block rewards.
# Corresponds to Klaytn's consensus/istanbul/backend.Finalize()
#
# - state is the StateDB to apply the rewards.
# - header is a Header instance.
# - config is a RewardConfig instance.
</span><span class="k">def</span> <span class="nf">finalize_block</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">.</span><span class="n">ProposerPolicy</span> <span class="ow">in</span> <span class="p">[</span><span class="n">RoundRobin</span><span class="p">,</span> <span class="n">Sticky</span><span class="p">]:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">calc_deferred_reward_simple</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">calc_deferred_reward</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">addr</span><span class="p">,</span> <span class="n">amount</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">.</span><span class="n">Rewards</span><span class="p">:</span>
        <span class="n">state</span><span class="p">.</span><span class="n">AddBalance</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
    <span class="n">header</span><span class="p">.</span><span class="n">Root</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">Root</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">calc_deferred_reward_simple</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">minted</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">MintingAmount</span>

    <span class="n">total_fee</span> <span class="o">=</span> <span class="n">get_total_fee</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">header</span><span class="p">.</span><span class="n">Number</span> <span class="o">&gt;=</span> <span class="n">KORE_BLOCK_NUMBER</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="p">.</span><span class="n">DeferredTxFee</span><span class="p">:</span>
        <span class="n">total_fee</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">reward_fee</span> <span class="o">=</span> <span class="n">total_fee</span>
    <span class="n">burnt_fee</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">header</span><span class="p">.</span><span class="n">Number</span> <span class="o">&gt;=</span> <span class="n">MAGMA_BLOCK_NUMBER</span><span class="p">:</span>
        <span class="n">burn_amount</span> <span class="o">=</span> <span class="n">get_burn_amount_magma</span><span class="p">(</span><span class="n">reward_fee</span><span class="p">)</span>
        <span class="n">reward_fee</span> <span class="o">-=</span> <span class="n">burn_amount</span>
        <span class="n">burnt_fee</span> <span class="o">+=</span> <span class="n">burn_amount</span>

    <span class="n">proposer</span> <span class="o">=</span> <span class="n">minted</span> <span class="o">+</span> <span class="n">reward_fee</span>

    <span class="n">spec</span> <span class="o">=</span> <span class="n">RewardSpec</span><span class="p">()</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">Minted</span> <span class="o">=</span> <span class="n">minted</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">TotalFee</span> <span class="o">=</span> <span class="n">total_fee</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">BurntFee</span> <span class="o">=</span> <span class="n">burnt_fee</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">Proposer</span> <span class="o">=</span> <span class="n">proposer</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">Rewards</span> <span class="o">=</span> <span class="p">{</span><span class="n">header</span><span class="p">.</span><span class="n">RewardBase</span><span class="p">:</span> <span class="n">proposer</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">spec</span>

<span class="c1"># Calculates the deferred rewards, which are determined at the end of block processing.
# Used in reward distribution.
# Returns a RewardSpec.
</span><span class="k">def</span> <span class="nf">calc_deferred_reward</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">staking_info</span> <span class="o">=</span> <span class="n">GetStakingInfo</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">Number</span><span class="p">)</span>
    <span class="n">minted</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">MintingAmount</span>
    <span class="n">total_fee</span><span class="p">,</span> <span class="n">reward_fee</span><span class="p">,</span> <span class="n">burnt_fee</span> <span class="o">=</span> <span class="n">calc_deferred_fee</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="n">proposer</span><span class="p">,</span> <span class="n">stakers</span><span class="p">,</span> <span class="n">kgf</span><span class="p">,</span> <span class="n">kir</span><span class="p">,</span> <span class="n">split_rem</span> <span class="o">=</span> <span class="n">calc_split</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">minted</span><span class="p">,</span> <span class="n">reward_fee</span><span class="p">)</span>
    <span class="n">shares</span><span class="p">,</span> <span class="n">share_rem</span> <span class="o">=</span> <span class="n">calc_shares</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">staking_info</span><span class="p">,</span> <span class="n">stakers</span><span class="p">)</span>

    <span class="c1"># Remainder from (CN, KGF, KIR) split goes to KGF
</span>    <span class="n">kgf</span> <span class="o">+=</span> <span class="n">split_rem</span>
    <span class="c1"># Remainder from staker shares goes to Proposer
</span>    <span class="n">proposer</span> <span class="o">+=</span> <span class="n">share_rem</span>

    <span class="c1"># If KGF or KIR address is not set, proposer gets the portion.
</span>    <span class="k">if</span> <span class="n">staking_info</span><span class="p">.</span><span class="n">KGFAddr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">proposer</span> <span class="o">+=</span> <span class="n">kgf</span>
        <span class="n">kgf</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">staking_info</span><span class="p">.</span><span class="n">KIRAddr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">proposer</span> <span class="o">+=</span> <span class="n">kir</span>
        <span class="n">kir</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">spec</span> <span class="o">=</span> <span class="n">RewardSpec</span><span class="p">()</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">Minted</span> <span class="o">=</span> <span class="n">minted</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">TotalFee</span> <span class="o">=</span> <span class="n">total_fee</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">BurntFee</span> <span class="o">=</span> <span class="n">burnt_fee</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">Proposer</span> <span class="o">=</span> <span class="n">proposer</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">Stakers</span> <span class="o">=</span> <span class="n">stakers</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">Kgf</span> <span class="o">=</span> <span class="n">kgf</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">Kir</span> <span class="o">=</span> <span class="n">kir</span>

    <span class="n">spec</span><span class="p">.</span><span class="n">Rewards</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">Rewards</span><span class="p">[</span><span class="n">header</span><span class="p">.</span><span class="n">RewardBase</span><span class="p">]</span> <span class="o">+=</span> <span class="n">proposer</span>
    <span class="k">if</span> <span class="n">staking_info</span><span class="p">.</span><span class="n">KGFAddr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">spec</span><span class="p">.</span><span class="n">Rewards</span><span class="p">[</span><span class="n">staking_info</span><span class="p">.</span><span class="n">KGFAddr</span><span class="p">]</span> <span class="o">+=</span> <span class="n">kgf</span>
    <span class="k">if</span> <span class="n">staking_info</span><span class="p">.</span><span class="n">KIRAddr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">spec</span><span class="p">.</span><span class="n">Rewards</span><span class="p">[</span><span class="n">staking_info</span><span class="p">.</span><span class="n">KIRAddr</span><span class="p">]</span> <span class="o">+=</span> <span class="n">kir</span>
    <span class="k">for</span> <span class="n">reward_addr</span><span class="p">,</span> <span class="n">reward_amount</span> <span class="ow">in</span> <span class="n">shares</span><span class="p">:</span>
        <span class="n">spec</span><span class="p">.</span><span class="n">Rewards</span><span class="p">[</span><span class="n">reward_addr</span><span class="p">]</span> <span class="o">+=</span> <span class="n">reward_amount</span>

    <span class="k">return</span> <span class="n">spec</span>

<span class="c1"># Returns (total_fee, reward_fee, burnt_fee)
</span><span class="k">def</span> <span class="nf">calc_deferred_fee</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="c1"># If not DeferredTxFee, fees are already added to the proposer during TX execution.
</span>    <span class="c1"># Therefore, there are no fees to distribute here at the end of block processing.
</span>    <span class="c1"># However, the fees must be compensated to calculate actual rewards paid.
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">.</span><span class="n">DeferredTxFee</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Start with the total block gas fee
</span>    <span class="n">total_fee</span> <span class="o">=</span> <span class="n">get_total_fee</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="n">reward_fee</span> <span class="o">=</span> <span class="n">total_fee</span>
    <span class="n">burnt_fee</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Since Magma, burn half of gas
</span>    <span class="k">if</span> <span class="n">header</span><span class="p">.</span><span class="n">number</span> <span class="o">&gt;=</span> <span class="n">MAGMA_BLOCK_NUMBER</span><span class="p">:</span>
        <span class="n">burn_amount</span> <span class="o">=</span> <span class="n">get_burn_amount_magma</span><span class="p">(</span><span class="n">reward_fee</span><span class="p">)</span>
        <span class="n">reward_fee</span> <span class="o">-=</span> <span class="n">burn_amount</span>
        <span class="n">burnt_fee</span> <span class="o">+=</span> <span class="n">burn_amount</span>

    <span class="c1"># If KIP-82 is enabled, burn fees up to proposer's minted reward
</span>    <span class="k">if</span> <span class="n">header</span><span class="p">.</span><span class="n">number</span> <span class="o">&gt;=</span> <span class="n">KORE_BLOCK_NUMBER</span><span class="p">:</span>
        <span class="n">burn_amount</span> <span class="o">=</span> <span class="n">get_burn_amount_kip82</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">reward_fee</span><span class="p">)</span>
        <span class="n">reward_fee</span> <span class="o">-=</span> <span class="n">burn_amount</span>
        <span class="n">burnt_fee</span> <span class="o">+=</span> <span class="n">burn_amount</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">total_fee</span><span class="p">,</span> <span class="n">reward_fee</span><span class="p">,</span> <span class="n">burnt_fee</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_total_fee</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">header</span><span class="p">.</span><span class="n">number</span> <span class="o">&gt;=</span> <span class="n">MAGMA_BLOCK_NUMBER</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">header</span><span class="p">.</span><span class="n">GasUsed</span> <span class="o">*</span> <span class="n">header</span><span class="p">.</span><span class="n">BaseFee</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">header</span><span class="p">.</span><span class="n">GasUsed</span> <span class="o">*</span> <span class="n">config</span><span class="p">.</span><span class="n">UnitPrice</span>

<span class="k">def</span> <span class="nf">get_burn_amount_magma</span><span class="p">(</span><span class="n">fee</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">fee</span> <span class="o">/</span> <span class="mi">2</span>

<span class="k">def</span> <span class="nf">get_burn_amount_kip82</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">fee</span><span class="p">):</span>
    <span class="n">cn</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">split_by_ratio</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">MintingAmount</span><span class="p">)</span>
    <span class="n">proposer</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">split_by_kip82_ratio</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">cn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fee</span> <span class="o">&gt;=</span> <span class="n">proposer</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">proposer</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fee</span>

<span class="c1"># Returns (proposer, stakers, kgf, kir, remaining) amounts
# The sum of output must be equal to (minted + reward_fee).
</span><span class="k">def</span> <span class="nf">calc_split</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">minted</span><span class="p">,</span> <span class="n">reward_fee</span><span class="p">):</span>
    <span class="n">total_resource</span> <span class="o">=</span> <span class="n">minted</span> <span class="o">+</span> <span class="n">reward_fee</span>

    <span class="k">if</span> <span class="n">header</span><span class="p">.</span><span class="n">number</span> <span class="o">&gt;=</span> <span class="n">KORE_BLOCK_NUMBER</span><span class="p">:</span>
        <span class="n">cn</span><span class="p">,</span> <span class="n">kgf</span><span class="p">,</span> <span class="n">kir</span> <span class="o">=</span> <span class="n">split_by_ratio</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">minted</span><span class="p">)</span>
        <span class="n">proposer</span><span class="p">,</span> <span class="n">stakers</span> <span class="o">=</span> <span class="n">split_by_kip82_ratio</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">cn</span><span class="p">)</span>
        <span class="n">proposer</span> <span class="o">+=</span> <span class="n">reward_fee</span>

        <span class="n">remaining</span> <span class="o">=</span> <span class="n">total_resource</span> <span class="o">-</span> <span class="n">kgf</span> <span class="o">-</span> <span class="n">kir</span> <span class="o">-</span> <span class="n">proposer</span> <span class="o">-</span> <span class="n">stakers</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">proposer</span><span class="p">,</span> <span class="n">stakers</span><span class="p">,</span> <span class="n">kgf</span><span class="p">,</span> <span class="n">kir</span><span class="p">,</span> <span class="n">remaining</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cn</span><span class="p">,</span> <span class="n">kgf</span><span class="p">,</span> <span class="n">kir</span> <span class="o">=</span> <span class="n">split_by_ratio</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">minted</span> <span class="o">+</span> <span class="n">reward_fee</span><span class="p">)</span>

        <span class="n">remaining</span> <span class="o">=</span> <span class="n">total_resource</span> <span class="o">-</span> <span class="n">kgf</span> <span class="o">-</span> <span class="n">kir</span> <span class="o">-</span> <span class="n">cn</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">cn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kgf</span><span class="p">,</span> <span class="n">kir</span><span class="p">,</span> <span class="n">remaining</span><span class="p">)</span>

<span class="c1"># Split by `ratio`. Ignore remaining amounts.
</span><span class="k">def</span> <span class="nf">split_by_ratio</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
    <span class="n">cn</span> <span class="o">=</span> <span class="n">source</span> <span class="o">*</span> <span class="n">config</span><span class="p">.</span><span class="n">CnRatio</span> <span class="o">//</span> <span class="n">config</span><span class="p">.</span><span class="n">TotalRatio</span>
    <span class="n">kgf</span> <span class="o">=</span> <span class="n">source</span> <span class="o">*</span> <span class="n">config</span><span class="p">.</span><span class="n">KgfRatio</span> <span class="o">//</span> <span class="n">config</span><span class="p">.</span><span class="n">TotalRatio</span>
    <span class="n">kir</span> <span class="o">=</span> <span class="n">source</span> <span class="o">*</span> <span class="n">config</span><span class="p">.</span><span class="n">KirRatio</span> <span class="o">//</span> <span class="n">config</span><span class="p">.</span><span class="n">TotalRatio</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">cn</span><span class="p">,</span> <span class="n">kgf</span><span class="p">,</span> <span class="n">kir</span><span class="p">)</span>

<span class="c1"># Split by `kip82ratio`. Ignore remaining amounts.
</span><span class="k">def</span> <span class="nf">split_by_kip82_ratio</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
    <span class="n">proposer</span> <span class="o">=</span> <span class="n">source</span> <span class="o">*</span> <span class="n">config</span><span class="p">.</span><span class="n">CnProposerRatio</span> <span class="o">//</span> <span class="n">config</span><span class="p">.</span><span class="n">CnTotalRatio</span>
    <span class="n">stakers</span> <span class="o">=</span> <span class="n">source</span> <span class="o">*</span> <span class="n">config</span><span class="p">.</span><span class="n">CnStakingRatio</span> <span class="o">//</span> <span class="n">config</span><span class="p">.</span><span class="n">CnTotalRatio</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">proposer</span><span class="p">,</span> <span class="n">stakers</span><span class="p">)</span>

<span class="c1"># Distribute stake_reward among staked CNs
# Returns a mapping from each reward address to their reward shares,
# and the remaining amount.
</span><span class="k">def</span> <span class="nf">calc_shares</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">staking_info</span><span class="p">,</span> <span class="n">stake_reward</span><span class="p">):</span>
    <span class="n">min_stake</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">MinimumStake</span>
    <span class="n">total_stakes</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">staking_info</span><span class="p">.</span><span class="n">Nodes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="n">StakingAmount</span> <span class="o">&gt;</span> <span class="n">min_stake</span><span class="p">:</span>
            <span class="n">total_stakes</span> <span class="o">+=</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">StakingAmount</span> <span class="o">-</span> <span class="n">min_stake</span><span class="p">)</span>

    <span class="n">shares</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="n">stake_reward</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">staking_info</span><span class="p">.</span><span class="n">Nodes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="n">StakingAmount</span> <span class="o">&gt;</span> <span class="n">min_stake</span><span class="p">:</span>
            <span class="n">effective_stake</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">StakingAmount</span> <span class="o">-</span> <span class="n">min_stake</span>
            <span class="n">reward_amount</span> <span class="o">=</span> <span class="n">stake_reward</span> <span class="o">*</span> <span class="n">effective_stake</span> <span class="o">//</span> <span class="n">total_stakes</span>
            <span class="n">remaining</span> <span class="o">-=</span> <span class="n">reward_amount</span>
            <span class="n">shares</span><span class="p">[</span><span class="n">node</span><span class="p">.</span><span class="n">RewardAddr</span><span class="p">]</span> <span class="o">=</span> <span class="n">reward_amount</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">shares</span><span class="p">,</span> <span class="n">remaining</span><span class="p">)</span>
</code></pre></div></div>

<p>The updated algorithm increases the balance of every GC member’s reward account at every block. The performance impact should be reasonable since the number of GC members is significantly smaller than Klaytn’s transaction processing capability.</p>

<h3 id="reward-json-rpc-api">Reward JSON-RPC API</h3>

<p>A new JSON-RPC method should be added to provide historic reward distribution details.</p>

<ul>
  <li>Name: <code class="language-plaintext highlighter-rouge">klay_getRewards</code></li>
  <li>Description: Returns allocation details of reward distribution at the specified block. If the parameter is not set, returns a breakdown of reward distribution at the latest block.</li>
  <li>Parameters
    <ol>
      <li><code class="language-plaintext highlighter-rouge">QUANTITY | TAG</code> - (optional) integer or hexadecimal block number, or the string “earlist” or “latest”.</li>
    </ol>
  </li>
  <li>Returns
    <ul>
      <li><code class="language-plaintext highlighter-rouge">DATA</code>
        <ul>
          <li><code class="language-plaintext highlighter-rouge">minted</code>: The amount minted</li>
          <li><code class="language-plaintext highlighter-rouge">totalFee</code>: Total tx fee spent</li>
          <li><code class="language-plaintext highlighter-rouge">burntFee</code>: The amount burnt</li>
          <li><code class="language-plaintext highlighter-rouge">proposer</code>: The amount for the block proposer</li>
          <li><code class="language-plaintext highlighter-rouge">stakers</code>: Total amount for stakers</li>
          <li><code class="language-plaintext highlighter-rouge">kgf</code>: The amount for KGF</li>
          <li><code class="language-plaintext highlighter-rouge">kir</code>: The amount for KIR</li>
          <li><code class="language-plaintext highlighter-rouge">rewards</code>: A mapping from reward recipient addresses to reward amounts</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Example
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Request
curl -X POST -H "Content-Type: application/json" --data '{"jsonrpc":"2.0", "method":"klay_getRewards", "params":["0x64fe7e0"],"id":1}' https://api.baobab.klaytn.net:8651
// Response
{
  "jsonrpc":"2.0",
  "id":1,
  "result":{
    "minted": "6400000000000000000",
    "totalFee": "1075975000000000",
    "burntFee": "537987500000000",
    "proposer": "3200268993750000000",
    "stakers": "0",
    "kgf": "2560215195000000000",
    "kir": "640053798750000000"
    "rewards": {
      "0xa86fd667c6a340c53cc5d796ba84dbe1f29cb2f7": "3200268993750000000",
      "0x2bcf9d3e4a846015e7e3152a614c684de16f37c6": "2560215195000000000",
      "0x716f89d9bc333286c79db4ebb05516897c8d208a": "640053798750000000"
    }
  }
}
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="expected-effect">Expected Effect</h2>
<p>The proposed GC reward mechanism is expected to produce the following changes:</p>
<ul>
  <li>GC members increase individual staking amount.</li>
  <li>KLAY holders receive profit based on the staking amount of KLAY.</li>
  <li>Total Value Locked (TVL) of Klaytn increases.</li>
  <li>The total circulation reduces.</li>
</ul>

<h2 id="backward-compatibility">Backward Compatibility</h2>
<p>Klaytn nodes must be upgraded before <code class="language-plaintext highlighter-rouge">KORE_BLOCK_NUMBER</code> to correctly produce or verify blocks.</p>

<h2 id="reference">Reference</h2>
<p>n/a</p>

<h2 id="copyright">Copyright</h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.2.3/mermaid.min.js" integrity="sha512-M4zmdILgXOwrBEVfpVqdO/jC3BJZQzlXHeu967v41/QoT60sESWSLbi7YwntTbYC0ZjewfTbvXO8iKj7amvQow==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  mermaid.initialize({
    startOnLoad: true,
  });
  mermaid.run({
    querySelector: '.language-mermaid', // markdown 'mermaid' language code blocks
  });
</script>


</div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Kaia Improvement Proposals</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Kaia Improvement Proposals</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/kaiachain/KIPs"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">kaiachain/KIPs</span></a></li><li><a href="https://twitter.com/kaiachain"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">kaiachain</span></a></li><li><a href="https://www.facebook.com/kaiachain"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#facebook"></use></svg> <span class="username">kaiachain</span></a></li><li><a href="https://medium.com/kaiachain"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#medium"></use></svg> <span class="username">kaiachain</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Kaia Improvement Proposals (KIPs) describe standards for the Kaia platform, including core protocol specifications, client APIs, and contract standards.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
    <title>KIP 103: Treasury Fund Rebalancing</title>
    <meta property="og:title" content="KIP 103: Treasury Fund Rebalancing" />
    <meta
      name="description"
      content="Details on Kaia Improvement Proposal 103 (KIP 103): Treasury Fund Rebalancing"
    />
    <meta
      property="og:description"
      content="Details on Kaia Improvement Proposal 103 (KIP 103): Treasury Fund Rebalancing"
    />
    <meta name="twitter:description" content="Details on Kaia Improvement Proposal 103 (KIP 103): Treasury Fund Rebalancing" />
  
  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="http://localhost:4000/KIPs/kip-103" />
  <meta property="og:url" content="http://localhost:4000/KIPs/kip-103" />
  <meta property="og:site_name" content="Kaia Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@kaiachain" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "http://localhost:4000",
      "name": "Kaia Improvement Proposals",
      "description": "Kaia Improvement Proposals (KIPs) describe standards for the Kaia platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Kaia Improvement Proposals" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Kaia Improvement Proposals</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/all">All</a><a class="page-link" href="/core">Core</a><a class="page-link" href="/networking">Networking</a><a class="page-link" href="/storage">Storage</a><a class="page-link" href="/interface">Interface</a><a class="page-link" href="/token">KCT</a><a class="page-link" href="/sdk">SDK</a><a class="page-link" href="/application">Application</a><a class="page-link" href="/meta">Meta</a><a class="page-link" href="/informational">Informational</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="home">
  <h1 class="page-heading">
    KIP 103: Treasury Fund Rebalancing
    <a href="https://github.com/kaiachain/KIPS/blob/main/KIPs/kip-103.md"><svg role="img" aria-label="Source" xmlns="https://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><title>Source</title><path fill-rule="evenodd" d="M9.5 3L8 4.5 11.5 8 8 11.5 9.5 13 14 8 9.5 3zm-5 0L0 8l4.5 5L6 11.5 2.5 8 6 4.5 4.5 3z"/></svg></a>
  </h1>
  <table>
    <tr><th>Author</th><td><a href="https://github.com/aidan-kwon">Aidan</a>, <a href="https://github.com/toniya-klaytn">Toniya</a>, <a href="https://github.com/blukat29">Ollie</a>, <a href="https://github.com/ian0371">Ian</a></td></tr>
    
      <tr><th>Discussions-To</th><td><a href="https://govforum.klaytn.foundation/t/kgp-6-proposal-to-establish-a-sustainable-and-verifiable-klay-token-economy/157">https://govforum.klaytn.foundation/t/kgp-6-proposal-to-establish-a-sustainable-and-verifiable-klay-token-economy/157</a></td></tr>
    
    <tr><th>Status</th><td>Final
    
    </td></tr>
    <tr><th>Type</th><td>Standards Track</td></tr>
    
      <tr><th>Category</th><td>Core</td></tr>
    
    <tr><th>Created</th><td>2023-02-24</td></tr>
    
    
    
    
    
  </table>

  <h2 id="simple-summary">Simple Summary</h2>

<!--"If you can't explain it simply, you don't understand it well enough." Provide a simplified and layman-accessible explanation of the KIP.-->

<p>This proposal suggests a smart contract interface standard that records the rebalance of treasury funds. The main objective is to facilitate the approval and redistribution of treasury funds to new addresses while keeping record of the the previous fund addresses.</p>

<h2 id="abstract">Abstract</h2>

<!--A short (~200 word) description of the technical issue being addressed.-->

<p>Organizations need to manage treasury funds in a transparent and accountable manner. The proposed standard aims to make the management of treasury funds more transparent by recording the rebalance of treasury funds. The smart contract will keep records of the addresses which hold the treasury funds before and after rebalancing. It also facilates approval before execution.</p>

<h2 id="motivation">Motivation</h2>

<!--The motivation is critical for KIPs that want to change the Klaytn protocol. It should clearly explain why the existing protocol specification is inadequate to address the problem that the KIP solves. KIP submissions without sufficient motivation may be rejected outright.-->

<p>Transparency is the one of most important aspect of blockchain. It is important to ensure that treasury funds are allocated and managed in a transparent and verifiable manner. The proposed smart contract aims to disclose the management of treasury funds in a transparent manner through smart contracts reducing the risk of errors and mismanagement. By providing transparency and accountability in the allocation and management of funds, the smart contract can help to build trust and confidence among stakeholders.</p>

<h2 id="specification">Specification</h2>

<!--The technical specification should describe the syntax and semantics of any new feature. The specification should be detailed enough to allow competing, interoperable implementations for any of the current Klaytn platforms (klaytn). -->

<p>The proposed smart contract will be implemented in Solidity and will be compatible with the Ethereum Virtual Machine (EVM). The smart contract will use Ownable contract to restrict access to certain functions to the owner of the contract.</p>

<p>The smart contract will have the following features:</p>

<ul>
  <li>Register/Remove fund addresses
    <ul>
      <li>Previous fund addresses(Retired): Retired fund represents the previous fund addresses such as KGF or KIR</li>
      <li>New fund addresses(Newbie): Newbie fund represents the ‘rebalanced fund’ such as KCF or KFF</li>
    </ul>
  </li>
  <li>Approve fund addresses and fund allocation. Receive approval for asset transfer from the admins/owners of the funds</li>
  <li>Reset the storage values at any unforeseen circumstances before Finalized</li>
  <li>Finalize the smart contract after execution</li>
</ul>

<h3 id="smart-contracts-overview">Smart Contracts Overview</h3>

<h4 id="enums">Enums</h4>

<p>The smart contract will have the following enum to track the status of the contract:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Initialized - 0</code>: The initial state of the contract.</li>
  <li><code class="language-plaintext highlighter-rouge">Registered - 1</code>: Retirees and Newbies are registered.</li>
  <li><code class="language-plaintext highlighter-rouge">Approved - 2</code>: All retirees approved by msg.sender</li>
  <li><code class="language-plaintext highlighter-rouge">Finalized - 3</code>: Rebalance executed and finalized.</li>
</ul>

<h4 id="life-cycle">Life Cycle</h4>

<p>The contract status should follow the ENUM order above during status transition. The only way to go to previous state is by calling Reset() function.</p>

<p><img src="/assets/kip-103/lifecycle.png" alt="" /></p>

<p>Status transition</p>

<ul>
  <li>Initialized → Registered → Approved → Finalized ✅</li>
  <li>Initialized, Registered, Approved → Initialized, when <code class="language-plaintext highlighter-rouge">reset()</code> is called.</li>
  <li>Registered, Approved → Initialized, when <code class="language-plaintext highlighter-rouge">reset()</code> is called.</li>
</ul>

<p>All other status transitions are not possible.</p>

<h4 id="structs">Structs</h4>

<p>The smart contract will have the following structs:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Retired</code>: to represent the details of retired and approver addresses.
    <ul>
      <li>Retired represents the previous fund addresses such as KGF or KIR</li>
      <li>Approver represents the admin of the retired address. Approver addresses are stored to track the approvals received for asset transfer</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">Newbie</code>: to represent newbies and their fund allocation.
    <ul>
      <li>Newbie represents the ‘rebalanced fund’ such as KCF or KFF</li>
    </ul>
  </li>
</ul>

<h4 id="storage">Storage</h4>

<p>The smart contract will have the following storage variables:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">retirees</code>: array of <code class="language-plaintext highlighter-rouge">Retired</code> struct.</li>
  <li><code class="language-plaintext highlighter-rouge">newbies</code>: array of <code class="language-plaintext highlighter-rouge">Newbie</code> struct.</li>
  <li><code class="language-plaintext highlighter-rouge">status</code>: current status of the contract.</li>
  <li><code class="language-plaintext highlighter-rouge">rebalanceBlockNumber</code>: the target block number of the execution of rebalancing.</li>
  <li><code class="language-plaintext highlighter-rouge">memo</code>: result of the treasury fund rebalance.</li>
</ul>

<h4 id="modifiers">Modifiers</h4>

<p>The smart contract will have the following modifier:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">onlyAtStatus</code>: to restrict access to certain functions based on the current status of the contract. If the status is not the same with the given status, it reverts.</li>
</ul>

<h4 id="constructor">Constructor</h4>

<p>The smart contract will have the following constructor:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">constructor</code>: to initialize the contract with the target block number of the execution of rebalance.</li>
</ul>

<h4 id="state-changing-functions">State Changing Functions</h4>

<p>The smart contract will have the following state changing functions:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">registerRetired</code>: to register retired details. Retired stores the retired address and approvers</li>
  <li><code class="language-plaintext highlighter-rouge">removeRetired</code>: to remove retired details from the array.</li>
  <li><code class="language-plaintext highlighter-rouge">registerNewbie</code>: to register newbie address and its fund distribution.</li>
  <li><code class="language-plaintext highlighter-rouge">removeNewbie</code>: to remove newbie details from the array.</li>
  <li><code class="language-plaintext highlighter-rouge">finalizeRegistration</code>: sets the status to Registered only executed by owner. After this stage, registrations will be restricted.</li>
  <li><code class="language-plaintext highlighter-rouge">approve</code>: to approve a retiredAddress by the admin.</li>
  <li><code class="language-plaintext highlighter-rouge">finalizeApproval</code>: sets the status to Approved. After this stage, approvals will be restricted.
&lt;/br&gt;
<strong>Conditions</strong>
    <ul>
      <li>every retiredAddress must be approved</li>
      <li>min required admin’s approval is done for retired contract address.</li>
      <li>sum of retired’s balance is greater than sum of the newbies’ amount
&lt;/br&gt;</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">reset</code>: resets all storage values to empty objects except rebalanceBlockNumber. It can only be called during Initialization, Registration and Approved status.</li>
  <li><code class="language-plaintext highlighter-rouge">finalizeContract</code>: to record the execution result of the rebalance and finalize the contract. The storage data cannot be modified after this stage.</li>
</ul>

<h4 id="fallback-function">Fallback Function</h4>

<p>The smart contract will have a fallback function to revert any payments. Since its a treasury contract, it should not accept any payments nor it should allow any withdrawal.</p>

<h3 id="core-logic-overview">Core Logic Overview</h3>

<p>To enable treasury fund rebalancing, a Klaytn node should specify a deployed smart contract address and a target block number on the node configuration like hardfork items. At the configured block number, a Klaytn node reads registered information from the smart contract and executes treasury fund rebalancing.</p>

<h4 id="chain-configuration">Chain Configuration</h4>

<p>ChainConfig introduces the following fields for treasury fund rebalancing. The configurations are used to trigger rebalancing and find the contract storing rebalancing information. All nodes in the network should update <code class="language-plaintext highlighter-rouge">genesis.json</code> configuration with the same value as if updating a hardfork block number. The configuration values for Baobab and Cypress networks can be hard coded on the client source code.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">kip103CompatibleBlock</code>: Treasury fund rebalance executing block which is the same as <code class="language-plaintext highlighter-rouge">rebalanceBlockNumber</code> of the smart contract</li>
  <li><code class="language-plaintext highlighter-rouge">kip103ContractAddress</code>: The address of the treasury fund rebalancing contract</li>
</ul>

<h4 id="validation">Validation</h4>

<p>Before executing rebalancing, registered values on the smart contract are validated to confirm whether the owners of the retired account agree on the rebalancing and whether the rebalancing doesn’t cause inflation of KLAY. The following should be confirmed before the execution.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Kip103CompatibleBlock</code> == <code class="language-plaintext highlighter-rouge">contract.rebalanceBlockNumber</code>: Ensure the owner of the retired accounts agree on this timing</li>
  <li><code class="language-plaintext highlighter-rouge">contract.status</code> == <code class="language-plaintext highlighter-rouge">Approved</code>: Confirm the status of the contract is ready to rebalance</li>
  <li><code class="language-plaintext highlighter-rouge">contract.checkRetiredsApproved()</code>: Double-check the agreement of the retired accounts’ owners at the execution time since the ownership is replaceable</li>
  <li><code class="language-plaintext highlighter-rouge">totalRetiredAmount &gt;= totalNewbieAmount</code>: Ensure the rebalancing doesn’t issue any KLAY</li>
</ul>

<h4 id="execution">Execution</h4>

<p>The rebalancing is executed at the end of the block processing process. In other words, it is executed after processing all transactions of the block and distributing block rewards. If a retired account is one of the receiver of the block reward, the amount also will be used for rebalancing. All KLAY in newbies account before rebalancing will be burnt as well. After rebalancing, the remaining KLAY of retired accounts will be burnt. Below is the new fund allocation logic including burn.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for addr := range Retireds {
	state.SetBalance(addr, 0)
}

for addr, balance := Newbie {
	// if newbie has KLAY before the allocation, it will be burnt
	currentBalance := state.GetBalance(addr)
	Burnt = Burnt + currentBalance

	state.SetBalance(addr, balance)
}
</code></pre></div></div>

<h4 id="result">Result</h4>

<p>The execution result of treasury fund rebalancing will be printed as an INFO-level log on each node. The owner of the treasury rebalancing contract is supposed to update the log on the smart contract as <code class="language-plaintext highlighter-rouge">memo</code> finalizing the status of the contract. Anyone can read and verify the rebalancing result by interacting with the smart contract. The data type of <code class="language-plaintext highlighter-rouge">memo</code> is byte array containing marshaled json data. Refer to the following format and example if you want to parse it.</p>

<p><strong>Format</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  {
    "retirees": [ { "retired": "0xRetiredAddress1", "balance": [removed balance in Peb] }, { "retired": "0xRetiredAddress2", "balance": removed balance in Peb], ... } ],
    "newbies": [ { "newbie": "0xNewbieAddress1", "fundAllocated": [new allocated balance in Peb] }, { "newbie": "0xNewbieAddress2", "fundAllocated": [new allocated balance in Peb], ... } ],
    "burnt": [burnt amount in Peb],
    "success": [true/false]
}
</code></pre></div></div>

<p>Note: 10^18 <a href="https://docs.klaytn.foundation/content/klaytn/design/klaytn-native-coin-klay">Peb</a> is equal to 1 KLAY</p>

<p><strong>Example</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>memo="{
  "retirees":[
    {"retired":"0xafd197d383453b08b7c1509bdb4b6afee9f66578","balance":5000000001892521406055074536},
    {"retired":"0x5678300abc1f599d865c3525df851b3902c88266","balance":2280917577134567890000000000},
    {"retired":"0x278e6332d69eed782784d21802e3504a64a16456","balance":352628334320754365571158456},
    {"retired":"0x3d803a7375a8ee5996f52a8d6725637a89f5bbf8","balance":112778356560412760866604672}
  ],
  "newbies":[
    {"newbie":"0x4f04251064274252d27d4af55bc85b68b3add992","fundAllocated":2000000000000000000000000000},
    {"newbie":"0x85d82d811743b4b8f3c48f3e48a1664d1ffc2c10","fundAllocated":180000000000000000000000000},
    {"newbie":"0xdd4c8d805fc110369d3b148a6692f283ffbdccd3","fundAllocated":270000000000000000000000000}
  ],
  "burnt":5296324269908256422492837664,
  "success":true
}
</code></pre></div></div>

<h2 id="rationale">Rationale</h2>

<!--The rationale fleshes out the specification by describing what motivated the design and why particular design decisions were made. It should describe alternate designs that were considered and related work, e.g. how the feature is supported in other languages. The rationale may also provide evidence of consensus within the community, and should discuss important objections or concerns raised during discussion.-->

<p>The smart contract is mainly for recording the details, and the Core will execute the fund re-distributions.</p>

<h3 id="design-decision">Design decision</h3>

<h4 id="klay-transfer-is-not-allowed-via-smart-contracts">KLAY transfer is not allowed via smart contracts</h4>

<p>As the balance of treasury funds keeps increasing for every block with the block reward its hard to keep track of the balances and rebalance token allocation. So smart contract will only record the rebalanced allocation and the core will execute the allocation by reading from the contract.</p>

<h4 id="approval-of-retiredaddress">Approval of retiredAddress</h4>

<p>To record the addresses in a verifiable manner, the addresses are verified in the contract by calling approve method. The retiredAddress can either be a Contract Account (CA) or an Externally Owned Account(EOA).</p>

<ul>
  <li>In case of an EOA, verification occurs when the account holder directly calls the approve function. <code class="language-plaintext highlighter-rouge">msg.sender == retiredAddress</code></li>
  <li>In case of a Contract, verification occurs when the admin of the contract calls approve function. The smart contract calls the <code class="language-plaintext highlighter-rouge">getState()</code> function implemented in the retiredAddress contract to get the admin details. <code class="language-plaintext highlighter-rouge">msg.sender == admin</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">getState()</code> funtion is implemented in Klaytn treasury contracts. It returns the adminList and quorom (min required admins to approve).</li>
      <li>Condition: Min required admins should approve the retiredAddress contract.</li>
    </ul>
  </li>
</ul>

<h4 id="no-withdrawal">No Withdrawal</h4>

<p>Smart contract is not allowed to receive KLAY due to security reasons. So any transaction sending KLAY to the contract will be reverted and withdraw function is not implemented.</p>

<h4 id="finalize-contract">Finalize Contract</h4>

<p>Once the re-distribution a.k.a rebalance is executed by the Core, the status of the smart contract will be finalized by adding a memo. Any modifications to the storage data will be restricted after finalization.</p>

<p>Once Finalized anyone can read and verify the rebalancing result by querying the memo in the smart contract.</p>

<p>Query Result:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">memo</span><span class="o">=</span> <span class="dl">"</span><span class="s2">{
  </span><span class="dl">"</span><span class="nx">retirees</span><span class="dl">"</span><span class="s2">: [{</span><span class="dl">"</span><span class="nx">retired</span><span class="dl">"</span><span class="s2">: </span><span class="dl">"</span><span class="mi">0</span><span class="nx">xRetiredAddress1</span><span class="dl">"</span><span class="s2">, </span><span class="dl">"</span><span class="nx">balance</span><span class="dl">"</span><span class="s2">: </span><span class="dl">"</span><span class="mh">0xa</span><span class="nx">mount</span><span class="dl">"</span><span class="s2">}, {</span><span class="dl">"</span><span class="nx">retired</span><span class="dl">"</span><span class="s2">: </span><span class="dl">"</span><span class="mi">0</span><span class="nx">xRetiredAddress2</span><span class="dl">"</span><span class="s2">, </span><span class="dl">"</span><span class="nx">balance</span><span class="dl">"</span><span class="s2">: </span><span class="dl">"</span><span class="mh">0xa</span><span class="nx">mount</span><span class="dl">"</span><span class="s2">}, ...],
  </span><span class="dl">"</span><span class="nx">newbies</span><span class="dl">"</span><span class="s2">: [{</span><span class="dl">"</span><span class="nx">newbie</span><span class="dl">"</span><span class="s2">: </span><span class="dl">"</span><span class="mi">0</span><span class="nx">xNewbieAddress1</span><span class="dl">"</span><span class="s2">, </span><span class="dl">"</span><span class="nx">fundAllocated</span><span class="dl">"</span><span class="s2">: </span><span class="dl">"</span><span class="mh">0xa</span><span class="nx">mount</span><span class="dl">"</span><span class="s2">}, {</span><span class="dl">"</span><span class="nx">newbie</span><span class="dl">"</span><span class="s2">: </span><span class="dl">"</span><span class="mi">0</span><span class="nx">xNewbieAddress2</span><span class="dl">"</span><span class="s2">,</span><span class="dl">"</span><span class="nx">fundAllocated</span><span class="dl">"</span><span class="s2">: </span><span class="dl">"</span><span class="mh">0xa</span><span class="nx">mount</span><span class="dl">"</span><span class="s2">}, ...],
  </span><span class="dl">"</span><span class="nx">burnt</span><span class="dl">"</span><span class="s2">: </span><span class="dl">"</span><span class="mh">0xa</span><span class="nx">mount</span><span class="dl">"</span><span class="s2">,
  </span><span class="dl">"</span><span class="nx">success</span><span class="dl">"</span><span class="s2">: true
}</span><span class="dl">"</span>
</code></pre></div></div>

<h2 id="backwards-compatibility">Backwards Compatibility</h2>

<!-- All KIPs that introduce backwards incompatibilities must include a section describing these incompatibilities and their severity. The KIP must explain how the author proposes to deal with these incompatibilities. KIP submissions without a sufficient backwards compatibility treatise may be rejected outright. The authors should answer the question: "Does this KIP require a hard fork?" -->

<ul>
  <li>The foundation should deploy new TreasuryRebalance contract to record the token redistribution.</li>
  <li>To rebalance the funds and redistribute in a consistent manner the foundation should burn the designated funds before re-distribution.</li>
  <li>This does not affect the backward compatibility as this a newly dpeloyed contract</li>
</ul>

<h2 id="implementation">Implementation</h2>

<!--The implementations must be completed before any KIP is given status "Final", but it need not be completed before the KIP is accepted. While there is merit to the approach of reaching consensus on the specification and rationale before writing code, the principle of "rough consensus and running code" is still useful when it comes to resolving many discussions of API details.-->

<h4 id="example-implementation">Example implementation</h4>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pragma</span> <span class="n">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="cm">/**
 * @dev External interface of TreasuryRebalance
 */</span>
<span class="k">interface</span> <span class="n">ITreasuryRebalance</span> <span class="p">{</span>
    <span class="cm">/**
     * @dev Emitted when the contract is deployed
     * `rebalanceBlockNumber` is the target block number of the execution the rebalance in Core
     * `deployedBlockNumber` is the current block number when its deployed
     */</span>
    <span class="k">event</span> <span class="n">ContractDeployed</span><span class="p">(</span>
        <span class="n">Status</span> <span class="n">status</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">rebalanceBlockNumber</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">deployedBlockNumber</span>
    <span class="p">);</span>

    <span class="cm">/**
     * @dev Emitted when a Retired is registered
     */</span>
    <span class="k">event</span> <span class="n">RetiredRegistered</span><span class="p">(</span><span class="kt">address</span> <span class="n">retired</span><span class="p">);</span>

    <span class="cm">/**
     * @dev Emitted when a Retired is removed
     */</span>
    <span class="k">event</span> <span class="n">RetiredRemoved</span><span class="p">(</span><span class="kt">address</span> <span class="n">retired</span><span class="p">);</span>

    <span class="cm">/**
     * @dev Emitted when a Newbie is registered
     */</span>
    <span class="k">event</span> <span class="n">NewbieRegistered</span><span class="p">(</span><span class="kt">address</span> <span class="n">newbie</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">fundAllocation</span><span class="p">);</span>

    <span class="cm">/**
     * @dev Emitted when a Newbie is removed
     */</span>
    <span class="k">event</span> <span class="n">NewbieRemoved</span><span class="p">(</span><span class="kt">address</span> <span class="n">newbie</span><span class="p">);</span>

    <span class="cm">/**
     * @dev Emitted when a admin approves the retired address.
     */</span>
    <span class="k">event</span> <span class="n">Approved</span><span class="p">(</span><span class="kt">address</span> <span class="n">retired</span><span class="p">,</span> <span class="kt">address</span> <span class="n">approver</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">approversCount</span><span class="p">);</span>

    <span class="cm">/**
     * @dev Emitted when the contract status changes
     */</span>
    <span class="k">event</span> <span class="n">StatusChanged</span><span class="p">(</span><span class="n">Status</span> <span class="n">status</span><span class="p">);</span>

    <span class="cm">/**
     * @dev Emitted when the contract is finalized
     * memo - is the result of the treasury fund rebalancing
     */</span>
    <span class="k">event</span> <span class="n">Finalized</span><span class="p">(</span><span class="kt">string</span> <span class="n">memo</span><span class="p">,</span> <span class="n">Status</span> <span class="n">status</span><span class="p">);</span>

    <span class="c1">// Status of the contract
</span>    <span class="k">enum</span> <span class="n">Status</span> <span class="p">{</span>
        <span class="n">Initialized</span><span class="p">,</span>
        <span class="n">Registered</span><span class="p">,</span>
        <span class="n">Approved</span><span class="p">,</span>
        <span class="n">Finalized</span>
    <span class="p">}</span>

    <span class="cm">/**
     * Retired struct to store retired address and their approver addresses
     */</span>
    <span class="k">struct</span> <span class="n">Retired</span> <span class="p">{</span>
        <span class="kt">address</span> <span class="n">retired</span><span class="p">;</span>
        <span class="kt">address</span><span class="p">[]</span> <span class="n">approvers</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**
     * Newbie struct to newbie receiver address and their fund allocation
     */</span>
    <span class="k">struct</span> <span class="n">Newbie</span> <span class="p">{</span>
        <span class="kt">address</span> <span class="n">newbie</span><span class="p">;</span>
        <span class="kt">uint256</span> <span class="n">amount</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// State variables
</span>    <span class="k">function</span> <span class="n">status</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="n">Status</span><span class="p">);</span> <span class="c1">// current status of the contract
</span>
    <span class="k">function</span> <span class="n">rebalanceBlockNumber</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">);</span> <span class="c1">// the target block number of the execution of rebalancing
</span>
    <span class="k">function</span> <span class="n">memo</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">string</span> <span class="k">memory</span><span class="p">);</span> <span class="c1">// result of the treasury fund rebalance
</span>
    <span class="cm">/**
     * @dev to get retired details by retiredAddress
     */</span>
    <span class="k">function</span> <span class="n">getRetired</span><span class="p">(</span>
        <span class="kt">address</span> <span class="n">retiredAddress</span>
    <span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span><span class="p">,</span> <span class="kt">address</span><span class="p">[]</span> <span class="k">memory</span><span class="p">);</span>

    <span class="cm">/**
     * @dev to get newbie details by newbieAddress
     */</span>
    <span class="k">function</span> <span class="n">getNewbie</span><span class="p">(</span>
        <span class="kt">address</span> <span class="n">newbieAddress</span>
    <span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span><span class="p">,</span> <span class="kt">uint256</span><span class="p">);</span>

    <span class="cm">/**
     * @dev returns the sum of retirees balances
     */</span>
    <span class="k">function</span> <span class="n">sumOfRetiredBalance</span><span class="p">()</span>
        <span class="k">external</span>
        <span class="k">view</span>
        <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">retireesBalance</span><span class="p">);</span>

    <span class="cm">/**
     * @dev returns the sum of newbie funds
     */</span>
    <span class="k">function</span> <span class="n">getTreasuryAmount</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">treasuryAmount</span><span class="p">);</span>

    <span class="cm">/**
     * @dev returns the length of retirees list
     */</span>
    <span class="k">function</span> <span class="n">getRetiredCount</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">);</span>

    <span class="cm">/**
     * @dev returns the length of newbies list
     */</span>
    <span class="k">function</span> <span class="n">getNewbieCount</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">);</span>

    <span class="cm">/**
     * @dev verify all retirees are approved by admin
     */</span>
    <span class="k">function</span> <span class="n">checkRetiredsApproved</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span><span class="p">;</span>

    <span class="c1">// State changing functions
</span>    <span class="cm">/**
     * @dev registers retired details
     * Can only be called by the current owner at Initialized state
     */</span>
    <span class="k">function</span> <span class="n">registerRetired</span><span class="p">(</span><span class="kt">address</span> <span class="n">retiredAddress</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="cm">/**
     * @dev remove the retired details from the array
     * Can only be called by the current owner at Initialized state
     */</span>
    <span class="k">function</span> <span class="n">removeRetired</span><span class="p">(</span><span class="kt">address</span> <span class="n">retiredAddress</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="cm">/**
     * @dev registers newbie address and its fund distribution
     * Can only be called by the current owner at Initialized state
     */</span>
    <span class="k">function</span> <span class="n">registerNewbie</span><span class="p">(</span><span class="kt">address</span> <span class="n">newbieAddress</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amount</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="cm">/**
     * @dev remove the newbie details from the array
     * Can only be called by the current owner at Initialized state
     */</span>
    <span class="k">function</span> <span class="n">removeNewbie</span><span class="p">(</span><span class="kt">address</span> <span class="n">newbieAddress</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="cm">/**
     * @dev approves a retiredAddress,the address can be a EOA or a contract address.
     *  - If the retiredAddress is a EOA, the caller should be the EOA address
     *  - If the retiredAddress is a Contract, the caller should be one of the contract `admin`
     */</span>
    <span class="k">function</span> <span class="n">approve</span><span class="p">(</span><span class="kt">address</span> <span class="n">retiredAddress</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="cm">/**
     * @dev sets the status to Registered,
     *      After this stage, registrations will be restricted.
     * Can only be called by the current owner at Initialized state
     */</span>
    <span class="k">function</span> <span class="n">finalizeRegistration</span><span class="p">()</span> <span class="k">external</span><span class="p">;</span>

    <span class="cm">/**
     * @dev sets the status to Approved,
     * Can only be called by the current owner at Registered state
     */</span>
    <span class="k">function</span> <span class="n">finalizeApproval</span><span class="p">()</span> <span class="k">external</span><span class="p">;</span>

    <span class="cm">/**
     * @dev sets the status of the contract to Finalize. Once finalized the storage data
     * of the contract cannot be modified
     * Can only be called by the current owner at Approved state after the execution of rebalance in the core
     *  - memo format: { "retirees": [ { "retired": "0xaddr", "balance": 0xamount },
     *                 { "retired": "0xaddr", "balance": 0xamount }, ... ],
     *                 "newbies": [ { "newbie": "0xaddr", "fundAllocated": 0xamount },
     *                 { "newbie": "0xaddr", "fundAllocated": 0xamount }, ... ],
     *                 "burnt": 0xamount, "success": true/false }
     */</span>
    <span class="k">function</span> <span class="n">finalizeContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">memo</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="cm">/**
     * @dev resets all storage values to empty objects except targetBlockNumber
     */</span>
    <span class="k">function</span> <span class="n">reset</span><span class="p">()</span> <span class="k">external</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Reference Implementation : https://github.com/klaytn/treasury-rebalance/tree/main/contracts</p>

<h2 id="test-cases">Test Cases</h2>

<!--Test cases for an implementation are mandatory for KIPs that are affecting consensus changes. Other KIPs can choose to include links to test cases if applicable.-->

<p>You can find test cases for this KIP, please refer to <a href="https://github.com/klaytn/treasury-rebalance/blob/main/test/TreasuryRebalance.js">this link</a>.</p>

<h2 id="reference">Reference</h2>

<p>n/a</p>

<h2 id="copyright">Copyright</h2>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.2.3/mermaid.min.js" integrity="sha512-M4zmdILgXOwrBEVfpVqdO/jC3BJZQzlXHeu967v41/QoT60sESWSLbi7YwntTbYC0ZjewfTbvXO8iKj7amvQow==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  mermaid.initialize({
    startOnLoad: true,
  });
  mermaid.run({
    querySelector: '.language-mermaid', // markdown 'mermaid' language code blocks
  });
</script>


</div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Kaia Improvement Proposals</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Kaia Improvement Proposals</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/kaiachain/KIPs"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">kaiachain/KIPs</span></a></li><li><a href="https://twitter.com/kaiachain"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">kaiachain</span></a></li><li><a href="https://www.facebook.com/kaiachain"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#facebook"></use></svg> <span class="username">kaiachain</span></a></li><li><a href="https://medium.com/kaiachain"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#medium"></use></svg> <span class="username">kaiachain</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Kaia Improvement Proposals (KIPs) describe standards for the Kaia platform, including core protocol specifications, client APIs, and contract standards.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

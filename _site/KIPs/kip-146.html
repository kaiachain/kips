<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
    <title>KIP 146: Unpredictable Proposer Selection</title>
    <meta property="og:title" content="KIP 146: Unpredictable Proposer Selection" />
    <meta
      name="description"
      content="Details on Kaia Improvement Proposal 146 (KIP 146): Unpredictable Proposer Selection"
    />
    <meta
      property="og:description"
      content="Details on Kaia Improvement Proposal 146 (KIP 146): Unpredictable Proposer Selection"
    />
    <meta name="twitter:description" content="Details on Kaia Improvement Proposal 146 (KIP 146): Unpredictable Proposer Selection" />
  
  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="http://localhost:4000/KIPs/kip-146" />
  <meta property="og:url" content="http://localhost:4000/KIPs/kip-146" />
  <meta property="og:site_name" content="Kaia Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@kaiachain" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "http://localhost:4000",
      "name": "Kaia Improvement Proposals",
      "description": "Kaia Improvement Proposals (KIPs) describe standards for the Kaia platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Kaia Improvement Proposals" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Kaia Improvement Proposals</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/all">All</a><a class="page-link" href="/core">Core</a><a class="page-link" href="/networking">Networking</a><a class="page-link" href="/storage">Storage</a><a class="page-link" href="/interface">Interface</a><a class="page-link" href="/token">KCT</a><a class="page-link" href="/sdk">SDK</a><a class="page-link" href="/application">Application</a><a class="page-link" href="/meta">Meta</a><a class="page-link" href="/informational">Informational</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="home">
  <h1 class="page-heading">
    KIP 146: Unpredictable Proposer Selection
    <a href="https://github.com/kaiachain/KIPS/blob/main/KIPs/kip-146.md"><svg role="img" aria-label="Source" xmlns="https://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><title>Source</title><path fill-rule="evenodd" d="M9.5 3L8 4.5 11.5 8 8 11.5 9.5 13 14 8 9.5 3zm-5 0L0 8l4.5 5L6 11.5 2.5 8 6 4.5 4.5 3z"/></svg></a>
  </h1>
  <table>
    <tr><th>Author</th><td><a href="https://github.com/ian0371">Ian</a>, <a href="https://github.com/blukat29">Ollie</a>, <a href="https://github.com/jiseongnoh">Joseph</a>, <a href="https://github.com/aidan-kwon">and Aidan</a></td></tr>
    
      <tr><th>Discussions-To</th><td><a href="https://github.com/klaytn/kips/issues/146">https://github.com/klaytn/kips/issues/146</a></td></tr>
    
    <tr><th>Status</th><td>Draft
    
    </td></tr>
    <tr><th>Type</th><td>Standards Track</td></tr>
    
      <tr><th>Category</th><td>Core</td></tr>
    
    <tr><th>Created</th><td>2023-06-15</td></tr>
    
    
    
    
    
  </table>

  <h2 id="simple-summary">Simple Summary</h2>

<p>An unpredictable and verifiable proposer selection policy</p>

<h2 id="abstract">Abstract</h2>

<p>This standard outlines an approach for an unpredictable proposer selection policy. A proposer is determined every block in a random manner. The randomness relies on <a href="https://github.com/klaytn/kips/blob/main/KIPs/kip-114.md">KIP-114</a>, thereby rendering the new policy both unpredictable and verifiable.</p>

<h2 id="motivation">Motivation</h2>

<p>Klaytn has adopted the Byzantine Fault Tolerance (BFT) consensus mechanism, where a block proposer selected by a deterministic algorithm proposes the next block. A vulnerable point of BFT is that an adversary can effectively halt the entire network by simply targeting the proposer, a.k.a. targeted DoS. What makes Klaytn even more vulnerable to a targeted DoS attack is that the current proposer selection policy enables the prediction of up to <code class="language-plaintext highlighter-rouge">proposerUpdateInterval</code> (3600 in case of Cypress) number of proposers in advance.</p>

<p>As of now, a targeted DoS is practically infeasible in Klaytn because it is a permissioned chain which allows only authorized validators to join the network. However, in a permissionless network, a targeted DoS is a viable option for attackers. A random proposer selection can increase the difficulty of the attack by introducing an uncertainty of the upcoming proposers.</p>

<p>Meanwhile, a few malicious validators must not be able to forge the randomness to arbitrarily determine the upcoming proposers. If not, it may increase the risk of censorship or monopolizing block rewards. Therefore, the new random proposer selection policy should be both unpredictable and verifiable.</p>

<h2 id="specification">Specification</h2>

<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL” in this document are to be interpreted as described in RFC 2119.</p>

<h3 id="parameters">Parameters</h3>

<table>
  <thead>
    <tr>
      <th>Constant</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">FORK_BLOCK</code></td>
      <td>TBD</td>
    </tr>
  </tbody>
</table>

<h3 id="shuffling">Shuffling</h3>

<p>A shuffling algorithm must be defined which will act as a building block of proposer and committee selection.</p>

<p><a href="https://en.wikipedia.org/wiki/Fisher%E2%80%93Yates_shuffle">Fisher-Yates shuffle</a> must be used in the below pseudocode (i.e., <code class="language-plaintext highlighter-rouge">random.shuffle</code>), and <a href="https://cs.opensource.google/go/go/+/master:src/math/rand/rng.go;l=7-12">Golang’s RNG</a> must be used as a pseudo random number generator internally in Fisher-Yates.</p>

<p>The shuffling function must be deterministic given <code class="language-plaintext highlighter-rouge">validators</code> and <code class="language-plaintext highlighter-rouge">seed</code>.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">shuffle_validators_KIP146</span><span class="p">(</span><span class="n">validators</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="s">"""returns a list of randomly shuffled validators.
    Keyword arguments:
    validators -- deterministically sorted list of validators.
    seed -- `mixHash[0:8]` interpreted as the bytes of a big-endian signed 64-bit integer. The `mixHash` of the previous block is used (see KIP-114).
    """</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">validators</span><span class="p">[:]</span>

    <span class="n">random</span><span class="p">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></div>

<h3 id="proposer-selection">Proposer selection</h3>

<p>For calculating the proposer of <code class="language-plaintext highlighter-rouge">FORK_BLOCK</code> and afterward, the new logic must be used.
This only affects the chain whose proposer selection policy is set to <code class="language-plaintext highlighter-rouge">WeightedRandom</code>.</p>

<p>Below algorithm ensures that</p>

<ul>
  <li>The proposer must be randomly selected each block.</li>
  <li>The proposer must change in case of round change.</li>
  <li>The proposer must be selected from committee.</li>
</ul>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">proposer_selector</span><span class="p">(</span><span class="n">validators</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">committee_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">round</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="s">"""returns a proposer from validators.

    Keyword arguments:
    validators -- deterministically sorted list of validators.
    committee_size -- the value of `istanbul.sub` in ChainConfig.
    round -- the target consensus round.
    seed -- `mixHash[0:8]` interpreted as the bytes of a big-endian signed 64-bit integer. The `mixHash` of the previous block is used (see KIP-114).
    """</span>
    <span class="k">return</span> <span class="n">select_committee_KIP146</span><span class="p">(</span><span class="n">validators</span><span class="p">,</span> <span class="n">committee_size</span><span class="p">,</span> <span class="n">seed</span><span class="p">)[</span><span class="nb">round</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">validators</span><span class="p">)]</span>
</code></pre></div></div>

<h3 id="committee-selection">Committee selection</h3>

<p>For calculating the committee of <code class="language-plaintext highlighter-rouge">FORK_BLOCK</code> and afterward, the new logic must be used.
This only affects the chain whose proposer selection policy is set to <code class="language-plaintext highlighter-rouge">WeightedRandom</code>.</p>

<p>This design guarantees that the given proposer address is always in the committee.</p>

<p>Below algorithm ensures that</p>

<ul>
  <li>The committee must be randomly selected each block.</li>
  <li>The committee must <em>not</em> change in case of round change.</li>
  <li>The next round proposer must be in the committee.</li>
</ul>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">select_committee_KIP146</span><span class="p">(</span><span class="n">validators</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">committee_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="s">"""returns a committee from validators.

    Keyword arguments:
    validators -- deterministically sorted list of validators.
    committee_size -- the value of `istanbul.sub` in ChainConfig.
    seed -- `mixHash[0:8]` interpreted as the bytes of a big-endian signed 64-bit integer. The `mixHash` of the previous block is used (see KIP-114).
    """</span>
    <span class="n">shuffled</span> <span class="o">=</span> <span class="n">shuffle_validators_KIP146</span><span class="p">(</span><span class="n">validators</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shuffled</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="n">committee_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">validators</span><span class="p">))]</span>
</code></pre></div></div>

<h2 id="rationale">Rationale</h2>

<h3 id="using-part-of-mixhash-as-a-seed">Using part of <code class="language-plaintext highlighter-rouge">mixHash</code> as a seed</h3>

<p>As defined in <a href="https://github.com/klaytn/kips/blob/main/KIPs/kip-114.md">KIP-114</a>, <code class="language-plaintext highlighter-rouge">mixHash</code> is the result of XOR operation with a keccak256 hash.
To the best of our knowledge, truncating the cryptographic hash is safe to be used for the seed of pseudo random number generator.
Ethereum also uses the first eight bytes of a hash: <a href="https://github.com/ethereum/consensus-specs/blob/dev/specs/phase0/beacon-chain.md#compute_shuffled_index">link</a>.</p>

<h3 id="committee-remaining-the-same-in-case-of-round-change">Committee remaining the same in case of round change</h3>

<p>Unlike the previous semantic of <code class="language-plaintext highlighter-rouge">WeightedRandom</code> proposer selection policy, this proposal suggests a policy where the members of the committee remains the same in case of round change.
This new policy addresses a potential security issue where a fork could happen even within the number of Byzantine nodes permitted by Istanbul Byzantine Fault Tolerance mechanism (i.e., one third of validators).</p>

<h3 id="side-effect">Side effect</h3>

<h4 id="differentiation-of-next-round-proposer-and-next-block-proposer">Differentiation of next round proposer and next block proposer</h4>

<p>The current algorithm for composing a committee makes sure that the proposer and the next round proposer is included in the committee. Before <code class="language-plaintext highlighter-rouge">FORK_BLOCK</code>, the next round proposer is equal to the next block proposer, and thus the next block proposer always ended up in the committee. However, after <code class="language-plaintext highlighter-rouge">FORK_BLOCK</code>, the next round proposer can be different from the next block proposer, which may result in the next block proposer not being included from the committee. This side effect does not degrade the network security; while the next proposer being in the committee could potentially be helpful to next block generation, its significance is negligible, if any.</p>

<h4 id="affecting-the-predictability-of-mixhash">Affecting the predictability of <code class="language-plaintext highlighter-rouge">mixHash</code></h4>

<p>Allowing a certain validator to be selected as the proposer for consecutive blocks affects the predictability of <code class="language-plaintext highlighter-rouge">mixHash</code> in KIP-114. See <a href="https://github.com/klaytn/kips/blob/main/KIPs/kip-114.md#predictability">here</a> for further details.</p>

<h2 id="backwards-compatibility">Backwards Compatibility</h2>

<p>The proposer selection policy before <code class="language-plaintext highlighter-rouge">FORK_BLOCK</code> remains the same.</p>

<h2 id="security-considerations">Security Considerations</h2>

<h3 id="biasability">Biasability</h3>

<p>The biasability of this proposal relies on that of KIP-114, the shuffling algorithm, and the pseudo random number generator.</p>

<ul>
  <li>KIP-114 is unbiased because keccak256 hash is.</li>
  <li>The shuffling algorithm Fisher-Yates is unbiased as long as the pseudo random number generator is.</li>
  <li>To the best of our knowledge, the Golang’s pseudo random number generator is unbiased; it uses <a href="https://en.wikipedia.org/wiki/Lagged_Fibonacci_generator">Additive Lagged Fibonacci Generator</a> where initial values are generated by a <a href="https://en.wikipedia.org/wiki/Linear_congruential_generator">Linear Congruential Generator</a> based on the user seed.</li>
</ul>

<h3 id="predictability">Predictability</h3>

<p>The probability of predicting a proposer at a certain block is the maximum of the followings:</p>

<ul>
  <li>Predictability of <code class="language-plaintext highlighter-rouge">mixHash</code> as specified <a href="https://github.com/klaytn/kips/blob/main/KIPs/kip-114.md#predictability">here</a>.</li>
  <li>Randomly picking one out of validators.</li>
</ul>

<p>It implies that the probability has a lower bound of <code class="language-plaintext highlighter-rouge">1/N</code>, where <code class="language-plaintext highlighter-rouge">N</code> is the number of validators.</p>

<h2 id="implementation">Implementation</h2>

<p>A reference implementation in Golang: <a href="https://github.com/ian0371/klaytn/tree/fork/proposer-selection-3">link</a>.</p>

<p>Note that Golang’s standard package <a href="https://cs.opensource.google/go/go/+/master:src/math/rand/rand.go;l=252">rand.shuffle</a> implements Fisher-Yates.</p>

<h2 id="references">References</h2>

<ul>
  <li><a href="https://github.com/ethereum/consensus-specs/blob/dev/specs/phase0/beacon-chain.md">Eth2 beacon chain docs</a></li>
  <li><a href="https://eth2book.info/capella/part2/building_blocks/shuffling/">Eth2 book</a></li>
  <li><a href="https://www.leviathansecurity.com/media/attacking-gos-lagged-fibonacci-generator">Attacking Go’s Lagged Fibonacci Generator</a></li>
  <li><a href="https://github.com/klaytn/kips/blob/main/KIPs/kip-114.md">KIP-114</a></li>
</ul>

<h2 id="copyright">Copyright</h2>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.2.3/mermaid.min.js" integrity="sha512-M4zmdILgXOwrBEVfpVqdO/jC3BJZQzlXHeu967v41/QoT60sESWSLbi7YwntTbYC0ZjewfTbvXO8iKj7amvQow==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  mermaid.initialize({
    startOnLoad: true,
  });
  mermaid.run({
    querySelector: '.language-mermaid', // markdown 'mermaid' language code blocks
  });
</script>


</div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Kaia Improvement Proposals</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Kaia Improvement Proposals</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/kaiachain/KIPs"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">kaiachain/KIPs</span></a></li><li><a href="https://twitter.com/kaiachain"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">kaiachain</span></a></li><li><a href="https://www.facebook.com/kaiachain"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#facebook"></use></svg> <span class="username">kaiachain</span></a></li><li><a href="https://medium.com/kaiachain"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#medium"></use></svg> <span class="username">kaiachain</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Kaia Improvement Proposals (KIPs) describe standards for the Kaia platform, including core protocol specifications, client APIs, and contract standards.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
